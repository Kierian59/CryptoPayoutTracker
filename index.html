<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Payout Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: rgba(255, 255, 255, 0.05);
            --bg-card-hover: rgba(255, 255, 255, 0.08);
            --text-primary: #e0e0e0;
            --text-secondary: #aaa;
            --accent: #00d9ff;
            --accent-green: #2ed573;
            --accent-red: #ff4757;
            --accent-orange: #ffa502;
            --border-color: rgba(255, 255, 255, 0.1);
            --sidebar-width: 260px;
            --sidebar-collapsed: 70px;
        }

        [data-theme="light"] {
            --bg-primary: #f0f2f5;
            --bg-secondary: #ffffff;
            --bg-card: rgba(0, 0, 0, 0.03);
            --bg-card-hover: rgba(0, 0, 0, 0.06);
            --text-primary: #1a1a2e;
            --text-secondary: #666;
            --border-color: rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        body.has-sidebar {
            padding-left: calc(var(--sidebar-width) + 20px);
        }

        body.sidebar-collapsed {
            padding-left: calc(var(--sidebar-collapsed) + 20px);
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: var(--sidebar-width);
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid var(--border-color);
            z-index: 1000;
            transition: width 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent), var(--accent-green));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
            flex-shrink: 0;
        }

        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent);
            white-space: nowrap;
            overflow: hidden;
            transition: opacity 0.3s;
        }

        .sidebar.collapsed .sidebar-title {
            opacity: 0;
            width: 0;
        }

        .sidebar-toggle {
            position: absolute;
            right: -12px;
            top: 28px;
            width: 24px;
            height: 24px;
            background: var(--accent);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-size: 12px;
            transition: transform 0.3s;
            z-index: 1001;
        }

        .sidebar.collapsed .sidebar-toggle {
            transform: rotate(180deg);
        }

        .sidebar-nav {
            flex: 1;
            padding: 20px 10px;
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-radius: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 5px;
            text-decoration: none;
        }

        .nav-item:hover {
            background: rgba(0, 217, 255, 0.1);
            color: var(--accent);
        }

        .nav-item.active {
            background: rgba(0, 217, 255, 0.2);
            color: var(--accent);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .nav-label {
            white-space: nowrap;
            overflow: hidden;
            transition: opacity 0.3s;
        }

        .sidebar.collapsed .nav-label {
            opacity: 0;
            width: 0;
        }

        .sidebar-footer {
            padding: 15px;
            border-top: 1px solid var(--border-color);
        }

        /* Avatar Badge */
        .avatar-badge {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #0099cc);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            color: #000;
            flex-shrink: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-details {
            overflow: hidden;
            transition: opacity 0.3s;
        }

        .sidebar.collapsed .user-details {
            opacity: 0;
            width: 0;
        }

        .user-name {
            font-size: 0.9rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-role {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            margin-top: 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .theme-switch {
            width: 44px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            position: relative;
            transition: background 0.3s;
        }

        .theme-switch::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: transform 0.3s;
        }

        [data-theme="light"] .theme-switch::after {
            transform: translateX(20px);
        }

        .theme-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            transition: opacity 0.3s;
        }

        .sidebar.collapsed .theme-label,
        .sidebar.collapsed .theme-switch {
            display: none;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-green));
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 217, 255, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: #000;
            transition: all 0.3s;
            z-index: 999;
        }

        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 30px rgba(0, 217, 255, 0.6);
        }

        .fab.active {
            transform: rotate(45deg);
            background: var(--accent-red);
        }

        /* Notification Bell */
        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .notification-bell:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .notification-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 18px;
            height: 18px;
            background: var(--accent-red);
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
        }

        /* Notification Panel */
        .notification-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-left: 1px solid var(--border-color);
            z-index: 1001;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .notification-panel.open {
            right: 0;
        }

        .notification-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h3 {
            color: var(--accent);
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 24px;
        }

        .notification-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .notification-item {
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 3px solid var(--accent);
        }

        .notification-item.milestone {
            border-left-color: var(--accent-green);
        }

        .notification-item.warning {
            border-left-color: var(--accent-orange);
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .notification-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .notification-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #00d9ff;
            font-size: 2rem;
        }

        /* Glassmorphism Cards */
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            animation: fadeInUp 0.5s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
            border-color: rgba(0, 217, 255, 0.2);
        }

        .card h2 {
            margin-bottom: 20px;
            color: var(--accent);
            font-size: 1.2rem;
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Quick Filter Chips */
        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .filter-chip {
            padding: 6px 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .filter-chip.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #000;
        }

        /* Trend Indicators */
        .trend-up {
            color: var(--accent-green);
        }

        .trend-down {
            color: var(--accent-red);
        }

        .trend-indicator {
            font-size: 0.85rem;
            margin-left: 8px;
        }

        /* Sparkline Container */
        .sparkline-container {
            height: 30px;
            margin-top: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .stat-box:hover .sparkline-container {
            opacity: 1;
        }

        /* Goal Progress */
        .goal-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .goal-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .goal-value {
            font-size: 0.9rem;
            color: var(--accent);
        }

        .goal-progress {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .goal-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-green));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Heat Map Calendar */
        .heatmap-container {
            overflow-x: auto;
            padding: 10px 0;
        }

        .heatmap {
            display: flex;
            gap: 3px;
        }

        .heatmap-week {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .heatmap-day {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.2s;
        }

        .heatmap-day:hover {
            transform: scale(1.3);
        }

        .heatmap-day.level-1 { background: rgba(0, 217, 255, 0.2); }
        .heatmap-day.level-2 { background: rgba(0, 217, 255, 0.4); }
        .heatmap-day.level-3 { background: rgba(0, 217, 255, 0.6); }
        .heatmap-day.level-4 { background: rgba(0, 217, 255, 0.8); }
        .heatmap-day.level-5 { background: var(--accent); }

        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Comparison Mode */
        .comparison-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .comparison-select {
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .comparison-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Onboarding Tour */
        .tour-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
        }

        .tour-overlay.active {
            display: block;
        }

        .tour-highlight {
            position: absolute;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            z-index: 2001;
        }

        .tour-tooltip {
            position: absolute;
            background: var(--bg-secondary);
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 20px;
            max-width: 320px;
            z-index: 2002;
            animation: fadeIn 0.3s ease;
        }

        .tour-tooltip h4 {
            color: var(--accent);
            margin-bottom: 10px;
        }

        .tour-tooltip p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .tour-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .tour-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tour-skip {
            background: none;
            border: none;
            color: var(--text-secondary);
        }

        .tour-next {
            background: var(--accent);
            border: none;
            color: #000;
        }

        .tour-dots {
            display: flex;
            gap: 6px;
            justify-content: center;
            margin-top: 15px;
        }

        .tour-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
        }

        .tour-dot.active {
            background: var(--accent);
        }

        /* Tab Navigation */
        .main-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 25px;
            background: rgba(0, 0, 0, 0.2);
            padding: 5px;
            border-radius: 12px;
        }

        .main-tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .main-tab:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .main-tab.active {
            background: var(--accent);
            color: #000;
            font-weight: 600;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        /* Dashboard Overview */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .dashboard-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .dashboard-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .dashboard-card-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .dashboard-card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
        }

        .dashboard-card-value.green {
            color: var(--accent-green);
        }

        .mini-chart {
            height: 60px;
            margin-top: 10px;
        }

        .recent-activity {
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: rgba(0, 217, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
        }

        .activity-details {
            flex: 1;
        }

        .activity-title {
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .activity-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .activity-amount {
            font-weight: 600;
            color: var(--accent-green);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 6px;
            font-size: 0.9rem;
            color: #aaa;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #00d9ff;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d9ff, #0099cc);
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 217, 255, 0.4);
        }

        .btn-danger {
            background: #ff4757;
            color: #fff;
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .btn-danger:hover {
            background: #ff6b7a;
        }

        .btn-edit {
            background: #ffa502;
            color: #000;
            padding: 6px 12px;
            font-size: 0.85rem;
            margin-right: 5px;
        }

        .btn-edit:hover {
            background: #ffb732;
        }

        .btn-export {
            background: #2ed573;
            color: #000;
            margin-left: 10px;
        }

        .btn-export:hover {
            background: #7bed9f;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .form-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(0, 217, 255, 0.1);
            color: #00d9ff;
            font-weight: 600;
            cursor: pointer;
        }

        th:hover {
            background: rgba(0, 217, 255, 0.2);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: rgba(0, 217, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .stat-box:hover {
            background: rgba(0, 217, 255, 0.15);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 217, 255, 0.2);
        }

        .stat-box .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .stat-box .value.usd {
            color: var(--accent-green);
        }

        .stat-box .label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .stat-box .trend {
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .stat-box .trend.up {
            background: rgba(46, 213, 115, 0.2);
            color: var(--accent-green);
        }

        .stat-box .trend.down {
            background: rgba(255, 71, 87, 0.2);
            color: var(--accent-red);
        }

        .currency-toggle-btn {
            background: rgba(0, 217, 255, 0.2);
            border: 1px solid rgba(0, 217, 255, 0.4);
            color: #00d9ff;
            border-radius: 4px;
            padding: 2px 8px;
            margin-left: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .currency-toggle-btn:hover {
            background: rgba(0, 217, 255, 0.4);
            transform: scale(1.05);
        }

        .eur-preview {
            font-size: 0.85rem;
            color: #2ed573;
            margin-top: 6px;
            min-height: 20px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .search-box {
            padding: 10px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            width: 250px;
        }

        .search-box:focus {
            outline: none;
            border-color: #00d9ff;
        }

        /* Month Tabs */
        .month-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .month-tab {
            padding: 8px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            background: transparent;
            color: #aaa;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .month-tab:hover {
            border-color: #00d9ff;
            color: #00d9ff;
        }

        .month-tab.active {
            background: #00d9ff;
            border-color: #00d9ff;
            color: #000;
            font-weight: 600;
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .chart-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 20px;
            position: relative;
            height: 320px;
        }

        .chart-container h3 {
            color: #00d9ff;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .chart-wrapper {
            position: relative;
            height: calc(100% - 30px);
        }

        .usd-value {
            color: #2ed573;
            font-weight: 500;
        }

        /* Monthly totals list */
        .monthly-totals-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            max-height: calc(100% - 30px);
        }

        .monthly-total-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border-left: 3px solid #2ed573;
        }

        .monthly-total-item.active {
            background: rgba(46, 213, 115, 0.15);
            border-left-color: #00d9ff;
        }

        .monthly-total-item .month-name {
            color: #e0e0e0;
            font-weight: 500;
        }

        .monthly-total-item .month-amount {
            color: #2ed573;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .monthly-total-display {
            height: auto;
            min-height: 200px;
            max-height: 320px;
        }

        /* Auth styles */
        .auth-container {
            max-width: 500px;
            margin: 80px auto;
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 50px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .auth-card h2 {
            text-align: center;
            color: #00d9ff;
            margin-bottom: 30px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .auth-tab.active {
            color: #00d9ff;
            border-bottom: 2px solid #00d9ff;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-form input {
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 1.1rem;
        }

        .auth-form input:focus {
            outline: none;
            border-color: #00d9ff;
        }

        .auth-form .btn {
            margin-top: 15px;
            padding: 16px 28px;
            font-size: 1.1rem;
        }

        .auth-error {
            color: #ff4757;
            font-size: 0.9rem;
            text-align: center;
            padding: 10px;
            background: rgba(255, 71, 87, 0.1);
            border-radius: 8px;
            display: none;
        }

        .auth-divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: #666;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
        }

        .auth-divider span {
            padding: 0 15px;
            font-size: 0.85rem;
        }

        .btn-google {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 16px 28px;
            background: #fff;
            color: #333;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-google:hover {
            background: #f1f1f1;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
        }

        .auth-success {
            color: #2ed573;
            font-size: 0.9rem;
            text-align: center;
            padding: 10px;
            background: rgba(46, 213, 115, 0.1);
            border-radius: 8px;
            display: none;
        }

        .user-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .user-email {
            color: #aaa;
            font-size: 0.9rem;
        }

        .btn-logout {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
            padding: 8px 16px;
            font-size: 0.85rem;
            border: 1px solid rgba(255, 71, 87, 0.3);
        }

        .btn-logout:hover {
            background: rgba(255, 71, 87, 0.3);
        }

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #aaa;
        }

        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(0, 217, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00d9ff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 900px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            body.has-sidebar {
                padding-left: 20px;
            }

            body.sidebar-collapsed {
                padding-left: 20px;
            }

            .mobile-menu-btn {
                display: flex !important;
            }
        }

        @media (max-width: 600px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .header-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                width: 100%;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 250px;
            }

            .auth-container {
                margin: 50px auto;
                padding: 0 15px;
            }

            .auth-card {
                padding: 25px;
            }

            .main-tabs {
                flex-direction: column;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .fab {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 24px;
            }

            .notification-panel {
                width: 100%;
            }
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            width: 44px;
            height: 44px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 999;
            color: var(--accent);
        }

        /* Draggable widgets */
        .draggable {
            cursor: move;
        }

        .draggable.dragging {
            opacity: 0.5;
        }

        .drag-over {
            border: 2px dashed var(--accent);
        }

        /* Modal for FAB form */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1500;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: fadeInUp 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: var(--accent);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
        }

        /* Category Badges */
        .category-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .category-badge.airdrop {
            background: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
        }

        .category-badge.paid-deal {
            background: rgba(46, 213, 115, 0.2);
            color: var(--accent-green);
        }

        .category-badge.staking {
            background: rgba(0, 217, 255, 0.2);
            color: var(--accent);
        }

        .category-badge.mining {
            background: rgba(255, 165, 2, 0.2);
            color: var(--accent-orange);
        }

        .category-badge.trading {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        .category-badge.other {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
        }

        /* Vesting Tracker Styles */
        .vesting-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .vesting-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .vesting-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .vesting-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .vesting-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .vesting-info h3 {
            color: var(--accent);
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .vesting-info p {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .vesting-actions {
            display: flex;
            gap: 8px;
        }

        .vesting-progress-section {
            margin-bottom: 15px;
        }

        .vesting-progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .vesting-progress-bar {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
        }

        .vesting-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-green));
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .vesting-schedule {
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }

        .vesting-schedule h4 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .unlock-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .unlock-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .unlock-item.unlocked {
            opacity: 0.6;
            text-decoration: line-through;
        }

        .unlock-item.upcoming {
            border-left: 3px solid var(--accent-green);
            background: rgba(46, 213, 115, 0.1);
        }

        .unlock-item.next {
            border-left: 3px solid var(--accent);
            background: rgba(0, 217, 255, 0.1);
        }

        .unlock-date {
            color: var(--text-secondary);
        }

        .unlock-amount {
            color: var(--accent-green);
            font-weight: 600;
        }

        .unlock-status {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .unlock-status.claimed {
            background: rgba(46, 213, 115, 0.2);
            color: var(--accent-green);
        }

        .unlock-status.pending {
            background: rgba(255, 165, 2, 0.2);
            color: var(--accent-orange);
        }

        .vesting-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .vesting-stat {
            background: rgba(0, 217, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .vesting-stat .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent);
        }

        .vesting-stat .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .add-unlock-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            padding: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        .add-unlock-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .unlock-input-row {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .unlock-input-row input {
            flex: 1;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .unlock-input-row input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .upcoming-unlocks {
            background: linear-gradient(135deg, rgba(0, 217, 255, 0.1), rgba(46, 213, 115, 0.1));
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .upcoming-unlocks h3 {
            color: var(--accent);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .countdown {
            font-size: 0.85rem;
            color: var(--accent-orange);
            margin-top: 5px;
        }

        /* Vesting Calendar Styles */
        .vesting-calendar {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-header h3 {
            color: var(--accent);
            font-size: 1.1rem;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .calendar-nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-nav-btn:hover {
            background: var(--accent);
            color: #000;
        }

        .calendar-month-year {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            min-width: 150px;
            text-align: center;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day-header {
            text-align: center;
            padding: 10px 5px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.02);
            cursor: default;
            transition: all 0.2s;
            position: relative;
            min-height: 50px;
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            border: 2px solid var(--accent);
            color: var(--accent);
            font-weight: 600;
        }

        .calendar-day.has-unlock {
            background: rgba(46, 213, 115, 0.2);
            color: var(--accent-green);
            cursor: pointer;
            font-weight: 600;
        }

        .calendar-day.has-unlock:hover {
            background: rgba(46, 213, 115, 0.3);
            transform: scale(1.05);
        }

        .calendar-day.has-unlock.past {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            opacity: 0.6;
        }

        .calendar-day.has-unlock.upcoming {
            background: rgba(0, 217, 255, 0.2);
            color: var(--accent);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0, 217, 255, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(0, 217, 255, 0); }
        }

        .calendar-day .unlock-dot {
            position: absolute;
            bottom: 4px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-green);
        }

        .calendar-day .unlock-count {
            font-size: 0.65rem;
            background: var(--accent-green);
            color: #000;
            padding: 1px 5px;
            border-radius: 8px;
            margin-top: 2px;
        }

        /* Calendar Tooltip */
        .calendar-tooltip {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            min-width: 250px;
            max-width: 320px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: none;
        }

        .calendar-tooltip.visible {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        .calendar-tooltip h4 {
            color: var(--accent);
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .calendar-tooltip-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .calendar-tooltip-item:last-child {
            border-bottom: none;
        }

        .calendar-tooltip-project {
            font-weight: 500;
            color: var(--text-primary);
        }

        .calendar-tooltip-amount {
            color: var(--accent-green);
            font-weight: 600;
        }

        .calendar-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .calendar-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .calendar-legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 4px;
        }

        .calendar-legend-dot.past {
            background: rgba(255, 255, 255, 0.1);
        }

        .calendar-legend-dot.upcoming {
            background: rgba(0, 217, 255, 0.3);
        }

        .calendar-legend-dot.today {
            border: 2px solid var(--accent);
        }
    </style>
</head>
<body>
    <!-- Auth Section -->
    <div id="auth-section" class="auth-container">
        <h1>CRYPTO PAYOUT TRACKER</h1>
        <p style="text-align: center; margin-top: -20px; margin-bottom: 25px; color: #aaa; font-size: 0.9rem;">Made by <a href="https://x.com/KierianV" target="_blank" style="color: #00d9ff; text-decoration: none;">Kierian</a></p>

        <div class="auth-card">
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login')">Login</button>
                <button class="auth-tab" onclick="showAuthTab('signup')">Sign Up</button>
            </div>

            <div id="auth-error" class="auth-error"></div>
            <div id="auth-success" class="auth-success"></div>

            <!-- Login Form -->
            <form id="login-form" class="auth-form" onsubmit="handleLogin(event)">
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>

            <div class="auth-divider">
                <span>or</span>
            </div>

            <button class="btn btn-google" onclick="handleGoogleLogin()">
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"/>
                    <path d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 009 18z" fill="#34A853"/>
                    <path d="M3.964 10.71A5.41 5.41 0 013.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 000 9c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/>
                    <path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 00.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" fill="#EA4335"/>
                </svg>
                Continue with Google
            </button>

            <!-- Signup Form -->
            <form id="signup-form" class="auth-form hidden" onsubmit="handleSignup(event)">
                <input type="email" id="signup-email" placeholder="Email" required>
                <input type="password" id="signup-password" placeholder="Password (min 6 characters)" required minlength="6">
                <input type="password" id="signup-confirm" placeholder="Confirm Password" required minlength="6">
                <button type="submit" class="btn btn-primary">Create Account</button>
            </form>
        </div>
    </div>

    <!-- Sidebar -->
    <nav class="sidebar hidden" id="sidebar">
        <button class="sidebar-toggle" onclick="toggleSidebar()">&#10094;</button>
        <div class="sidebar-header">
            <div class="sidebar-logo">CT</div>
            <span class="sidebar-title">Crypto Tracker</span>
        </div>
        <div class="sidebar-nav">
            <div class="nav-item active" data-tab="dashboard" onclick="switchMainTab('dashboard')">
                <span class="nav-icon">&#9783;</span>
                <span class="nav-label">Dashboard</span>
            </div>
            <div class="nav-item" data-tab="add-payout" onclick="switchMainTab('add-payout')">
                <span class="nav-icon">&#43;</span>
                <span class="nav-label">Add Payout</span>
            </div>
            <div class="nav-item" data-tab="analytics" onclick="switchMainTab('analytics')">
                <span class="nav-icon">&#9906;</span>
                <span class="nav-label">Analytics</span>
            </div>
            <div class="nav-item" data-tab="history" onclick="switchMainTab('history')">
                <span class="nav-icon">&#9776;</span>
                <span class="nav-label">History</span>
            </div>
            <div class="nav-item" data-tab="vesting" onclick="switchMainTab('vesting')">
                <span class="nav-icon">&#9203;</span>
                <span class="nav-label">Vesting</span>
            </div>
            <div class="notification-bell" onclick="toggleNotifications()">
                <span class="nav-icon">&#128276;</span>
                <span class="nav-label">Notifications</span>
                <span class="notification-badge" id="notification-count">0</span>
            </div>
        </div>
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="avatar-badge" id="user-avatar">U</div>
                <div class="user-details">
                    <div class="user-name" id="user-name">User</div>
                    <div class="user-role">Tracker</div>
                </div>
            </div>
            <div class="theme-toggle" onclick="toggleTheme()">
                <span class="nav-icon">&#9790;</span>
                <span class="theme-label">Dark Mode</span>
                <div class="theme-switch"></div>
            </div>
        </div>
    </nav>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleMobileSidebar()">&#9776;</button>

    <!-- Notification Panel -->
    <div class="notification-panel" id="notification-panel">
        <div class="notification-header">
            <h3>Notifications</h3>
            <button class="notification-close" onclick="toggleNotifications()">&times;</button>
        </div>
        <div class="notification-list" id="notification-list">
            <!-- Notifications will be populated dynamically -->
        </div>
    </div>

    <!-- FAB Button -->
    <button class="fab hidden" id="fab" onclick="openQuickAdd()">+</button>

    <!-- Quick Add Modal -->
    <div class="modal-overlay" id="quick-add-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Quick Add Payout</h3>
                <button class="modal-close" onclick="closeQuickAdd()">&times;</button>
            </div>
            <form id="quick-payout-form">
                <div class="form-group">
                    <label for="quick-company">Project</label>
                    <input type="text" id="quick-company" required placeholder="e.g., Coinbase">
                </div>
                <div class="form-group">
                    <label for="quick-date">Date</label>
                    <input type="date" id="quick-date" required>
                </div>
                <div class="form-group">
                    <label for="quick-amount">Amount of Tokens</label>
                    <input type="number" id="quick-amount" step="any" required placeholder="0.00">
                </div>
                <div class="form-group">
                    <label for="quick-crypto">Cryptocurrency</label>
                    <input type="text" id="quick-crypto" required placeholder="e.g., BTC, ETH">
                </div>
                <div class="form-group">
                    <label for="quick-usd">Amount Sold (USD)</label>
                    <input type="number" id="quick-usd" step="any" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label for="quick-category">Category</label>
                    <select id="quick-category">
                        <option value="">Select category...</option>
                        <option value="Airdrop">Airdrop</option>
                        <option value="Paid Deal">Paid Deal</option>
                        <option value="Staking">Staking</option>
                        <option value="Mining">Mining</option>
                        <option value="Trading">Trading</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Add Payout</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Onboarding Tour -->
    <div class="tour-overlay" id="tour-overlay">
        <div class="tour-tooltip" id="tour-tooltip">
            <h4 id="tour-title">Welcome!</h4>
            <p id="tour-text">Let's take a quick tour of your new dashboard.</p>
            <div class="tour-dots" id="tour-dots"></div>
            <div class="tour-actions">
                <button class="tour-btn tour-skip" onclick="endTour()">Skip Tour</button>
                <button class="tour-btn tour-next" onclick="nextTourStep()">Next</button>
            </div>
        </div>
    </div>

    <!-- Main App Section -->
    <div id="app-section" class="container hidden">
        <!-- Main Tabs -->
        <div class="main-tabs">
            <button class="main-tab active" data-tab="dashboard" onclick="switchMainTab('dashboard')">Dashboard</button>
            <button class="main-tab" data-tab="add-payout" onclick="switchMainTab('add-payout')">Add Payout</button>
            <button class="main-tab" data-tab="analytics" onclick="switchMainTab('analytics')">Analytics</button>
            <button class="main-tab" data-tab="history" onclick="switchMainTab('history')">History</button>
            <button class="main-tab" data-tab="vesting" onclick="switchMainTab('vesting')">Vesting</button>
        </div>

        <!-- Dashboard Tab -->
        <div class="tab-content active" id="tab-dashboard">
            <div class="dashboard-grid" id="dashboard-widgets">
                <!-- Total Payouts Widget -->
                <div class="dashboard-card draggable" draggable="true" data-widget="payouts">
                    <div class="dashboard-card-header">
                        <span class="dashboard-card-title">Total Payouts</span>
                        <span class="trend up" id="payouts-trend">+0%</span>
                    </div>
                    <div class="dashboard-card-value" id="dash-total-payouts">0</div>
                    <div class="mini-chart">
                        <canvas id="mini-payouts-chart"></canvas>
                    </div>
                </div>

                <!-- Total Revenue Widget -->
                <div class="dashboard-card draggable" draggable="true" data-widget="revenue">
                    <div class="dashboard-card-header">
                        <span class="dashboard-card-title">Total Revenue</span>
                        <span class="trend up" id="revenue-trend">+0%</span>
                    </div>
                    <div class="dashboard-card-value green" id="dash-total-revenue">$0</div>
                    <div class="mini-chart">
                        <canvas id="mini-revenue-chart"></canvas>
                    </div>
                </div>

                <!-- Projects Widget -->
                <div class="dashboard-card draggable" draggable="true" data-widget="projects">
                    <div class="dashboard-card-header">
                        <span class="dashboard-card-title">Active Projects</span>
                    </div>
                    <div class="dashboard-card-value" id="dash-projects">0</div>
                    <div class="filter-chips" id="project-chips">
                        <!-- Project chips populated dynamically -->
                    </div>
                </div>

                <!-- Recent Activity Widget -->
                <div class="dashboard-card draggable" draggable="true" data-widget="activity">
                    <div class="dashboard-card-header">
                        <span class="dashboard-card-title">Recent Activity</span>
                    </div>
                    <div class="recent-activity" id="recent-activity">
                        <!-- Activity items populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Heat Map Calendar -->
            <div class="card">
                <h2>Activity Calendar</h2>
                <div class="heatmap-container">
                    <div class="heatmap" id="heatmap">
                        <!-- Heatmap populated dynamically -->
                    </div>
                </div>
                <div class="heatmap-legend">
                    <span>Less</span>
                    <div class="heatmap-day"></div>
                    <div class="heatmap-day level-1"></div>
                    <div class="heatmap-day level-2"></div>
                    <div class="heatmap-day level-3"></div>
                    <div class="heatmap-day level-4"></div>
                    <div class="heatmap-day level-5"></div>
                    <span>More</span>
                </div>
            </div>

            <!-- Goal Tracking -->
            <div class="card">
                <h2>Monthly Goals</h2>
                <div class="goal-section" style="margin-top: 0; padding-top: 0; border-top: none;">
                    <div class="goal-header">
                        <span class="goal-title">Revenue Goal</span>
                        <span class="goal-value" id="goal-progress-text">$0 / $10,000</span>
                    </div>
                    <div class="goal-progress">
                        <div class="goal-progress-bar" id="goal-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="goal-section">
                    <div class="goal-header">
                        <span class="goal-title">Payouts Goal</span>
                        <span class="goal-value" id="payouts-goal-text">0 / 50</span>
                    </div>
                    <div class="goal-progress">
                        <div class="goal-progress-bar" id="payouts-goal-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Payout Tab -->
        <div class="tab-content" id="tab-add-payout">

        <!-- Entry Form -->
        <div class="card">
            <h2 id="form-title">Add New Payout</h2>
            <form id="payout-form">
                <input type="hidden" id="edit-id">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="company">Project</label>
                        <input type="text" id="company" required placeholder="e.g., Coinbase">
                    </div>
                    <div class="form-group">
                        <label for="date">Date</label>
                        <input type="date" id="date" required>
                    </div>
                    <div class="form-group">
                        <label for="amount">Amount of Tokens</label>
                        <input type="number" id="amount" step="any" required placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="crypto">Cryptocurrency</label>
                        <input type="text" id="crypto" required placeholder="e.g., BTC, ETH, SOL...">
                    </div>
                    <div class="form-group">
                        <label for="usd-sold">Amount Sold (USD)</label>
                        <input type="number" id="usd-sold" step="any" placeholder="0.00" oninput="updateEurPreview()">
                        <div class="eur-preview" id="eur-preview"></div>
                    </div>
                    <div class="form-group">
                        <label for="chain">Chain (optional)</label>
                        <input type="text" id="chain" placeholder="e.g., Ethereum, Solana, BSC...">
                    </div>
                    <div class="form-group">
                        <label for="category">Category</label>
                        <select id="category">
                            <option value="">Select category...</option>
                            <option value="Airdrop">Airdrop</option>
                            <option value="Paid Deal">Paid Deal</option>
                            <option value="Staking">Staking</option>
                            <option value="Mining">Mining</option>
                            <option value="Trading">Trading</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="wallet">Wallet Address (optional)</label>
                        <input type="text" id="wallet" placeholder="0x... or wallet address">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="submit-btn">Add Payout</button>
                    <button type="button" class="btn" id="cancel-btn" style="display:none; background: #666;">Cancel</button>
                </div>
            </form>
        </div>

        </div>
        <!-- End Add Payout Tab -->

        <!-- Analytics Tab -->
        <div class="tab-content" id="tab-analytics">
            <!-- Month Tabs -->
            <div class="card">
                <h2>Filter by Month</h2>
                <div class="month-tabs" id="month-tabs">
                    <button class="month-tab active" data-month="all">All Time</button>
                </div>
            </div>

            <!-- Quick Filter Chips -->
            <div class="card">
                <h2>Quick Filters</h2>
                <div class="filter-chips" id="crypto-filter-chips">
                    <span class="filter-chip active" data-crypto="all">All Cryptos</span>
                    <!-- More chips populated dynamically -->
                </div>
            </div>

            <!-- Statistics -->
            <div class="card">
                <h2>Summary <span id="summary-period" style="font-weight: normal; color: var(--text-secondary);"></span></h2>
                <div class="stats">
                    <div class="stat-box">
                        <div class="value" id="total-payouts">0</div>
                        <div class="label">Total Payouts</div>
                        <div class="sparkline-container"><canvas id="sparkline-payouts"></canvas></div>
                    </div>
                    <div class="stat-box">
                        <div class="value usd" id="total-usd-sold">$0.00</div>
                        <div class="label">
                            Total <span id="currency-label">USD</span> Sold
                            <button id="currency-toggle" class="currency-toggle-btn" onclick="toggleCurrency()" title="Switch to EUR"></button>
                        </div>
                        <div class="sparkline-container"><canvas id="sparkline-revenue"></canvas></div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="unique-companies">0</div>
                        <div class="label">Projects</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="unique-cryptos">0</div>
                        <div class="label">Cryptocurrencies</div>
                    </div>
                </div>
            </div>

            <!-- Comparison Mode -->
            <div class="card">
                <h2>Compare Periods</h2>
                <div class="comparison-toggle">
                    <label style="color: var(--text-secondary);">Compare:</label>
                    <select class="comparison-select" id="compare-period-1">
                        <option value="">Select period...</option>
                    </select>
                    <span style="color: var(--text-secondary);">vs</span>
                    <select class="comparison-select" id="compare-period-2">
                        <option value="">Select period...</option>
                    </select>
                    <button class="btn btn-primary" onclick="compareData()" style="padding: 8px 16px; font-size: 0.9rem;">Compare</button>
                </div>
                <div id="comparison-result" style="display: none;">
                    <div class="stats" style="margin-top: 15px;">
                        <div class="stat-box">
                            <div class="value" id="compare-payouts-diff">-</div>
                            <div class="label">Payouts Difference</div>
                        </div>
                        <div class="stat-box">
                            <div class="value usd" id="compare-revenue-diff">-</div>
                            <div class="label">Revenue Difference</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="card">
                <h2>Analytics (<span id="analytics-currency">USD</span> Values)</h2>
                <div class="charts-grid">
                <div class="chart-container">
                    <h3>Payouts Over Time (USD)</h3>
                    <div class="chart-wrapper">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>Payouts by Project (USD)</h3>
                    <div class="chart-wrapper">
                        <canvas id="companyChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>Payouts by Cryptocurrency (USD)</h3>
                    <div class="chart-wrapper">
                        <canvas id="cryptoChart"></canvas>
                    </div>
                </div>
                <div class="chart-container monthly-total-display">
                    <h3>Monthly Totals (USD)</h3>
                    <div class="monthly-totals-list" id="monthly-totals-list">
                    </div>
                </div>
            </div>
        </div>
        </div>
        <!-- End Analytics Tab -->

        <!-- History Tab -->
        <div class="tab-content" id="tab-history">
        <!-- Payout List -->
        <div class="card">
            <div class="header-actions">
                <h2>Payout History</h2>
                <div>
                    <input type="text" class="search-box" id="search" placeholder="Search...">
                    <button class="btn btn-export" onclick="exportCSV()">Export CSV</button>
                </div>
            </div>
            <div class="table-container">
                <table id="payout-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable('date')">Date</th>
                            <th onclick="sortTable('company')">Project</th>
                            <th onclick="sortTable('amount')">Tokens</th>
                            <th onclick="sortTable('crypto')">Crypto</th>
                            <th onclick="sortTable('category')">Category</th>
                            <th onclick="sortTable('chain')">Chain</th>
                            <th onclick="sortTable('usd_sold')">USD Sold</th>
                            <th>Wallet</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="payout-body">
                    </tbody>
                </table>
                <div class="no-data" id="no-data">No payouts recorded yet. Add your first payout above!</div>
            </div>
        </div>
        </div>
        <!-- End History Tab -->

        <!-- Vesting Tab -->
        <div class="tab-content" id="tab-vesting">
            <!-- Upcoming Unlocks Banner -->
            <div class="upcoming-unlocks" id="upcoming-unlocks-banner" style="display: none;">
                <h3>&#128276; Upcoming Unlocks</h3>
                <div id="upcoming-unlocks-list"></div>
            </div>

            <!-- Vesting Calendar -->
            <div class="card">
                <div class="vesting-calendar">
                    <div class="calendar-header">
                        <h3>Unlock Calendar</h3>
                        <div class="calendar-nav">
                            <button class="calendar-nav-btn" onclick="changeCalendarMonth(-1)">&#10094; Prev</button>
                            <span class="calendar-month-year" id="calendar-month-year">January 2025</span>
                            <button class="calendar-nav-btn" onclick="changeCalendarMonth(1)">Next &#10095;</button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="vesting-calendar-grid">
                        <div class="calendar-day-header">Sun</div>
                        <div class="calendar-day-header">Mon</div>
                        <div class="calendar-day-header">Tue</div>
                        <div class="calendar-day-header">Wed</div>
                        <div class="calendar-day-header">Thu</div>
                        <div class="calendar-day-header">Fri</div>
                        <div class="calendar-day-header">Sat</div>
                        <!-- Calendar days will be populated dynamically -->
                    </div>
                    <div class="calendar-legend">
                        <div class="calendar-legend-item">
                            <div class="calendar-legend-dot today"></div>
                            <span>Today</span>
                        </div>
                        <div class="calendar-legend-item">
                            <div class="calendar-legend-dot upcoming"></div>
                            <span>Upcoming Unlock</span>
                        </div>
                        <div class="calendar-legend-item">
                            <div class="calendar-legend-dot past"></div>
                            <span>Past Unlock</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Tooltip -->
            <div class="calendar-tooltip" id="calendar-tooltip">
                <h4 id="tooltip-date">January 1, 2025</h4>
                <div id="tooltip-unlocks"></div>
            </div>

            <!-- Vesting Stats -->
            <div class="vesting-stats">
                <div class="vesting-stat">
                    <div class="stat-value" id="total-vesting-tokens">0</div>
                    <div class="stat-label">Total Vesting Tokens</div>
                </div>
                <div class="vesting-stat">
                    <div class="stat-value" id="unlocked-tokens">0</div>
                    <div class="stat-label">Unlocked</div>
                </div>
                <div class="vesting-stat">
                    <div class="stat-value" id="locked-tokens">0</div>
                    <div class="stat-label">Still Locked</div>
                </div>
                <div class="vesting-stat">
                    <div class="stat-value" id="active-vestings">0</div>
                    <div class="stat-label">Active Vestings</div>
                </div>
            </div>

            <!-- Add Vesting Form -->
            <div class="card">
                <h2 id="vesting-form-title">Add Vesting Schedule</h2>
                <form id="vesting-form">
                    <input type="hidden" id="vesting-edit-id">
                    <div class="vesting-form">
                        <div class="form-group">
                            <label for="vesting-project">Project Name</label>
                            <input type="text" id="vesting-project" required placeholder="e.g., LayerZero">
                        </div>
                        <div class="form-group">
                            <label for="vesting-token">Token Symbol</label>
                            <input type="text" id="vesting-token" required placeholder="e.g., ZRO">
                        </div>
                        <div class="form-group">
                            <label for="vesting-total">Total Tokens</label>
                            <input type="number" id="vesting-total" step="any" required placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="vesting-tge">TGE Date (Token Generation)</label>
                            <input type="date" id="vesting-tge" required>
                        </div>
                        <div class="form-group">
                            <label for="vesting-tge-percent">TGE Unlock %</label>
                            <input type="number" id="vesting-tge-percent" step="any" placeholder="e.g., 10" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label for="vesting-cliff">Cliff (months)</label>
                            <input type="number" id="vesting-cliff" placeholder="e.g., 6" min="0">
                        </div>
                        <div class="form-group">
                            <label for="vesting-duration">Vesting Duration (months)</label>
                            <input type="number" id="vesting-duration" placeholder="e.g., 12" min="1">
                        </div>
                        <div class="form-group">
                            <label for="vesting-frequency">Unlock Frequency</label>
                            <select id="vesting-frequency">
                                <option value="monthly">Monthly</option>
                                <option value="quarterly">Quarterly</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="custom">Custom Dates</option>
                            </select>
                        </div>
                    </div>

                    <!-- Custom Unlock Dates Section -->
                    <div id="custom-unlocks-section" style="display: none; margin-bottom: 20px;">
                        <h3 style="color: var(--accent); font-size: 1rem; margin-bottom: 15px;">Custom Unlock Dates</h3>
                        <div id="custom-unlocks-list"></div>
                        <button type="button" class="add-unlock-btn" onclick="addCustomUnlock()">+ Add Unlock Date</button>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" id="vesting-submit-btn">Add Vesting</button>
                        <button type="button" class="btn" id="vesting-cancel-btn" style="display:none; background: #666;" onclick="cancelVestingEdit()">Cancel</button>
                    </div>
                </form>
            </div>

            <!-- Vesting List -->
            <div class="card">
                <h2>Your Vesting Schedules</h2>
                <div class="vesting-list" id="vesting-list">
                    <div class="no-data" id="no-vesting">No vesting schedules yet. Add your first one above!</div>
                </div>
            </div>
        </div>
        <!-- End Vesting Tab -->
    </div>

    <script>
        // ============================================
        // NEW UI FEATURES - SIDEBAR, THEME, NOTIFICATIONS, ETC.
        // ============================================

        // Sidebar Toggle
        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            document.body.classList.toggle('sidebar-collapsed', sidebar.classList.contains('collapsed'));
            localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        };

        window.toggleMobileSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('mobile-open');
        };

        // Theme Toggle
        window.toggleTheme = function() {
            const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
            document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
            document.querySelector('.theme-label').textContent = isDark ? 'Light Mode' : 'Dark Mode';
        };

        // Initialize theme
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const label = document.querySelector('.theme-label');
            if (label) label.textContent = savedTheme === 'light' ? 'Light Mode' : 'Dark Mode';
        }

        // Main Tab Switching
        window.switchMainTab = function(tabName) {
            // Update tab buttons
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });
            // Update nav items
            document.querySelectorAll('.nav-item[data-tab]').forEach(item => {
                item.classList.toggle('active', item.dataset.tab === tabName);
            });
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === 'tab-' + tabName);
            });
        };

        // Notification System
        var notifications = [];

        window.toggleNotifications = function() {
            document.getElementById('notification-panel').classList.toggle('open');
        };

        function addNotification(title, text, type = 'info') {
            const notification = { id: Date.now(), title, text, type, time: new Date() };
            notifications.unshift(notification);
            updateNotificationBadge();
            renderNotifications();
            localStorage.setItem('notifications', JSON.stringify(notifications));
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notification-count');
            if (badge) badge.textContent = notifications.length;
        }

        function renderNotifications() {
            const list = document.getElementById('notification-list');
            if (!list) return;
            if (notifications.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">No notifications yet</div>';
                return;
            }
            list.innerHTML = notifications.map(n => `
                <div class="notification-item ${n.type}">
                    <div class="notification-title">${n.title}</div>
                    <div class="notification-text">${n.text}</div>
                    <div class="notification-time">${formatTimeAgo(n.time)}</div>
                </div>
            `).join('');
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diff = Math.floor((now - new Date(date)) / 1000);
            if (diff < 60) return 'Just now';
            if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
            return Math.floor(diff / 86400) + 'd ago';
        }

        function checkMilestones() {
            const totalPayouts = payouts.length;
            const totalRevenue = payouts.reduce((sum, p) => sum + (p.usd_sold || 0), 0);

            const milestones = [
                { check: totalPayouts >= 10, key: 'milestone_10_payouts', title: 'Milestone Reached!', text: 'You have tracked 10 payouts!' },
                { check: totalPayouts >= 50, key: 'milestone_50_payouts', title: 'Milestone Reached!', text: 'You have tracked 50 payouts!' },
                { check: totalPayouts >= 100, key: 'milestone_100_payouts', title: 'Milestone Reached!', text: 'You have tracked 100 payouts!' },
                { check: totalRevenue >= 1000, key: 'milestone_1k_revenue', title: 'Revenue Milestone!', text: 'You have tracked $1,000 in revenue!' },
                { check: totalRevenue >= 10000, key: 'milestone_10k_revenue', title: 'Revenue Milestone!', text: 'You have tracked $10,000 in revenue!' },
            ];

            milestones.forEach(m => {
                if (m.check && !localStorage.getItem(m.key)) {
                    addNotification(m.title, m.text, 'milestone');
                    localStorage.setItem(m.key, 'true');
                }
            });
        }

        // Quick Add Modal (FAB)
        window.openQuickAdd = function() {
            document.getElementById('quick-add-modal').classList.add('active');
            document.getElementById('fab').classList.add('active');
            document.getElementById('quick-date').valueAsDate = new Date();
        };

        window.closeQuickAdd = function() {
            document.getElementById('quick-add-modal').classList.remove('active');
            document.getElementById('fab').classList.remove('active');
        };

        // Onboarding Tour
        var tourSteps = [
            { element: '.main-tabs', title: 'Navigation Tabs', text: 'Use these tabs to switch between Dashboard, Add Payout, Analytics, and History views.' },
            { element: '#tab-dashboard .dashboard-grid', title: 'Dashboard Widgets', text: 'Your key metrics at a glance. Drag and drop to rearrange them!' },
            { element: '#heatmap', title: 'Activity Calendar', text: 'See your payout activity over time, just like GitHub contributions.' },
            { element: '.fab', title: 'Quick Add Button', text: 'Click the + button to quickly add a new payout from anywhere.' },
            { element: '.sidebar', title: 'Sidebar Navigation', text: 'Access all features from the sidebar. Click to collapse/expand.' },
        ];
        var currentTourStep = 0;

        function startTour() {
            if (localStorage.getItem('tourCompleted')) return;
            currentTourStep = 0;
            showTourStep();
        }

        function showTourStep() {
            const overlay = document.getElementById('tour-overlay');
            const tooltip = document.getElementById('tour-tooltip');
            const step = tourSteps[currentTourStep];

            if (!step) {
                endTour();
                return;
            }

            document.getElementById('tour-title').textContent = step.title;
            document.getElementById('tour-text').textContent = step.text;

            // Update dots
            const dots = document.getElementById('tour-dots');
            dots.innerHTML = tourSteps.map((_, i) =>
                `<div class="tour-dot ${i === currentTourStep ? 'active' : ''}"></div>`
            ).join('');

            overlay.classList.add('active');

            // Position tooltip near element
            const element = document.querySelector(step.element);
            if (element) {
                const rect = element.getBoundingClientRect();
                tooltip.style.top = Math.min(rect.bottom + 20, window.innerHeight - 200) + 'px';
                tooltip.style.left = Math.min(rect.left, window.innerWidth - 340) + 'px';
            }
        }

        window.nextTourStep = function() {
            currentTourStep++;
            if (currentTourStep >= tourSteps.length) {
                endTour();
            } else {
                showTourStep();
            }
        };

        window.endTour = function() {
            document.getElementById('tour-overlay').classList.remove('active');
            localStorage.setItem('tourCompleted', 'true');
        };

        // Heatmap Generation
        function generateHeatmap() {
            const heatmap = document.getElementById('heatmap');
            if (!heatmap) return;

            const today = new Date();
            const weeks = 52;
            let html = '';

            // Create date to payout count map
            const activityMap = {};
            payouts.forEach(p => {
                activityMap[p.date] = (activityMap[p.date] || 0) + 1;
            });

            // Find max for scaling
            const maxActivity = Math.max(...Object.values(activityMap), 1);

            for (let w = weeks - 1; w >= 0; w--) {
                html += '<div class="heatmap-week">';
                for (let d = 0; d < 7; d++) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - (w * 7 + (6 - d)));
                    const dateStr = date.toISOString().split('T')[0];
                    const count = activityMap[dateStr] || 0;
                    const level = count === 0 ? 0 : Math.min(5, Math.ceil((count / maxActivity) * 5));
                    html += `<div class="heatmap-day level-${level}" title="${dateStr}: ${count} payouts"></div>`;
                }
                html += '</div>';
            }

            heatmap.innerHTML = html;
        }

        // Dashboard Mini Charts
        var miniPayoutsChart, miniRevenueChart;

        function initMiniCharts() {
            const payoutsCtx = document.getElementById('mini-payouts-chart');
            const revenueCtx = document.getElementById('mini-revenue-chart');

            if (!payoutsCtx || !revenueCtx) return;

            const miniChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, datalabels: { display: false } },
                scales: { x: { display: false }, y: { display: false } },
                elements: { point: { radius: 0 } }
            };

            miniPayoutsChart = new Chart(payoutsCtx, {
                type: 'line',
                data: { labels: [], datasets: [{ data: [], borderColor: '#00d9ff', borderWidth: 2, fill: true, backgroundColor: 'rgba(0,217,255,0.1)' }] },
                options: miniChartOptions
            });

            miniRevenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: { labels: [], datasets: [{ data: [], borderColor: '#2ed573', borderWidth: 2, fill: true, backgroundColor: 'rgba(46,213,115,0.1)' }] },
                options: miniChartOptions
            });
        }

        function updateMiniCharts() {
            if (!miniPayoutsChart || !miniRevenueChart) return;

            // Get last 30 days data
            const days = [];
            const payoutCounts = [];
            const revenueTotals = [];

            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                days.push(dateStr);

                const dayPayouts = payouts.filter(p => p.date === dateStr);
                payoutCounts.push(dayPayouts.length);
                revenueTotals.push(dayPayouts.reduce((sum, p) => sum + (p.usd_sold || 0), 0));
            }

            miniPayoutsChart.data.labels = days;
            miniPayoutsChart.data.datasets[0].data = payoutCounts;
            miniPayoutsChart.update();

            miniRevenueChart.data.labels = days;
            miniRevenueChart.data.datasets[0].data = revenueTotals;
            miniRevenueChart.update();
        }

        // Dashboard Updates
        function updateDashboard() {
            // Update values
            const totalPayouts = payouts.length;
            const totalRevenue = payouts.reduce((sum, p) => sum + (p.usd_sold || 0), 0);
            const uniqueProjects = new Set(payouts.map(p => p.company.toLowerCase())).size;

            document.getElementById('dash-total-payouts').textContent = totalPayouts;
            document.getElementById('dash-total-revenue').textContent = '$' + formatUSD(totalRevenue);
            document.getElementById('dash-projects').textContent = uniqueProjects;

            // Calculate trends (compare to previous month)
            const now = new Date();
            const thisMonth = now.toISOString().substring(0, 7);
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1).toISOString().substring(0, 7);

            const thisMonthPayouts = payouts.filter(p => p.date.startsWith(thisMonth));
            const lastMonthPayouts = payouts.filter(p => p.date.startsWith(lastMonth));

            const payoutsTrend = lastMonthPayouts.length > 0
                ? ((thisMonthPayouts.length - lastMonthPayouts.length) / lastMonthPayouts.length * 100).toFixed(0)
                : 0;
            const thisMonthRev = thisMonthPayouts.reduce((s, p) => s + (p.usd_sold || 0), 0);
            const lastMonthRev = lastMonthPayouts.reduce((s, p) => s + (p.usd_sold || 0), 0);
            const revenueTrend = lastMonthRev > 0
                ? ((thisMonthRev - lastMonthRev) / lastMonthRev * 100).toFixed(0)
                : 0;

            const payoutsTrendEl = document.getElementById('payouts-trend');
            const revenueTrendEl = document.getElementById('revenue-trend');

            if (payoutsTrendEl) {
                payoutsTrendEl.textContent = (payoutsTrend >= 0 ? '+' : '') + payoutsTrend + '%';
                payoutsTrendEl.className = 'trend ' + (payoutsTrend >= 0 ? 'up' : 'down');
            }
            if (revenueTrendEl) {
                revenueTrendEl.textContent = (revenueTrend >= 0 ? '+' : '') + revenueTrend + '%';
                revenueTrendEl.className = 'trend ' + (revenueTrend >= 0 ? 'up' : 'down');
            }

            // Update project chips
            const projectChips = document.getElementById('project-chips');
            if (projectChips) {
                const projects = [...new Set(payouts.map(p => p.company))].slice(0, 5);
                projectChips.innerHTML = projects.map(p =>
                    `<span class="filter-chip" onclick="filterByProject('${p}')">${p}</span>`
                ).join('');
            }

            // Update recent activity
            const recentActivity = document.getElementById('recent-activity');
            if (recentActivity) {
                const recent = payouts.slice(0, 5);
                recentActivity.innerHTML = recent.map(p => `
                    <div class="activity-item">
                        <div class="activity-icon">${p.crypto.charAt(0)}</div>
                        <div class="activity-details">
                            <div class="activity-title">${p.company} - ${p.crypto}</div>
                            <div class="activity-time">${formatDate(p.date)}</div>
                        </div>
                        <div class="activity-amount">${p.usd_sold ? '$' + formatUSD(p.usd_sold) : '-'}</div>
                    </div>
                `).join('') || '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">No activity yet</div>';
            }

            // Update goals
            updateGoals();

            // Update mini charts
            updateMiniCharts();

            // Generate heatmap
            generateHeatmap();

            // Check milestones
            checkMilestones();
        }

        function updateGoals() {
            const now = new Date();
            const thisMonth = now.toISOString().substring(0, 7);
            const monthPayouts = payouts.filter(p => p.date.startsWith(thisMonth));
            const monthRevenue = monthPayouts.reduce((s, p) => s + (p.usd_sold || 0), 0);

            const revenueGoal = 10000;
            const payoutsGoal = 50;

            document.getElementById('goal-progress-text').textContent = '$' + formatUSD(monthRevenue) + ' / $' + formatUSD(revenueGoal);
            document.getElementById('goal-bar').style.width = Math.min(100, (monthRevenue / revenueGoal) * 100) + '%';

            document.getElementById('payouts-goal-text').textContent = monthPayouts.length + ' / ' + payoutsGoal;
            document.getElementById('payouts-goal-bar').style.width = Math.min(100, (monthPayouts.length / payoutsGoal) * 100) + '%';
        }

        // Quick Filter Chips
        var selectedCryptoFilter = 'all';

        function updateCryptoFilterChips() {
            const chips = document.getElementById('crypto-filter-chips');
            if (!chips) return;

            const cryptos = [...new Set(payouts.map(p => p.crypto))];
            chips.innerHTML = `<span class="filter-chip ${selectedCryptoFilter === 'all' ? 'active' : ''}" data-crypto="all" onclick="filterByCrypto('all')">All Cryptos</span>` +
                cryptos.map(c => `<span class="filter-chip ${selectedCryptoFilter === c ? 'active' : ''}" data-crypto="${c}" onclick="filterByCrypto('${c}')">${c}</span>`).join('');
        }

        window.filterByCrypto = function(crypto) {
            selectedCryptoFilter = crypto;
            updateCryptoFilterChips();
            renderAll();
        };

        window.filterByProject = function(project) {
            document.getElementById('search').value = project;
            switchMainTab('history');
            renderTable();
        };

        // Comparison Mode
        window.compareData = function() {
            const period1 = document.getElementById('compare-period-1').value;
            const period2 = document.getElementById('compare-period-2').value;

            if (!period1 || !period2) {
                alert('Please select two periods to compare');
                return;
            }

            const p1Data = payouts.filter(p => p.date.startsWith(period1));
            const p2Data = payouts.filter(p => p.date.startsWith(period2));

            const p1Payouts = p1Data.length;
            const p2Payouts = p2Data.length;
            const p1Revenue = p1Data.reduce((s, p) => s + (p.usd_sold || 0), 0);
            const p2Revenue = p2Data.reduce((s, p) => s + (p.usd_sold || 0), 0);

            const payoutsDiff = p1Payouts - p2Payouts;
            const revenueDiff = p1Revenue - p2Revenue;

            document.getElementById('compare-payouts-diff').textContent = (payoutsDiff >= 0 ? '+' : '') + payoutsDiff;
            document.getElementById('compare-payouts-diff').className = 'value ' + (payoutsDiff >= 0 ? 'trend-up' : 'trend-down');

            document.getElementById('compare-revenue-diff').textContent = (revenueDiff >= 0 ? '+' : '') + '$' + formatUSD(Math.abs(revenueDiff));
            document.getElementById('compare-revenue-diff').className = 'value usd ' + (revenueDiff >= 0 ? 'trend-up' : 'trend-down');

            document.getElementById('comparison-result').style.display = 'block';
        };

        function updateComparisonSelects() {
            const months = [...new Set(payouts.map(p => p.date.substring(0, 7)))].sort().reverse();
            const options = '<option value="">Select period...</option>' +
                months.map(m => {
                    const [year, month] = m.split('-');
                    const name = new Date(year, month - 1).toLocaleString('en-US', { month: 'short', year: 'numeric' });
                    return `<option value="${m}">${name}</option>`;
                }).join('');

            document.getElementById('compare-period-1').innerHTML = options;
            document.getElementById('compare-period-2').innerHTML = options;
        }

        // Drag and Drop for Dashboard Widgets
        function initDragDrop() {
            const widgets = document.querySelectorAll('.draggable');
            widgets.forEach(widget => {
                widget.addEventListener('dragstart', handleDragStart);
                widget.addEventListener('dragend', handleDragEnd);
                widget.addEventListener('dragover', handleDragOver);
                widget.addEventListener('drop', handleDrop);
                widget.addEventListener('dragenter', handleDragEnter);
                widget.addEventListener('dragleave', handleDragLeave);
            });
        }

        var draggedWidget = null;

        function handleDragStart(e) {
            draggedWidget = this;
            this.classList.add('dragging');
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDragEnter(e) {
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            if (draggedWidget !== this) {
                const parent = this.parentNode;
                const allWidgets = [...parent.children];
                const draggedIndex = allWidgets.indexOf(draggedWidget);
                const targetIndex = allWidgets.indexOf(this);

                if (draggedIndex < targetIndex) {
                    parent.insertBefore(draggedWidget, this.nextSibling);
                } else {
                    parent.insertBefore(draggedWidget, this);
                }
            }
            this.classList.remove('drag-over');
        }

        // ============================================
        // ATTACH ALL FUNCTIONS TO WINDOW IMMEDIATELY
        // ============================================

        window.hideAuthMessages = function() {
            document.getElementById('auth-error').style.display = 'none';
            document.getElementById('auth-success').style.display = 'none';
        };

        window.showAuthError = function(message) {
            var el = document.getElementById('auth-error');
            el.textContent = message;
            el.style.display = 'block';
        };

        window.showAuthSuccess = function(message) {
            var el = document.getElementById('auth-success');
            el.textContent = message;
            el.style.display = 'block';
        };

        window.showAuthTab = function(tab) {
            document.querySelectorAll('.auth-tab').forEach(function(t) { t.classList.remove('active'); });
            if (tab === 'login') {
                document.querySelector('.auth-tab:first-child').classList.add('active');
            } else {
                document.querySelector('.auth-tab:last-child').classList.add('active');
            }
            document.getElementById('login-form').classList.toggle('hidden', tab !== 'login');
            document.getElementById('signup-form').classList.toggle('hidden', tab !== 'signup');
            window.hideAuthMessages();
        };

        window.handleLogin = function(e) {
            e.preventDefault();
            window.hideAuthMessages();
            var email = document.getElementById('login-email').value;
            var password = document.getElementById('login-password').value;
            window.supabaseClient.auth.signInWithPassword({ email: email, password: password })
                .then(function(result) {
                    if (result.error) window.showAuthError(result.error.message);
                });
        };

        window.handleSignup = function(e) {
            e.preventDefault();
            window.hideAuthMessages();
            var email = document.getElementById('signup-email').value;
            var password = document.getElementById('signup-password').value;
            var confirm = document.getElementById('signup-confirm').value;
            if (password !== confirm) {
                window.showAuthError('Passwords do not match');
                return;
            }
            window.supabaseClient.auth.signUp({ email: email, password: password })
                .then(function(result) {
                    if (result.error) {
                        window.showAuthError(result.error.message);
                    } else {
                        window.showAuthSuccess('Account created! Please check your email to verify your account.');
                        document.getElementById('signup-form').reset();
                    }
                });
        };

        window.handleGoogleLogin = function() {
            window.hideAuthMessages();
            window.supabaseClient.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: window.location.origin + window.location.pathname
                }
            }).then(function(result) {
                if (result.error) window.showAuthError(result.error.message);
            });
        };

        window.handleLogout = function() {
            // Hide sidebar and FAB
            document.getElementById('sidebar').classList.add('hidden');
            document.getElementById('fab').classList.add('hidden');
            document.body.classList.remove('has-sidebar', 'sidebar-collapsed');
            window.supabaseClient.auth.signOut();
        };

        // ============================================
        // SUPABASE INITIALIZATION
        // ============================================

        var SUPABASE_URL = 'https://ivjxsidujcnfeaxgrtch.supabase.co';
        var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2anhzaWR1amNuZmVheGdydGNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1MzExODAsImV4cCI6MjA4MzEwNzE4MH0.Hl85howprQbotsHTlTHW0g8tyXwhZAgxedGTZ8lT6Jw';

        window.supabaseClient = null;

        // Data storage
        var payouts = [];
        var currentUser = null;
        var sortField = 'date';
        var sortDirection = 'desc';
        var selectedMonth = 'all';

        // Chart instances
        var timelineChart, companyChart, cryptoChart;

        // Currency settings
        var selectedCurrency = 'USD';
        var eurExchangeRate = null;

        // Chart colors
        var chartColors = [
            '#00d9ff', '#ff6b6b', '#4ecdc4', '#ffe66d', '#95e1d3',
            '#f38181', '#aa96da', '#fcbad3', '#a8d8ea', '#ffd93d'
        ];

        // Fetch EUR exchange rate
        async function fetchExchangeRate() {
            try {
                const response = await fetch('https://api.frankfurter.app/latest?from=USD&to=EUR');
                const data = await response.json();
                eurExchangeRate = data.rates.EUR;
                console.log('EUR exchange rate loaded:', eurExchangeRate);
            } catch (error) {
                console.error('Failed to fetch exchange rate:', error);
                eurExchangeRate = 0.92; // Fallback rate
            }
        }

        // Toggle currency display
        window.toggleCurrency = function() {
            selectedCurrency = selectedCurrency === 'USD' ? 'EUR' : 'USD';
            updateStats();
            updateCharts();
            updateCurrencyToggleButton();
        };

        function updateCurrencyToggleButton() {
            const btn = document.getElementById('currency-toggle');
            if (btn) {
                btn.textContent = selectedCurrency === 'USD' ? '' : '$';
                btn.title = selectedCurrency === 'USD' ? 'Switch to EUR' : 'Switch to USD';
            }
        }

        // Convert USD to selected currency
        function convertCurrency(usdValue) {
            if (selectedCurrency === 'EUR' && eurExchangeRate) {
                return usdValue * eurExchangeRate;
            }
            return usdValue;
        }

        // Get currency symbol
        function getCurrencySymbol() {
            return selectedCurrency === 'EUR' ? '' : '$';
        }

        // Update EUR preview in form
        window.updateEurPreview = function() {
            const usdInput = document.getElementById('usd-sold');
            const eurPreview = document.getElementById('eur-preview');
            const usdValue = parseFloat(usdInput.value) || 0;

            if (usdValue > 0 && eurExchangeRate) {
                const eurValue = usdValue * eurExchangeRate;
                eurPreview.textContent = ' ' + formatUSD(eurValue) + ' EUR';
            } else {
                eurPreview.textContent = '';
            }
        };

        // Initialize app after Supabase is ready
        function initApp() {
            if (!window.supabaseClient) return;

            // Check for existing session
            window.supabaseClient.auth.getSession().then(function(result) {
                if (result.data && result.data.session) {
                    currentUser = result.data.session.user;
                    showApp();
                }
            });

            // Listen for auth changes
            window.supabaseClient.auth.onAuthStateChange(function(event, session) {
                if (event === 'SIGNED_IN' && session) {
                    currentUser = session.user;
                    showApp();
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    showAuth();
                }
            });
        }

        // Initialize Supabase when library loads
        document.addEventListener('DOMContentLoaded', function() {
            if (window.supabase) {
                window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                initApp();
            } else {
                // Wait for Supabase library
                var check = setInterval(function() {
                    if (window.supabase) {
                        clearInterval(check);
                        window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                        initApp();
                    }
                }, 100);
            }
        });

        function showAuth() {
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('app-section').classList.add('hidden');
        }

        async function showApp() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');

            // Show sidebar and FAB
            document.getElementById('sidebar').classList.remove('hidden');
            document.getElementById('fab').classList.remove('hidden');
            document.body.classList.add('has-sidebar');

            // Initialize theme
            initTheme();

            // Check if sidebar should be collapsed
            if (localStorage.getItem('sidebarCollapsed') === 'true') {
                document.getElementById('sidebar').classList.add('collapsed');
                document.body.classList.add('sidebar-collapsed');
            }

            // Set user avatar and name
            const email = currentUser.email;
            const initials = email.substring(0, 2).toUpperCase();
            document.getElementById('user-avatar').textContent = initials;
            document.getElementById('user-name').textContent = email.split('@')[0];

            // Load saved notifications
            try {
                const savedNotifications = localStorage.getItem('notifications');
                if (savedNotifications) {
                    notifications = JSON.parse(savedNotifications);
                    updateNotificationBadge();
                    renderNotifications();
                }
            } catch (e) {}

            document.getElementById('date').valueAsDate = new Date();
            initCharts();
            initMiniCharts();
            initDragDrop();
            await fetchExchangeRate();
            await loadPayouts();
            loadVestings();

            // Start tour for first-time users
            setTimeout(() => startTour(), 1000);
        }

        // Database functions
        async function loadPayouts() {
            var result = await window.supabaseClient
                .from('payouts')
                .select('*')
                .order('date', { ascending: false });

            if (result.error) {
                console.error('Error loading payouts:', result.error);
                return;
            }

            payouts = (result.data || []).map(p => ({ ...p, amount: parseFloat(p.amount) || 0, usd_sold: parseFloat(p.usd_sold) || 0 }));
            updateMonthTabs();
            renderAll();
        }

        async function savePayout(payout) {
            var result = await window.supabaseClient
                .from('payouts')
                .insert([{
                    user_id: currentUser.id,
                    company: payout.company,
                    date: payout.date,
                    amount: payout.amount,
                    crypto: payout.crypto,
                    usd_sold: payout.usd_sold,
                    chain: payout.chain,
                    wallet: payout.wallet,
                    category: payout.category || null
                }])
                .select();

            if (result.error) {
                console.error('Error saving payout:', result.error);
                alert('Error saving payout: ' + result.error.message);
                return null;
            }

            const saved = result.data[0]; return { ...saved, amount: parseFloat(saved.amount) || 0, usd_sold: parseFloat(saved.usd_sold) || 0 };
        }

        async function updatePayout(id, payout) {
            var result = await window.supabaseClient
                .from('payouts')
                .update({
                    company: payout.company,
                    date: payout.date,
                    amount: payout.amount,
                    crypto: payout.crypto,
                    usd_sold: payout.usd_sold,
                    chain: payout.chain,
                    wallet: payout.wallet,
                    category: payout.category || null
                })
                .eq('id', id)
                .select();

            if (result.error) {
                console.error('Error updating payout:', result.error);
                alert('Error updating payout: ' + result.error.message);
                return null;
            }

            const updated = result.data[0]; return { ...updated, amount: parseFloat(updated.amount) || 0, usd_sold: parseFloat(updated.usd_sold) || 0 };
        }

        async function deletePayoutFromDB(id) {
            var result = await window.supabaseClient
                .from('payouts')
                .delete()
                .eq('id', id);

            if (result.error) {
                console.error('Error deleting payout:', result.error);
                alert('Error deleting payout: ' + result.error.message);
                return false;
            }

            return true;
        }

        // Format USD
        function formatUSD(value) {
            if (value >= 1000000) {
                return (value / 1000000).toFixed(2) + 'M';
            } else if (value >= 1000) {
                return (value / 1000).toFixed(2) + 'K';
            } else if (value >= 1) {
                return value.toFixed(2);
            } else {
                return value.toFixed(4);
            }
        }

        // Initialize charts
        function initCharts() {
            // Register the datalabels plugin
            Chart.register(ChartDataLabels);

            // Timeline chart
            timelineChart = new Chart(document.getElementById('timelineChart'), {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return getCurrencySymbol() + formatUSD(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#aaa' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            ticks: {
                                color: '#aaa',
                                callback: function(value) {
                                    return getCurrencySymbol() + formatUSD(value);
                                }
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });

            // Company chart (vertical bar)
            companyChart = new Chart(document.getElementById('companyChart'), {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#2ed573',
                            font: { weight: 'bold', size: 11 },
                            formatter: function(value) {
                                return getCurrencySymbol() + formatUSD(value);
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return getCurrencySymbol() + formatUSD(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#aaa' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            ticks: {
                                color: '#aaa',
                                callback: function(value) {
                                    return getCurrencySymbol() + formatUSD(value);
                                }
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });

            // Crypto chart (doughnut)
            cryptoChart = new Chart(document.getElementById('cryptoChart'), {
                type: 'doughnut',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#aaa' }
                        },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: 11 },
                            formatter: function(value, context) {
                                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                if (percentage < 5) return '';
                                return getCurrencySymbol() + formatUSD(value);
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.raw / total) * 100).toFixed(1);
                                    return context.label + ': ' + getCurrencySymbol() + formatUSD(context.raw) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Get filtered payouts based on selected month
        function getFilteredPayouts() {
            if (selectedMonth === 'all') return payouts;
            return payouts.filter(p => p.date.substring(0, 7) === selectedMonth);
        }

        // Update month tabs
        function updateMonthTabs() {
            const months = new Set(payouts.map(p => p.date.substring(0, 7)));
            const sortedMonths = Array.from(months).sort().reverse();

            const tabsContainer = document.getElementById('month-tabs');
            tabsContainer.innerHTML = `<button class="month-tab ${selectedMonth === 'all' ? 'active' : ''}" data-month="all">All Time</button>`;

            sortedMonths.forEach(month => {
                const [year, monthNum] = month.split('-');
                const monthName = new Date(year, monthNum - 1).toLocaleString('en-US', { month: 'short', year: 'numeric' });
                tabsContainer.innerHTML += `<button class="month-tab ${selectedMonth === month ? 'active' : ''}" data-month="${month}">${monthName}</button>`;
            });

            // Add click handlers
            document.querySelectorAll('.month-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    selectedMonth = tab.dataset.month;
                    document.querySelectorAll('.month-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    renderAll();
                });
            });
        }

        // Render everything
        function renderAll() {
            renderTable();
            updateStats();
            updateCharts();
            updateDashboard();
            updateCategoryFilterChips();
            updateComparisonSelects();
        }

        // Form submission
        document.getElementById('payout-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const editId = document.getElementById('edit-id').value;
            const payout = {
                company: document.getElementById('company').value.trim(),
                date: document.getElementById('date').value,
                amount: parseFloat(document.getElementById('amount').value),
                crypto: document.getElementById('crypto').value.toUpperCase(),
                usd_sold: parseFloat(document.getElementById('usd-sold').value) || 0,
                chain: document.getElementById('chain').value.trim(),
                wallet: document.getElementById('wallet').value.trim(),
                category: document.getElementById('category').value || ''
            };

            if (editId) {
                const updated = await updatePayout(editId, payout);
                if (updated) {
                    const index = payouts.findIndex(p => p.id === editId);
                    if (index !== -1) {
                        payouts[index] = updated;
                    }
                }
                cancelEdit();
            } else {
                const saved = await savePayout(payout);
                if (saved) {
                    payouts.unshift(saved);
                }
            }

            updateMonthTabs();
            renderAll();
            e.target.reset();
            document.getElementById('date').valueAsDate = new Date();
        });

        // Render table
        function renderTable() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const tbody = document.getElementById('payout-body');
            const noData = document.getElementById('no-data');

            let filtered = getFilteredPayouts().filter(p => {
                const matchesSearch = p.company.toLowerCase().includes(searchTerm) ||
                    p.crypto.toLowerCase().includes(searchTerm) ||
                    (p.chain || '').toLowerCase().includes(searchTerm) ||
                    (p.category || '').toLowerCase().includes(searchTerm);
                const matchesCrypto = selectedCryptoFilter === 'all' || p.crypto === selectedCryptoFilter;
                const matchesCategory = selectedCategoryFilter === 'all' || p.category === selectedCategoryFilter;
                return matchesSearch && matchesCrypto && matchesCategory;
            });

            filtered.sort((a, b) => {
                let aVal = a[sortField];
                let bVal = b[sortField];

                if (sortField === 'amount' || sortField === 'usd_sold') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                }

                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '';
                noData.style.display = 'block';
                return;
            }

            noData.style.display = 'none';
            tbody.innerHTML = filtered.map(p => {
                const categoryClass = (p.category || '').toLowerCase().replace(' ', '-');
                return `
                <tr>
                    <td>${formatDate(p.date)}</td>
                    <td>${escapeHtml(p.company)}</td>
                    <td>${p.amount}</td>
                    <td>${p.crypto}</td>
                    <td>${p.category ? `<span class="category-badge ${categoryClass}">${p.category}</span>` : '-'}</td>
                    <td>${escapeHtml(p.chain) || '-'}</td>
                    <td class="usd-value">${p.usd_sold ? '$' + formatUSD(p.usd_sold) : '-'}</td>
                    <td style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(p.wallet) || ''}">${escapeHtml(p.wallet) || '-'}</td>
                    <td>
                        <button class="btn btn-edit" onclick="editPayout('${p.id}')">Edit</button>
                        <button class="btn btn-danger" onclick="deletePayout('${p.id}')">Delete</button>
                    </td>
                </tr>
            `}).join('');
        }

        // Update statistics
        function updateStats() {
            const filtered = getFilteredPayouts();

            const totalUSDSold = filtered.reduce((sum, p) => sum + (p.usd_sold || 0), 0);
            const displayValue = convertCurrency(totalUSDSold);

            document.getElementById('total-payouts').textContent = filtered.length;
            document.getElementById('total-usd-sold').textContent = getCurrencySymbol() + formatUSD(displayValue);
            document.getElementById('currency-label').textContent = selectedCurrency;
            document.getElementById('unique-companies').textContent =
                new Set(filtered.map(p => p.company.toLowerCase())).size;
            document.getElementById('unique-cryptos').textContent =
                new Set(filtered.map(p => p.crypto)).size;

            // Update period label
            const periodLabel = document.getElementById('summary-period');
            if (selectedMonth === 'all') {
                periodLabel.textContent = '';
            } else {
                const [year, month] = selectedMonth.split('-');
                periodLabel.textContent = `- ${new Date(year, month - 1).toLocaleString('en-US', { month: 'long', year: 'numeric' })}`;
            }
        }

        // Update charts
        function updateCharts() {
            const filtered = getFilteredPayouts();

            const currencySymbol = getCurrencySymbol();

            // Timeline chart - values over time
            const timelineData = {};
            filtered.forEach(p => {
                timelineData[p.date] = (timelineData[p.date] || 0) + (p.usd_sold || 0);
            });
            const sortedDates = Object.keys(timelineData).sort();

            timelineChart.data.labels = sortedDates.map(d => formatDate(d));
            timelineChart.data.datasets = [{
                data: sortedDates.map(d => convertCurrency(timelineData[d])),
                borderColor: '#2ed573',
                backgroundColor: 'rgba(46, 213, 115, 0.1)',
                fill: true,
                tension: 0.3
            }];
            timelineChart.update();

            // Company chart - values by project
            const companyData = {};
            filtered.forEach(p => {
                companyData[p.company] = (companyData[p.company] || 0) + (p.usd_sold || 0);
            });
            const sortedCompanies = Object.entries(companyData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);

            companyChart.data.labels = sortedCompanies.map(c => c[0]);
            companyChart.data.datasets = [{
                data: sortedCompanies.map(c => convertCurrency(c[1])),
                backgroundColor: chartColors
            }];
            companyChart.update();

            // Crypto chart - values by crypto
            const cryptoData = {};
            filtered.forEach(p => {
                cryptoData[p.crypto] = (cryptoData[p.crypto] || 0) + (p.usd_sold || 0);
            });

            cryptoChart.data.labels = Object.keys(cryptoData);
            cryptoChart.data.datasets = [{
                data: Object.values(cryptoData).map(v => convertCurrency(v)),
                backgroundColor: chartColors
            }];
            cryptoChart.update();

            // Monthly totals list - values by month (shows all months)
            const monthlyData = {};
            payouts.forEach(p => {
                const month = p.date.substring(0, 7);
                monthlyData[month] = (monthlyData[month] || 0) + (p.usd_sold || 0);
            });
            const sortedMonths = Object.keys(monthlyData).sort().reverse();

            const monthlyList = document.getElementById('monthly-totals-list');
            if (sortedMonths.length === 0) {
                monthlyList.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No data yet</div>';
            } else {
                monthlyList.innerHTML = sortedMonths.map(m => {
                    const [year, monthNum] = m.split('-');
                    const monthName = new Date(year, monthNum - 1).toLocaleString('en-US', { month: 'long', year: 'numeric' });
                    const isActive = m === selectedMonth;
                    return `
                        <div class="monthly-total-item ${isActive ? 'active' : ''}">
                            <span class="month-name">${monthName}</span>
                            <span class="month-amount">${currencySymbol}${formatUSD(convertCurrency(monthlyData[m]))}</span>
                        </div>
                    `;
                }).join('');
            }

            // Update chart titles and analytics header
            document.getElementById('analytics-currency').textContent = selectedCurrency;
            document.querySelector('#timelineChart').closest('.chart-container').querySelector('h3').textContent = 'Payouts Over Time (' + selectedCurrency + ')';
            document.querySelector('#companyChart').closest('.chart-container').querySelector('h3').textContent = 'Payouts by Project (' + selectedCurrency + ')';
            document.querySelector('#cryptoChart').closest('.chart-container').querySelector('h3').textContent = 'Payouts by Cryptocurrency (' + selectedCurrency + ')';
            document.querySelector('#monthly-totals-list').closest('.chart-container').querySelector('h3').textContent = 'Monthly Totals (' + selectedCurrency + ')';
        }

        // Sort table
        function sortTable(field) {
            if (sortField === field) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDirection = 'asc';
            }
            renderTable();
        }

        // Edit payout
        function editPayout(id) {
            const payout = payouts.find(p => p.id === id);
            if (!payout) return;

            document.getElementById('edit-id').value = payout.id;
            document.getElementById('company').value = payout.company;
            document.getElementById('date').value = payout.date;
            document.getElementById('amount').value = payout.amount;
            document.getElementById('crypto').value = payout.crypto;
            document.getElementById('usd-sold').value = payout.usd_sold || '';
            document.getElementById('chain').value = payout.chain || '';
            document.getElementById('wallet').value = payout.wallet || '';
            document.getElementById('category').value = payout.category || '';

            document.getElementById('form-title').textContent = 'Edit Payout';
            document.getElementById('submit-btn').textContent = 'Update Payout';
            document.getElementById('cancel-btn').style.display = 'inline-block';

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Cancel edit
        function cancelEdit() {
            document.getElementById('edit-id').value = '';
            document.getElementById('payout-form').reset();
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('form-title').textContent = 'Add New Payout';
            document.getElementById('submit-btn').textContent = 'Add Payout';
            document.getElementById('cancel-btn').style.display = 'none';
        }

        document.getElementById('cancel-btn').addEventListener('click', cancelEdit);

        // Delete payout
        async function deletePayout(id) {
            if (confirm('Are you sure you want to delete this payout?')) {
                const success = await deletePayoutFromDB(id);
                if (success) {
                    payouts = payouts.filter(p => p.id !== id);
                    updateMonthTabs();
                    renderAll();
                }
            }
        }

        // Search
        document.getElementById('search').addEventListener('input', renderTable);

        // Export to CSV
        function exportCSV() {
            const filtered = getFilteredPayouts();
            if (filtered.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = ['Date', 'Project', 'Tokens', 'Cryptocurrency', 'Chain', 'USD Sold', 'Wallet'];
            const rows = filtered.map(p => [
                p.date,
                `"${p.company.replace(/"/g, '""')}"`,
                p.amount,
                p.crypto,
                `"${(p.chain || '').replace(/"/g, '""')}"`,
                (p.usd_sold || 0).toFixed(2),
                `"${(p.wallet || '').replace(/"/g, '""')}"`
            ]);

            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `crypto-payouts-${selectedMonth === 'all' ? 'all' : selectedMonth}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Helper functions
        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Quick Add Form Handler
        document.getElementById('quick-payout-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const payout = {
                company: document.getElementById('quick-company').value.trim(),
                date: document.getElementById('quick-date').value,
                amount: parseFloat(document.getElementById('quick-amount').value),
                crypto: document.getElementById('quick-crypto').value.toUpperCase(),
                usd_sold: parseFloat(document.getElementById('quick-usd').value) || 0,
                chain: '',
                wallet: '',
                category: document.getElementById('quick-category').value || ''
            };

            const saved = await savePayout(payout);
            if (saved) {
                payouts.unshift(saved);
                updateMonthTabs();
                renderAll();
                closeQuickAdd();
                e.target.reset();
                addNotification('Payout Added', `Added ${payout.amount} ${payout.crypto} from ${payout.company}`, 'info');
            }
        });

        // Close modal on backdrop click
        document.getElementById('quick-add-modal').addEventListener('click', (e) => {
            if (e.target.id === 'quick-add-modal') {
                closeQuickAdd();
            }
        });

        // Close notification panel on outside click
        document.addEventListener('click', (e) => {
            const panel = document.getElementById('notification-panel');
            const bell = document.querySelector('.notification-bell');
            if (panel.classList.contains('open') && !panel.contains(e.target) && !bell.contains(e.target)) {
                panel.classList.remove('open');
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Escape to close modals
            if (e.key === 'Escape') {
                closeQuickAdd();
                document.getElementById('notification-panel').classList.remove('open');
                endTour();
            }
            // N for new payout (when not in input)
            if (e.key === 'n' && !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
                e.preventDefault();
                openQuickAdd();
            }
        });

        // ============================================
        // VESTING TRACKER FUNCTIONALITY
        // ============================================

        var vestings = [];
        var customUnlocks = [];

        // Load vestings from localStorage
        function loadVestings() {
            try {
                const saved = localStorage.getItem('vestings_' + currentUser.id);
                if (saved) {
                    vestings = JSON.parse(saved);
                }
            } catch (e) {
                vestings = [];
            }
            renderVestings();
            updateVestingStats();
            checkUpcomingUnlocks();
            renderVestingCalendar();
        }

        // Save vestings to localStorage
        function saveVestingsToStorage() {
            localStorage.setItem('vestings_' + currentUser.id, JSON.stringify(vestings));
        }

        // Toggle custom unlocks section based on frequency selection
        document.getElementById('vesting-frequency').addEventListener('change', function() {
            const customSection = document.getElementById('custom-unlocks-section');
            customSection.style.display = this.value === 'custom' ? 'block' : 'none';
        });

        // Add custom unlock row
        window.addCustomUnlock = function() {
            const list = document.getElementById('custom-unlocks-list');
            const index = list.children.length;
            const row = document.createElement('div');
            row.className = 'unlock-input-row';
            row.innerHTML = `
                <input type="date" name="custom-date-${index}" required>
                <input type="number" name="custom-amount-${index}" step="any" placeholder="Token Amount" required>
                <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()" style="padding: 8px 12px;"></button>
            `;
            list.appendChild(row);
        };

        // Calculate unlock schedule
        function calculateUnlockSchedule(vesting) {
            const unlocks = [];
            const tgeDate = new Date(vesting.tgeDate);
            const totalTokens = parseFloat(vesting.totalTokens);
            const tgePercent = parseFloat(vesting.tgePercent) || 0;
            const cliff = parseInt(vesting.cliff) || 0;
            const duration = parseInt(vesting.duration) || 12;
            const frequency = vesting.frequency;

            // TGE unlock
            if (tgePercent > 0) {
                unlocks.push({
                    date: vesting.tgeDate,
                    amount: totalTokens * (tgePercent / 100),
                    type: 'TGE'
                });
            }

            // Custom unlocks
            if (frequency === 'custom' && vesting.customUnlocks) {
                vesting.customUnlocks.forEach(u => {
                    unlocks.push({
                        date: u.date,
                        amount: parseFloat(u.amount),
                        type: 'Custom'
                    });
                });
            } else {
                // Calculate periodic unlocks
                const remainingTokens = totalTokens * (1 - tgePercent / 100);
                let periods = duration;
                let periodMonths = 1;

                if (frequency === 'quarterly') periodMonths = 3;
                else if (frequency === 'weekly') periodMonths = 0.25;
                else if (frequency === 'daily') periodMonths = 1 / 30;

                const numPeriods = Math.ceil(duration / periodMonths);
                const tokensPerPeriod = remainingTokens / numPeriods;

                for (let i = 1; i <= numPeriods; i++) {
                    const unlockDate = new Date(tgeDate);
                    unlockDate.setMonth(unlockDate.getMonth() + cliff + (i * periodMonths));

                    unlocks.push({
                        date: unlockDate.toISOString().split('T')[0],
                        amount: tokensPerPeriod,
                        type: frequency.charAt(0).toUpperCase() + frequency.slice(1)
                    });
                }
            }

            return unlocks.sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        // Vesting form submission
        document.getElementById('vesting-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const editId = document.getElementById('vesting-edit-id').value;

            // Collect custom unlocks if custom frequency
            let customUnlocksData = [];
            if (document.getElementById('vesting-frequency').value === 'custom') {
                const rows = document.querySelectorAll('#custom-unlocks-list .unlock-input-row');
                rows.forEach((row, i) => {
                    const dateInput = row.querySelector('input[type="date"]');
                    const amountInput = row.querySelector('input[type="number"]');
                    if (dateInput.value && amountInput.value) {
                        customUnlocksData.push({
                            date: dateInput.value,
                            amount: amountInput.value
                        });
                    }
                });
            }

            const vesting = {
                id: editId || Date.now().toString(),
                project: document.getElementById('vesting-project').value.trim(),
                token: document.getElementById('vesting-token').value.toUpperCase(),
                totalTokens: document.getElementById('vesting-total').value,
                tgeDate: document.getElementById('vesting-tge').value,
                tgePercent: document.getElementById('vesting-tge-percent').value || 0,
                cliff: document.getElementById('vesting-cliff').value || 0,
                duration: document.getElementById('vesting-duration').value || 12,
                frequency: document.getElementById('vesting-frequency').value,
                customUnlocks: customUnlocksData,
                createdAt: editId ? vestings.find(v => v.id === editId)?.createdAt : new Date().toISOString()
            };

            if (editId) {
                const index = vestings.findIndex(v => v.id === editId);
                if (index !== -1) vestings[index] = vesting;
            } else {
                vestings.push(vesting);
            }

            saveVestingsToStorage();
            renderVestings();
            updateVestingStats();
            checkUpcomingUnlocks();
            renderVestingCalendar();
            cancelVestingEdit();
            this.reset();
            document.getElementById('custom-unlocks-list').innerHTML = '';
        });

        // Cancel vesting edit
        window.cancelVestingEdit = function() {
            document.getElementById('vesting-edit-id').value = '';
            document.getElementById('vesting-form').reset();
            document.getElementById('vesting-form-title').textContent = 'Add Vesting Schedule';
            document.getElementById('vesting-submit-btn').textContent = 'Add Vesting';
            document.getElementById('vesting-cancel-btn').style.display = 'none';
            document.getElementById('custom-unlocks-section').style.display = 'none';
            document.getElementById('custom-unlocks-list').innerHTML = '';
        };

        // Edit vesting
        window.editVesting = function(id) {
            const vesting = vestings.find(v => v.id === id);
            if (!vesting) return;

            document.getElementById('vesting-edit-id').value = vesting.id;
            document.getElementById('vesting-project').value = vesting.project;
            document.getElementById('vesting-token').value = vesting.token;
            document.getElementById('vesting-total').value = vesting.totalTokens;
            document.getElementById('vesting-tge').value = vesting.tgeDate;
            document.getElementById('vesting-tge-percent').value = vesting.tgePercent;
            document.getElementById('vesting-cliff').value = vesting.cliff;
            document.getElementById('vesting-duration').value = vesting.duration;
            document.getElementById('vesting-frequency').value = vesting.frequency;

            if (vesting.frequency === 'custom') {
                document.getElementById('custom-unlocks-section').style.display = 'block';
                const list = document.getElementById('custom-unlocks-list');
                list.innerHTML = '';
                vesting.customUnlocks.forEach((u, i) => {
                    const row = document.createElement('div');
                    row.className = 'unlock-input-row';
                    row.innerHTML = `
                        <input type="date" name="custom-date-${i}" value="${u.date}" required>
                        <input type="number" name="custom-amount-${i}" step="any" value="${u.amount}" required>
                        <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()" style="padding: 8px 12px;"></button>
                    `;
                    list.appendChild(row);
                });
            }

            document.getElementById('vesting-form-title').textContent = 'Edit Vesting Schedule';
            document.getElementById('vesting-submit-btn').textContent = 'Update Vesting';
            document.getElementById('vesting-cancel-btn').style.display = 'inline-block';
            switchMainTab('vesting');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // Delete vesting
        window.deleteVesting = function(id) {
            if (confirm('Are you sure you want to delete this vesting schedule?')) {
                vestings = vestings.filter(v => v.id !== id);
                saveVestingsToStorage();
                renderVestings();
                updateVestingStats();
                renderVestingCalendar();
            }
        };

        // Render vestings
        function renderVestings() {
            const list = document.getElementById('vesting-list');
            const noData = document.getElementById('no-vesting');

            if (vestings.length === 0) {
                noData.style.display = 'block';
                list.innerHTML = '';
                list.appendChild(noData);
                return;
            }

            noData.style.display = 'none';
            const today = new Date();

            list.innerHTML = vestings.map(v => {
                const unlocks = calculateUnlockSchedule(v);
                const totalTokens = parseFloat(v.totalTokens);
                const unlockedTokens = unlocks
                    .filter(u => new Date(u.date) <= today)
                    .reduce((sum, u) => sum + u.amount, 0);
                const progressPercent = (unlockedTokens / totalTokens * 100).toFixed(1);
                const nextUnlock = unlocks.find(u => new Date(u.date) > today);

                return `
                    <div class="vesting-card">
                        <div class="vesting-header">
                            <div class="vesting-info">
                                <h3>${escapeHtml(v.project)} (${v.token})</h3>
                                <p>Total: ${formatNumber(totalTokens)} ${v.token} | TGE: ${formatDate(v.tgeDate)}</p>
                            </div>
                            <div class="vesting-actions">
                                <button class="btn btn-edit" onclick="editVesting('${v.id}')">Edit</button>
                                <button class="btn btn-danger" onclick="deleteVesting('${v.id}')">Delete</button>
                            </div>
                        </div>
                        <div class="vesting-progress-section">
                            <div class="vesting-progress-header">
                                <span>Progress: ${progressPercent}%</span>
                                <span>${formatNumber(unlockedTokens)} / ${formatNumber(totalTokens)} ${v.token}</span>
                            </div>
                            <div class="vesting-progress-bar">
                                <div class="vesting-progress-fill" style="width: ${progressPercent}%"></div>
                            </div>
                        </div>
                        ${nextUnlock ? `
                            <div class="countdown">
                                Next unlock: ${formatDate(nextUnlock.date)} (${formatNumber(nextUnlock.amount)} ${v.token})
                            </div>
                        ` : '<div class="countdown" style="color: var(--accent-green);">Fully vested!</div>'}
                        <div class="vesting-schedule">
                            <h4>Unlock Schedule</h4>
                            <div class="unlock-list">
                                ${unlocks.map(u => {
                                    const isUnlocked = new Date(u.date) <= today;
                                    const isNext = nextUnlock && u.date === nextUnlock.date;
                                    return `
                                        <div class="unlock-item ${isUnlocked ? 'unlocked' : ''} ${isNext ? 'next' : ''}">
                                            <span class="unlock-date">${formatDate(u.date)}</span>
                                            <span class="unlock-amount">${formatNumber(u.amount)} ${v.token}</span>
                                            <span class="unlock-status ${isUnlocked ? 'claimed' : 'pending'}">${isUnlocked ? 'Unlocked' : 'Pending'}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update vesting stats
        function updateVestingStats() {
            const today = new Date();
            let totalTokens = 0;
            let unlockedTokens = 0;

            vestings.forEach(v => {
                const unlocks = calculateUnlockSchedule(v);
                totalTokens += parseFloat(v.totalTokens);
                unlockedTokens += unlocks
                    .filter(u => new Date(u.date) <= today)
                    .reduce((sum, u) => sum + u.amount, 0);
            });

            document.getElementById('total-vesting-tokens').textContent = formatNumber(totalTokens);
            document.getElementById('unlocked-tokens').textContent = formatNumber(unlockedTokens);
            document.getElementById('locked-tokens').textContent = formatNumber(totalTokens - unlockedTokens);
            document.getElementById('active-vestings').textContent = vestings.length;
        }

        // Check upcoming unlocks and show banner
        function checkUpcomingUnlocks() {
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(nextWeek.getDate() + 7);

            const upcoming = [];
            vestings.forEach(v => {
                const unlocks = calculateUnlockSchedule(v);
                unlocks.forEach(u => {
                    const unlockDate = new Date(u.date);
                    if (unlockDate > today && unlockDate <= nextWeek) {
                        upcoming.push({
                            project: v.project,
                            token: v.token,
                            date: u.date,
                            amount: u.amount
                        });
                    }
                });
            });

            const banner = document.getElementById('upcoming-unlocks-banner');
            const list = document.getElementById('upcoming-unlocks-list');

            if (upcoming.length > 0) {
                banner.style.display = 'block';
                list.innerHTML = upcoming.map(u => `
                    <div class="unlock-item upcoming">
                        <span><strong>${u.project}</strong> - ${formatDate(u.date)}</span>
                        <span class="unlock-amount">${formatNumber(u.amount)} ${u.token}</span>
                    </div>
                `).join('');

                // Add notification
                upcoming.forEach(u => {
                    const daysUntil = Math.ceil((new Date(u.date) - today) / (1000 * 60 * 60 * 24));
                    if (daysUntil <= 1 && !localStorage.getItem('notified_' + u.project + '_' + u.date)) {
                        addNotification('Unlock Tomorrow!', `${formatNumber(u.amount)} ${u.token} from ${u.project} unlocks tomorrow!`, 'warning');
                        localStorage.setItem('notified_' + u.project + '_' + u.date, 'true');
                    }
                });
            } else {
                banner.style.display = 'none';
            }
        }

        // Format number helper
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
            return parseFloat(num).toFixed(2);
        }

        // Category filter for analytics
        var selectedCategoryFilter = 'all';

        function updateCategoryFilterChips() {
            const chipsContainer = document.getElementById('crypto-filter-chips');
            if (!chipsContainer) return;

            const categories = [...new Set(payouts.map(p => p.category).filter(c => c))];
            const cryptos = [...new Set(payouts.map(p => p.crypto))];

            let html = `<span class="filter-chip ${selectedCryptoFilter === 'all' ? 'active' : ''}" onclick="filterByCrypto('all')">All Cryptos</span>`;
            cryptos.forEach(c => {
                html += `<span class="filter-chip ${selectedCryptoFilter === c ? 'active' : ''}" onclick="filterByCrypto('${c}')">${c}</span>`;
            });

            if (categories.length > 0) {
                html += `<span style="color: var(--text-secondary); margin: 0 10px;">|</span>`;
                html += `<span class="filter-chip ${selectedCategoryFilter === 'all' ? 'active' : ''}" onclick="filterByCategory('all')">All Categories</span>`;
                categories.forEach(cat => {
                    html += `<span class="filter-chip ${selectedCategoryFilter === cat ? 'active' : ''}" onclick="filterByCategory('${cat}')">${cat}</span>`;
                });
            }

            chipsContainer.innerHTML = html;
        }

        window.filterByCategory = function(category) {
            selectedCategoryFilter = category;
            updateCategoryFilterChips();
            renderTable();
        };

        // ============================================
        // VESTING CALENDAR FUNCTIONALITY
        // ============================================

        var calendarDate = new Date();
        var allUnlocks = [];

        // Initialize calendar
        function initVestingCalendar() {
            renderVestingCalendar();
        }

        // Change calendar month
        window.changeCalendarMonth = function(delta) {
            calendarDate.setMonth(calendarDate.getMonth() + delta);
            renderVestingCalendar();
        };

        // Get all unlocks from all vestings
        function getAllUnlocks() {
            allUnlocks = [];
            vestings.forEach(v => {
                const unlocks = calculateUnlockSchedule(v);
                unlocks.forEach(u => {
                    allUnlocks.push({
                        date: u.date,
                        amount: u.amount,
                        token: v.token,
                        project: v.project,
                        type: u.type
                    });
                });
            });
            return allUnlocks;
        }

        // Render the calendar
        function renderVestingCalendar() {
            const grid = document.getElementById('vesting-calendar-grid');
            if (!grid) return;

            // Get all unlocks
            getAllUnlocks();

            // Create unlock map by date
            const unlockMap = {};
            allUnlocks.forEach(u => {
                if (!unlockMap[u.date]) {
                    unlockMap[u.date] = [];
                }
                unlockMap[u.date].push(u);
            });

            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();

            // Update header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendar-month-year').textContent = `${monthNames[month]} ${year}`;

            // Clear existing days (keep headers)
            const headers = grid.querySelectorAll('.calendar-day-header');
            grid.innerHTML = '';
            headers.forEach(h => grid.appendChild(h.cloneNode(true)));

            // Get first day of month and total days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            // Add previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const dateStr = formatDateStr(year, month - 1, day);
                const dayEl = createCalendarDay(day, dateStr, unlockMap[dateStr], true, todayStr);
                grid.appendChild(dayEl);
            }

            // Add current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = formatDateStr(year, month, day);
                const dayEl = createCalendarDay(day, dateStr, unlockMap[dateStr], false, todayStr);
                grid.appendChild(dayEl);
            }

            // Add next month days to complete the grid
            const totalCells = grid.children.length - 7; // Subtract headers
            const remainingCells = 42 - totalCells; // 6 rows x 7 days
            for (let day = 1; day <= remainingCells; day++) {
                const dateStr = formatDateStr(year, month + 1, day);
                const dayEl = createCalendarDay(day, dateStr, unlockMap[dateStr], true, todayStr);
                grid.appendChild(dayEl);
            }
        }

        // Format date string
        function formatDateStr(year, month, day) {
            const d = new Date(year, month, day);
            return d.toISOString().split('T')[0];
        }

        // Create calendar day element
        function createCalendarDay(day, dateStr, unlocks, isOtherMonth, todayStr) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            dayEl.textContent = day;

            if (isOtherMonth) {
                dayEl.classList.add('other-month');
            }

            if (dateStr === todayStr) {
                dayEl.classList.add('today');
            }

            if (unlocks && unlocks.length > 0) {
                dayEl.classList.add('has-unlock');

                const unlockDate = new Date(dateStr);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                if (unlockDate < today) {
                    dayEl.classList.add('past');
                } else if (unlockDate.getTime() === today.getTime()) {
                    dayEl.classList.add('upcoming');
                } else {
                    dayEl.classList.add('upcoming');
                }

                // Add unlock count badge
                if (unlocks.length > 1) {
                    const countEl = document.createElement('span');
                    countEl.className = 'unlock-count';
                    countEl.textContent = unlocks.length;
                    dayEl.appendChild(countEl);
                } else {
                    const dotEl = document.createElement('span');
                    dotEl.className = 'unlock-dot';
                    dayEl.appendChild(dotEl);
                }

                // Add click event to show tooltip
                dayEl.addEventListener('click', (e) => showCalendarTooltip(e, dateStr, unlocks));
                dayEl.addEventListener('mouseleave', hideCalendarTooltip);
            }

            return dayEl;
        }

        // Show calendar tooltip
        function showCalendarTooltip(e, dateStr, unlocks) {
            const tooltip = document.getElementById('calendar-tooltip');
            const date = new Date(dateStr + 'T00:00:00');
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };

            document.getElementById('tooltip-date').textContent = date.toLocaleDateString('en-US', options);

            const unlocksHtml = unlocks.map(u => `
                <div class="calendar-tooltip-item">
                    <span class="calendar-tooltip-project">${escapeHtml(u.project)}</span>
                    <span class="calendar-tooltip-amount">${formatNumber(u.amount)} ${u.token}</span>
                </div>
            `).join('');

            document.getElementById('tooltip-unlocks').innerHTML = unlocksHtml;

            // Position tooltip
            const rect = e.target.getBoundingClientRect();
            tooltip.style.left = Math.min(rect.right + 10, window.innerWidth - 280) + 'px';
            tooltip.style.top = Math.max(rect.top - 20, 10) + 'px';
            tooltip.classList.add('visible');
        }

        // Hide calendar tooltip
        function hideCalendarTooltip() {
            document.getElementById('calendar-tooltip').classList.remove('visible');
        }

        // Close tooltip when clicking outside
        document.addEventListener('click', (e) => {
            const tooltip = document.getElementById('calendar-tooltip');
            if (tooltip && !e.target.closest('.calendar-day') && !e.target.closest('.calendar-tooltip')) {
                tooltip.classList.remove('visible');
            }
        });

        // Update calendar when vestings change
        function updateVestingCalendar() {
            renderVestingCalendar();
        }
    </script>
</body>
</html>
