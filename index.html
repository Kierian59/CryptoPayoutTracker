<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Payout Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: rgba(255, 255, 255, 0.05);
            --bg-card-hover: rgba(255, 255, 255, 0.08);
            --text-primary: #e0e0e0;
            --text-secondary: #aaa;
            --accent: #00d9ff;
            --accent-green: #2ed573;
            --accent-red: #ff4757;
            --accent-orange: #ffa502;
            --border-color: rgba(255, 255, 255, 0.1);
            --sidebar-width: 260px;
            --sidebar-collapsed: 70px;
        }

        [data-theme="light"] {
            --bg-primary: #f0f2f5;
            --bg-secondary: #ffffff;
            --bg-card: rgba(0, 0, 0, 0.03);
            --bg-card-hover: rgba(0, 0, 0, 0.06);
            --text-primary: #1a1a2e;
            --text-secondary: #666;
            --border-color: rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        body.has-sidebar {
            padding-left: calc(var(--sidebar-width) + 20px);
        }

        body.sidebar-collapsed {
            padding-left: calc(var(--sidebar-collapsed) + 20px);
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: var(--sidebar-width);
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid var(--border-color);
            z-index: 1000;
            transition: width 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent), var(--accent-green));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
            flex-shrink: 0;
        }

        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent);
            white-space: nowrap;
            overflow: hidden;
            transition: opacity 0.3s;
        }

        .sidebar.collapsed .sidebar-title {
            opacity: 0;
            width: 0;
        }

        .sidebar-toggle {
            position: absolute;
            right: -12px;
            top: 28px;
            width: 24px;
            height: 24px;
            background: var(--accent);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-size: 12px;
            transition: transform 0.3s;
            z-index: 1001;
        }

        .sidebar.collapsed .sidebar-toggle {
            transform: rotate(180deg);
        }

        .sidebar-nav {
            flex: 1;
            padding: 20px 10px;
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-radius: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 5px;
            text-decoration: none;
        }

        .nav-item:hover {
            background: rgba(0, 217, 255, 0.1);
            color: var(--accent);
        }

        .nav-item.active {
            background: rgba(0, 217, 255, 0.2);
            color: var(--accent);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .nav-label {
            white-space: nowrap;
            overflow: hidden;
            transition: opacity 0.3s;
        }

        .sidebar.collapsed .nav-label {
            opacity: 0;
            width: 0;
        }

        .sidebar-footer {
            padding: 15px;
            border-top: 1px solid var(--border-color);
        }

        /* Avatar Badge */
        .avatar-badge {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #0099cc);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            color: #000;
            flex-shrink: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-details {
            overflow: hidden;
            transition: opacity 0.3s;
        }

        .sidebar.collapsed .user-details {
            opacity: 0;
            width: 0;
        }

        .user-name {
            font-size: 0.9rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-role {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            margin-top: 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .theme-switch {
            width: 44px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            position: relative;
            transition: background 0.3s;
        }

        .theme-switch::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: transform 0.3s;
        }

        [data-theme="light"] .theme-switch::after {
            transform: translateX(20px);
        }

        .theme-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            transition: opacity 0.3s;
        }

        .sidebar.collapsed .theme-label,
        .sidebar.collapsed .theme-switch {
            display: none;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-green));
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 217, 255, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: #000;
            transition: all 0.3s;
            z-index: 999;
        }

        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 30px rgba(0, 217, 255, 0.6);
        }

        .fab.active {
            transform: rotate(45deg);
            background: var(--accent-red);
        }

        /* Notification Bell */
        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .notification-bell:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .notification-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 18px;
            height: 18px;
            background: var(--accent-red);
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
        }

        /* Notification Panel */
        .notification-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-left: 1px solid var(--border-color);
            z-index: 1001;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .notification-panel.open {
            right: 0;
        }

        .notification-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h3 {
            color: var(--accent);
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 24px;
        }

        .notification-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .notification-item {
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 3px solid var(--accent);
        }

        .notification-item.milestone {
            border-left-color: var(--accent-green);
        }

        .notification-item.warning {
            border-left-color: var(--accent-orange);
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .notification-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .notification-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #00d9ff;
            font-size: 2rem;
        }

        /* Glassmorphism Cards */
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            animation: fadeInUp 0.5s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
            border-color: rgba(0, 217, 255, 0.2);
        }

        .card h2 {
            margin-bottom: 20px;
            color: var(--accent);
            font-size: 1.2rem;
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Quick Filter Chips */
        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .filter-chip {
            padding: 6px 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .filter-chip.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #000;
        }

        /* Trend Indicators */
        .trend-up {
            color: var(--accent-green);
        }

        .trend-down {
            color: var(--accent-red);
        }

        .trend-indicator {
            font-size: 0.85rem;
            margin-left: 8px;
        }

        /* Sparkline Container */
        .sparkline-container {
            height: 30px;
            margin-top: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .stat-box:hover .sparkline-container {
            opacity: 1;
        }

        /* Goal Progress */
        .goal-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .goal-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .goal-value {
            font-size: 0.9rem;
            color: var(--accent);
        }

        .goal-progress {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .goal-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-green));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .goal-progress-bar.yearly {
            background: linear-gradient(90deg, #f39c12, #f1c40f);
        }

        /* Heat Map Calendar */
        .heatmap-container {
            overflow-x: auto;
            padding: 10px 0;
        }

        .heatmap {
            display: flex;
            gap: 3px;
        }

        .heatmap-week {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .heatmap-day {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.2s;
        }

        .heatmap-day:hover {
            transform: scale(1.3);
        }

        .heatmap-day.level-1 { background: rgba(0, 217, 255, 0.2); }
        .heatmap-day.level-2 { background: rgba(0, 217, 255, 0.4); }
        .heatmap-day.level-3 { background: rgba(0, 217, 255, 0.6); }
        .heatmap-day.level-4 { background: rgba(0, 217, 255, 0.8); }
        .heatmap-day.level-5 { background: var(--accent); }

        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Comparison Mode */
        .comparison-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .comparison-select {
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .comparison-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Onboarding Tour */
        .tour-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
        }

        .tour-overlay.active {
            display: block;
        }

        .tour-highlight {
            position: absolute;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            z-index: 2001;
        }

        .tour-tooltip {
            position: absolute;
            background: var(--bg-secondary);
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 20px;
            max-width: 320px;
            z-index: 2002;
            animation: fadeIn 0.3s ease;
        }

        .tour-tooltip h4 {
            color: var(--accent);
            margin-bottom: 10px;
        }

        .tour-tooltip p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .tour-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .tour-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tour-skip {
            background: none;
            border: none;
            color: var(--text-secondary);
        }

        .tour-next {
            background: var(--accent);
            border: none;
            color: #000;
        }

        .tour-dots {
            display: flex;
            gap: 6px;
            justify-content: center;
            margin-top: 15px;
        }

        .tour-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
        }

        .tour-dot.active {
            background: var(--accent);
        }

        /* Tab Navigation */
        .main-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 25px;
            background: rgba(0, 0, 0, 0.2);
            padding: 5px;
            border-radius: 12px;
        }

        .main-tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .main-tab:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .main-tab.active {
            background: var(--accent);
            color: #000;
            font-weight: 600;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        /* Dashboard Overview */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .dashboard-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .dashboard-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .dashboard-card-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .dashboard-card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
        }

        .dashboard-card-value.green {
            color: var(--accent-green);
        }

        .mini-chart {
            height: 60px;
            margin-top: 10px;
        }

        .recent-activity {
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: rgba(0, 217, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
        }

        .activity-details {
            flex: 1;
        }

        .activity-title {
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .activity-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .activity-amount {
            font-weight: 600;
            color: var(--accent-green);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 6px;
            font-size: 0.9rem;
            color: #aaa;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #00d9ff;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d9ff, #0099cc);
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 217, 255, 0.4);
        }

        .btn-danger {
            background: #ff4757;
            color: #fff;
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .btn-danger:hover {
            background: #ff6b7a;
        }

        .btn-edit {
            background: #ffa502;
            color: #000;
            padding: 6px 12px;
            font-size: 0.85rem;
            margin-right: 5px;
        }

        .btn-edit:hover {
            background: #ffb732;
        }

        .btn-export {
            background: #2ed573;
            color: #000;
            margin-left: 10px;
        }

        .btn-export:hover {
            background: #7bed9f;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .form-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(0, 217, 255, 0.1);
            color: #00d9ff;
            font-weight: 600;
            cursor: pointer;
        }

        th:hover {
            background: rgba(0, 217, 255, 0.2);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: rgba(0, 217, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .stat-box:hover {
            background: rgba(0, 217, 255, 0.15);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 217, 255, 0.2);
        }

        .stat-box .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .stat-box .value.usd {
            color: var(--accent-green);
        }

        .stat-box .label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .stat-box .trend {
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .stat-box .trend.up {
            background: rgba(46, 213, 115, 0.2);
            color: var(--accent-green);
        }

        .stat-box .trend.down {
            background: rgba(255, 71, 87, 0.2);
            color: var(--accent-red);
        }

        .currency-toggle-btn {
            background: rgba(0, 217, 255, 0.2);
            border: 1px solid rgba(0, 217, 255, 0.4);
            color: #00d9ff;
            border-radius: 4px;
            padding: 2px 8px;
            margin-left: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .currency-toggle-btn:hover {
            background: rgba(0, 217, 255, 0.4);
            transform: scale(1.05);
        }

        .eur-preview {
            font-size: 0.85rem;
            color: #2ed573;
            margin-top: 6px;
            min-height: 20px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .search-box {
            padding: 10px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            width: 250px;
        }

        .search-box:focus {
            outline: none;
            border-color: #00d9ff;
        }

        /* Month Tabs */
        .month-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .month-tab {
            padding: 8px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            background: transparent;
            color: #aaa;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .month-tab:hover {
            border-color: #00d9ff;
            color: #00d9ff;
        }

        .month-tab.active {
            background: #00d9ff;
            border-color: #00d9ff;
            color: #000;
            font-weight: 600;
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .chart-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 20px;
            position: relative;
            height: 320px;
        }

        .chart-container h3 {
            color: #00d9ff;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .chart-wrapper {
            position: relative;
            height: calc(100% - 30px);
        }

        .usd-value {
            color: #2ed573;
            font-weight: 500;
        }

        /* Monthly totals list */
        .monthly-totals-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            max-height: calc(100% - 30px);
        }

        .monthly-total-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border-left: 3px solid #2ed573;
        }

        .monthly-total-item.active {
            background: rgba(46, 213, 115, 0.15);
            border-left-color: #00d9ff;
        }

        .monthly-total-item .month-name {
            color: #e0e0e0;
            font-weight: 500;
        }

        .monthly-total-item .month-amount {
            color: #2ed573;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .monthly-total-display {
            height: auto;
            min-height: 200px;
            max-height: 320px;
        }

        /* Auth styles */
        .auth-container {
            max-width: 500px;
            margin: 80px auto;
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 50px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .auth-card h2 {
            text-align: center;
            color: #00d9ff;
            margin-bottom: 30px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .auth-tab.active {
            color: #00d9ff;
            border-bottom: 2px solid #00d9ff;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-form input {
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 1.1rem;
        }

        .auth-form input:focus {
            outline: none;
            border-color: #00d9ff;
        }

        .auth-form .btn {
            margin-top: 15px;
            padding: 16px 28px;
            font-size: 1.1rem;
        }

        .auth-error {
            color: #ff4757;
            font-size: 0.9rem;
            text-align: center;
            padding: 10px;
            background: rgba(255, 71, 87, 0.1);
            border-radius: 8px;
            display: none;
        }

        .auth-divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: #666;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
        }

        .auth-divider span {
            padding: 0 15px;
            font-size: 0.85rem;
        }

        .btn-google {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 16px 28px;
            background: #fff;
            color: #333;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-google:hover {
            background: #f1f1f1;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
        }

        .auth-success {
            color: #2ed573;
            font-size: 0.9rem;
            text-align: center;
            padding: 10px;
            background: rgba(46, 213, 115, 0.1);
            border-radius: 8px;
            display: none;
        }

        .user-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .user-email {
            color: #aaa;
            font-size: 0.9rem;
        }

        .btn-logout {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
            padding: 8px 16px;
            font-size: 0.85rem;
            border: 1px solid rgba(255, 71, 87, 0.3);
        }

        .btn-logout:hover {
            background: rgba(255, 71, 87, 0.3);
        }

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #aaa;
        }

        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(0, 217, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00d9ff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 900px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            body.has-sidebar {
                padding-left: 20px;
            }

            body.sidebar-collapsed {
                padding-left: 20px;
            }

            .mobile-menu-btn {
                display: flex !important;
            }
        }

        @media (max-width: 600px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .header-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                width: 100%;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 250px;
            }

            .auth-container {
                margin: 50px auto;
                padding: 0 15px;
            }

            .auth-card {
                padding: 25px;
            }

            .main-tabs {
                flex-direction: column;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .fab {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 24px;
            }

            .notification-panel {
                width: 100%;
            }
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            width: 44px;
            height: 44px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 999;
            color: var(--accent);
        }

        /* Draggable widgets */
        .draggable {
            cursor: move;
        }

        .draggable.dragging {
            opacity: 0.5;
        }

        .drag-over {
            border: 2px dashed var(--accent);
        }

        /* Modal for FAB form */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1500;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: fadeInUp 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: var(--accent);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
        }

        /* Category Badges */
        .category-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .category-badge.airdrop {
            background: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
        }

        .category-badge.paid-deal {
            background: rgba(46, 213, 115, 0.2);
            color: var(--accent-green);
        }

        .category-badge.staking {
            background: rgba(0, 217, 255, 0.2);
            color: var(--accent);
        }

        .category-badge.mining {
            background: rgba(255, 165, 2, 0.2);
            color: var(--accent-orange);
        }

        .category-badge.trading {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        .category-badge.other {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
        }

        /* Vesting Tracker Styles */
        .vesting-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .vesting-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        @media (max-width: 768px) {
            .vesting-list {
                grid-template-columns: 1fr;
            }
        }

        .vesting-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 16px;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
        }

        .vesting-card:hover {
            border-color: var(--accent);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 217, 255, 0.15);
        }

        .vesting-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .vesting-info h3 {
            color: var(--accent);
            font-size: 1rem;
            margin-bottom: 3px;
        }

        .vesting-info p {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .vesting-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .vesting-actions .btn {
            padding: 4px 8px;
            font-size: 0.75rem;
        }

        .vesting-progress-section {
            margin-bottom: 12px;
        }

        .vesting-progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.8rem;
        }

        .vesting-progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .vesting-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-green));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .vesting-schedule {
            border-top: 1px solid var(--border-color);
            padding-top: 12px;
            margin-top: auto;
        }

        .vesting-schedule h4 {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .vesting-card-compact {
            cursor: pointer;
        }

        .vesting-card-details {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .vesting-card-details.expanded {
            display: block;
        }

        .unlock-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .unlock-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .unlock-item.unlocked {
            opacity: 0.6;
            text-decoration: line-through;
        }

        .unlock-item.upcoming {
            border-left: 3px solid var(--accent-green);
            background: rgba(46, 213, 115, 0.1);
        }

        .unlock-item.next {
            border-left: 3px solid var(--accent);
            background: rgba(0, 217, 255, 0.1);
        }

        .unlock-date {
            color: var(--text-secondary);
        }

        .unlock-amount {
            color: var(--accent-green);
            font-weight: 600;
        }

        .unlock-status {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .unlock-status.claimed {
            background: rgba(46, 213, 115, 0.2);
            color: var(--accent-green);
        }

        .unlock-status.pending {
            background: rgba(255, 165, 2, 0.2);
            color: var(--accent-orange);
        }

        .unlock-item.is-claimed {
            background: rgba(46, 213, 115, 0.05);
            border-left: 2px solid var(--accent-green);
            padding-left: 8px;
        }

        .unlock-item.unlocked:not(.is-claimed) {
            background: rgba(0, 217, 255, 0.05);
            border-left: 2px solid var(--accent);
            padding-left: 8px;
        }

        .vesting-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .vesting-stat {
            background: rgba(0, 217, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .vesting-stat .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent);
        }

        .vesting-stat .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .add-unlock-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            padding: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        .add-unlock-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .unlock-input-row {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .unlock-input-row input {
            flex: 1;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .unlock-input-row input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .upcoming-unlocks {
            background: linear-gradient(135deg, rgba(0, 217, 255, 0.1), rgba(46, 213, 115, 0.1));
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .upcoming-unlocks h3 {
            color: var(--accent);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .countdown {
            font-size: 0.85rem;
            color: var(--accent-orange);
            margin-top: 5px;
        }

        /* Vesting Calendar Styles */
        .vesting-calendar {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .calendar-header h3 {
            color: var(--accent);
            font-size: 0.95rem;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .calendar-nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 6px;
            padding: 5px 10px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
        }

        .calendar-nav-btn:hover {
            background: var(--accent);
            color: #000;
        }

        .calendar-month-year {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            min-width: 120px;
            text-align: center;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
        }

        .calendar-day-header {
            text-align: center;
            padding: 6px 3px;
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .calendar-day {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.02);
            cursor: default;
            transition: all 0.2s;
            position: relative;
            min-height: 60px;
            padding: 6px 4px;
            gap: 3px;
        }

        .calendar-day .day-number {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            border: 1px solid var(--accent);
            color: var(--accent);
            font-weight: 600;
        }

        .calendar-day.has-unlock {
            background: rgba(46, 213, 115, 0.2);
            color: var(--accent-green);
            cursor: pointer;
            font-weight: 600;
        }

        .calendar-day.has-unlock:hover {
            background: rgba(46, 213, 115, 0.3);
            transform: scale(1.02);
        }

        .calendar-day.has-unlock.past {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            opacity: 0.6;
        }

        .calendar-day.has-unlock.upcoming {
            background: rgba(0, 217, 255, 0.2);
            color: var(--accent);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0, 217, 255, 0.4); }
            50% { box-shadow: 0 0 0 5px rgba(0, 217, 255, 0); }
        }

        .calendar-day .unlock-dot {
            display: none;
        }

        .calendar-day .unlock-count {
            display: none;
        }

        .calendar-day .unlock-badge {
            font-size: 0.6rem;
            background: linear-gradient(135deg, var(--accent-green), #1abc9c);
            color: #000;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            text-align: center;
            box-shadow: 0 2px 4px rgba(46, 213, 115, 0.3);
        }

        .calendar-day .event-badge {
            font-size: 0.6rem;
            background: linear-gradient(135deg, #ff9f43, #ee5a24);
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            text-align: center;
            box-shadow: 0 2px 4px rgba(255, 159, 67, 0.3);
        }

        .calendar-day.has-unlock .unlock-badge,
        .calendar-day.has-event .event-badge {
            animation: badgePop 0.3s ease;
        }

        @keyframes badgePop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Calendar Tooltip */
        .calendar-tooltip {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            min-width: 250px;
            max-width: 320px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: none;
        }

        .calendar-tooltip.visible {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        .calendar-tooltip h4 {
            color: var(--accent);
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .calendar-tooltip-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .calendar-tooltip-item:last-child {
            border-bottom: none;
        }

        .calendar-tooltip-project {
            font-weight: 500;
            color: var(--text-primary);
        }

        .calendar-tooltip-amount {
            color: var(--accent-green);
            font-weight: 600;
        }

        .calendar-legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .calendar-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .calendar-legend-dot {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .calendar-legend-dot.past {
            background: rgba(255, 255, 255, 0.1);
        }

        .calendar-legend-dot.upcoming {
            background: linear-gradient(135deg, var(--accent-green), #1abc9c);
        }

        .calendar-legend-dot.today {
            border: 2px solid var(--accent);
            background: transparent;
        }

        .calendar-legend-dot.event {
            background: linear-gradient(135deg, #ff9f43, #ee5a24);
        }

        /* Event styles on calendar */
        .calendar-day.has-event {
            position: relative;
            cursor: pointer;
        }

        .calendar-day.has-event:not(.has-unlock) {
            background: rgba(255, 159, 67, 0.15);
        }

        .calendar-day.has-event:hover {
            background: rgba(255, 159, 67, 0.25);
            transform: scale(1.02);
        }

        .calendar-day.has-event.has-unlock {
            background: linear-gradient(135deg, rgba(46, 213, 115, 0.2), rgba(255, 159, 67, 0.2));
        }

        .event-dot {
            display: none;
        }

        /* Event card styles */
        .event-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            border-left: 4px solid #ff9f43;
        }

        .event-item-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .event-item-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .event-item-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            gap: 10px;
        }

        .event-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            background: rgba(255, 159, 67, 0.2);
            color: #ff9f43;
        }

        .event-item-actions {
            display: flex;
            gap: 8px;
        }

        .event-item-actions button {
            padding: 5px 10px;
            font-size: 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-secondary);
        }

        .event-item-actions button:hover {
            background: var(--border-color);
        }

        .event-item-actions button.delete:hover {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
            border-color: #ff4757;
        }

        /* Campaign Styles */
        .campaign-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .campaign-stat {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .campaign-stat .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent);
        }

        .campaign-stat .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .campaigns-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .campaign-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid var(--accent);
        }

        .campaign-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .campaign-info h3 {
            margin: 0 0 5px 0;
            color: var(--text-primary);
            font-size: 1.2rem;
        }

        .campaign-rewards {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .campaign-reward-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .campaign-reward-badge.tokens {
            background: rgba(0, 217, 255, 0.15);
            color: var(--accent);
        }

        .campaign-reward-badge.usd {
            background: rgba(46, 213, 115, 0.15);
            color: var(--accent-green);
        }

        .campaign-progress {
            margin: 15px 0;
        }

        .campaign-progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .campaign-progress-bar {
            height: 10px;
            background: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
        }

        .campaign-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-green));
            border-radius: 5px;
            transition: width 0.3s ease;
        }

        .campaign-posts-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .campaign-posts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .campaign-posts-header h4 {
            margin: 0;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .campaign-posts-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .campaign-post-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .campaign-post-item a {
            color: var(--accent);
            text-decoration: none;
            font-size: 0.85rem;
            max-width: 70%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .campaign-post-item a:hover {
            text-decoration: underline;
        }

        .campaign-post-item .post-date {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .campaign-post-item .delete-post {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 2px 6px;
            font-size: 0.9rem;
        }

        .campaign-post-item .delete-post:hover {
            color: #ff4757;
        }

        .add-post-form {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .add-post-form input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-color);
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .add-post-form button {
            padding: 8px 15px;
            border-radius: 6px;
            border: none;
            background: var(--accent);
            color: #000;
            font-weight: 500;
            cursor: pointer;
        }

        .add-post-form button:hover {
            opacity: 0.9;
        }

        .campaign-actions {
            display: flex;
            gap: 8px;
        }

        .campaign-actions button {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-secondary);
        }

        .campaign-actions button:hover {
            background: var(--border-color);
        }

        .campaign-actions button.delete:hover {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
            border-color: #ff4757;
        }

        /* Settings Styles */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .settings-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-section h3 {
            color: var(--accent);
            margin-bottom: 20px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .setting-label span {
            color: var(--text-primary);
            font-weight: 500;
        }

        .setting-label small {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .setting-control {
            min-width: 140px;
        }

        .setting-control select,
        .setting-control input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .setting-control select:focus,
        .setting-control input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn-danger {
            background: var(--accent-red);
            color: #fff;
        }

        .btn-danger:hover {
            background: #ff6b7a;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .settings-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .settings-actions .btn {
            flex: 1;
        }

        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .confirm-dialog.active {
            opacity: 1;
            visibility: visible;
        }

        .confirm-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            text-align: center;
        }

        .confirm-content h3 {
            color: var(--accent-red);
            margin-bottom: 15px;
        }

        .confirm-content p {
            color: var(--text-secondary);
            margin-bottom: 25px;
        }

        .confirm-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--accent-green);
            color: #000;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: 500;
            z-index: 3001;
            opacity: 0;
            transition: all 0.3s;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: var(--accent-red);
            color: #fff;
        }
    </style>
</head>
<body>
    <!-- Auth Section -->
    <div id="auth-section" class="auth-container">
        <h1>CRYPTO PAYOUT TRACKER</h1>
        <p style="text-align: center; margin-top: -20px; margin-bottom: 25px; color: #aaa; font-size: 0.9rem;">Made by <a href="https://x.com/KierianV" target="_blank" style="color: #00d9ff; text-decoration: none;">Kierian</a></p>

        <div class="auth-card">
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login')">Login</button>
                <button class="auth-tab" onclick="showAuthTab('signup')">Sign Up</button>
            </div>

            <div id="auth-error" class="auth-error"></div>
            <div id="auth-success" class="auth-success"></div>

            <!-- Login Form -->
            <form id="login-form" class="auth-form" onsubmit="handleLogin(event)">
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>

            <div class="auth-divider">
                <span>or</span>
            </div>

            <button class="btn btn-google" onclick="handleGoogleLogin()">
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"/>
                    <path d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 009 18z" fill="#34A853"/>
                    <path d="M3.964 10.71A5.41 5.41 0 013.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 000 9c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/>
                    <path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 00.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" fill="#EA4335"/>
                </svg>
                Continue with Google
            </button>

            <!-- Signup Form -->
            <form id="signup-form" class="auth-form hidden" onsubmit="handleSignup(event)">
                <input type="email" id="signup-email" placeholder="Email" required>
                <input type="password" id="signup-password" placeholder="Password (min 6 characters)" required minlength="6">
                <input type="password" id="signup-confirm" placeholder="Confirm Password" required minlength="6">
                <button type="submit" class="btn btn-primary">Create Account</button>
            </form>
        </div>
    </div>

    <!-- Sidebar -->
    <nav class="sidebar hidden" id="sidebar">
        <button class="sidebar-toggle" onclick="toggleSidebar()">&#10094;</button>
        <div class="sidebar-header">
            <div class="sidebar-logo">CT</div>
            <span class="sidebar-title">Crypto Tracker</span>
        </div>
        <div class="sidebar-nav">
            <div class="nav-item active" data-tab="dashboard" onclick="switchMainTab('dashboard')">
                <span class="nav-icon">&#9783;</span>
                <span class="nav-label">Dashboard</span>
            </div>
            <div class="nav-item" data-tab="add-payout" onclick="switchMainTab('add-payout')">
                <span class="nav-icon">&#43;</span>
                <span class="nav-label">Add Payout</span>
            </div>
            <div class="nav-item" data-tab="analytics" onclick="switchMainTab('analytics')">
                <span class="nav-icon">&#9906;</span>
                <span class="nav-label">Analytics</span>
            </div>
            <div class="nav-item" data-tab="history" onclick="switchMainTab('history')">
                <span class="nav-icon">&#9776;</span>
                <span class="nav-label">History</span>
            </div>
            <div class="nav-item" data-tab="vesting" onclick="switchMainTab('vesting')">
                <span class="nav-icon">&#128197;</span>
                <span class="nav-label">Events & Vesting</span>
            </div>
            <div class="nav-item" data-tab="campaigns" onclick="switchMainTab('campaigns')">
                <span class="nav-icon">&#128230;</span>
                <span class="nav-label">Campaigns</span>
            </div>
            <div class="nav-item" data-tab="settings" onclick="switchMainTab('settings')">
                <span class="nav-icon">&#9881;</span>
                <span class="nav-label">Settings</span>
            </div>
            <div class="notification-bell" onclick="toggleNotifications()">
                <span class="nav-icon">&#128276;</span>
                <span class="nav-label">Notifications</span>
                <span class="notification-badge" id="notification-count">0</span>
            </div>
        </div>
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="avatar-badge" id="user-avatar">U</div>
                <div class="user-details">
                    <div class="user-name" id="user-name">User</div>
                    <div class="user-role">Tracker</div>
                </div>
            </div>
            <div class="theme-toggle" onclick="toggleTheme()">
                <span class="nav-icon">&#9790;</span>
                <span class="theme-label">Dark Mode</span>
                <div class="theme-switch"></div>
            </div>
        </div>
    </nav>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleMobileSidebar()">&#9776;</button>

    <!-- Notification Panel -->
    <div class="notification-panel" id="notification-panel">
        <div class="notification-header">
            <h3>Notifications</h3>
            <button class="notification-close" onclick="toggleNotifications()">&times;</button>
        </div>
        <div class="notification-list" id="notification-list">
            <!-- Notifications will be populated dynamically -->
        </div>
    </div>

    <!-- FAB Button -->
    <button class="fab hidden" id="fab" onclick="openQuickAdd()">+</button>

    <!-- Quick Add Modal -->
    <div class="modal-overlay" id="quick-add-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Quick Add Payout</h3>
                <button class="modal-close" onclick="closeQuickAdd()">&times;</button>
            </div>
            <form id="quick-payout-form">
                <div class="form-group">
                    <label for="quick-company">Project</label>
                    <input type="text" id="quick-company" required placeholder="e.g., Coinbase">
                </div>
                <div class="form-group">
                    <label for="quick-date">Date</label>
                    <input type="date" id="quick-date" required>
                </div>
                <div class="form-group">
                    <label for="quick-amount">Amount of Tokens</label>
                    <input type="number" id="quick-amount" step="any" required placeholder="0.00">
                </div>
                <div class="form-group">
                    <label for="quick-crypto">Cryptocurrency</label>
                    <input type="text" id="quick-crypto" required placeholder="e.g., BTC, ETH">
                </div>
                <div class="form-group">
                    <label for="quick-usd">Amount Sold (USD)</label>
                    <input type="number" id="quick-usd" step="any" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label for="quick-category">Category</label>
                    <select id="quick-category">
                        <option value="">Select category...</option>
                        <option value="Airdrop">Airdrop</option>
                        <option value="Paid Deal">Paid Deal</option>
                        <option value="Staking">Staking</option>
                        <option value="Mining">Mining</option>
                        <option value="Trading">Trading</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Add Payout</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Onboarding Tour -->
    <div class="tour-overlay" id="tour-overlay">
        <div class="tour-tooltip" id="tour-tooltip">
            <h4 id="tour-title">Welcome!</h4>
            <p id="tour-text">Let's take a quick tour of your new dashboard.</p>
            <div class="tour-dots" id="tour-dots"></div>
            <div class="tour-actions">
                <button class="tour-btn tour-skip" onclick="endTour()">Skip Tour</button>
                <button class="tour-btn tour-next" onclick="nextTourStep()">Next</button>
            </div>
        </div>
    </div>

    <!-- Main App Section -->
    <div id="app-section" class="container hidden">
        <!-- Main Tabs -->
        <div class="main-tabs">
            <button class="main-tab active" data-tab="dashboard" onclick="switchMainTab('dashboard')">Dashboard</button>
            <button class="main-tab" data-tab="add-payout" onclick="switchMainTab('add-payout')">Add Payout</button>
            <button class="main-tab" data-tab="analytics" onclick="switchMainTab('analytics')">Analytics</button>
            <button class="main-tab" data-tab="history" onclick="switchMainTab('history')">History</button>
            <button class="main-tab" data-tab="vesting" onclick="switchMainTab('vesting')">Events & Vesting</button>
            <button class="main-tab" data-tab="campaigns" onclick="switchMainTab('campaigns')">Campaigns</button>
            <button class="main-tab" data-tab="settings" onclick="switchMainTab('settings')">Settings</button>
        </div>

        <!-- Dashboard Tab -->
        <div class="tab-content active" id="tab-dashboard">
            <div class="dashboard-grid" id="dashboard-widgets">
                <!-- Total Payouts Widget -->
                <div class="dashboard-card draggable" draggable="true" data-widget="payouts">
                    <div class="dashboard-card-header">
                        <span class="dashboard-card-title">Total Payouts</span>
                        <span class="trend up" id="payouts-trend">+0%</span>
                    </div>
                    <div class="dashboard-card-value" id="dash-total-payouts">0</div>
                    <div class="mini-chart">
                        <canvas id="mini-payouts-chart"></canvas>
                    </div>
                </div>

                <!-- Total Revenue Widget -->
                <div class="dashboard-card draggable" draggable="true" data-widget="revenue">
                    <div class="dashboard-card-header">
                        <span class="dashboard-card-title">Total Revenue</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button id="dash-currency-toggle" class="currency-toggle-btn" onclick="toggleDashboardCurrency()" title="Switch to EUR"></button>
                            <span class="trend up" id="revenue-trend">+0%</span>
                        </div>
                    </div>
                    <div class="dashboard-card-value green" id="dash-total-revenue">$0</div>
                    <div class="mini-chart">
                        <canvas id="mini-revenue-chart"></canvas>
                    </div>
                </div>

                <!-- Projects Widget -->
                <div class="dashboard-card draggable" draggable="true" data-widget="projects">
                    <div class="dashboard-card-header">
                        <span class="dashboard-card-title">Active Projects</span>
                    </div>
                    <div class="dashboard-card-value" id="dash-projects">0</div>
                    <div class="filter-chips" id="project-chips">
                        <!-- Project chips populated dynamically -->
                    </div>
                </div>

                <!-- Recent Activity Widget -->
                <div class="dashboard-card draggable" draggable="true" data-widget="activity">
                    <div class="dashboard-card-header">
                        <span class="dashboard-card-title">Recent Activity</span>
                    </div>
                    <div class="recent-activity" id="recent-activity">
                        <!-- Activity items populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Heat Map Calendar -->
            <div class="card">
                <h2>Activity Calendar</h2>
                <div class="heatmap-container">
                    <div class="heatmap" id="heatmap">
                        <!-- Heatmap populated dynamically -->
                    </div>
                </div>
                <div class="heatmap-legend">
                    <span>Less</span>
                    <div class="heatmap-day"></div>
                    <div class="heatmap-day level-1"></div>
                    <div class="heatmap-day level-2"></div>
                    <div class="heatmap-day level-3"></div>
                    <div class="heatmap-day level-4"></div>
                    <div class="heatmap-day level-5"></div>
                    <span>More</span>
                </div>
            </div>

            <!-- Goal Tracking -->
            <div class="card">
                <h2>Monthly Goals</h2>
                <div class="goal-section" style="margin-top: 0; padding-top: 0; border-top: none;">
                    <div class="goal-header">
                        <span class="goal-title">Revenue Goal</span>
                        <span class="goal-value" id="goal-progress-text">$0 / $10,000</span>
                    </div>
                    <div class="goal-progress">
                        <div class="goal-progress-bar" id="goal-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="goal-section">
                    <div class="goal-header">
                        <span class="goal-title">Payouts Goal</span>
                        <span class="goal-value" id="payouts-goal-text">0 / 50</span>
                    </div>
                    <div class="goal-progress">
                        <div class="goal-progress-bar" id="payouts-goal-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Yearly Goal Tracking -->
            <div class="card">
                <h2>Yearly Goal <span id="yearly-goal-year" style="font-size: 0.9rem; color: var(--text-secondary);"></span></h2>
                <div class="goal-section" style="margin-top: 0; padding-top: 0; border-top: none;">
                    <div class="goal-header">
                        <span class="goal-title">Earnings Goal</span>
                        <span class="goal-value" id="yearly-goal-text">$0 / $100,000</span>
                    </div>
                    <div class="goal-progress">
                        <div class="goal-progress-bar yearly" id="yearly-goal-bar" style="width: 0%"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.85rem; color: var(--text-secondary);">
                        <span id="yearly-goal-percent">0% complete</span>
                        <span id="yearly-goal-remaining">$100,000 remaining</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Payout Tab -->
        <div class="tab-content" id="tab-add-payout">

        <!-- Entry Form -->
        <div class="card">
            <h2 id="form-title">Add New Payout</h2>
            <form id="payout-form">
                <input type="hidden" id="edit-id">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="company">Project</label>
                        <input type="text" id="company" required placeholder="e.g., Coinbase">
                    </div>
                    <div class="form-group">
                        <label for="date">Date</label>
                        <input type="date" id="date" required>
                    </div>
                    <div class="form-group">
                        <label for="amount">Amount of Tokens</label>
                        <input type="number" id="amount" step="any" required placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="crypto">Cryptocurrency</label>
                        <input type="text" id="crypto" required placeholder="e.g., BTC, ETH, SOL...">
                    </div>
                    <div class="form-group">
                        <label for="coingecko-id">CoinGecko ID (optional)</label>
                        <input type="text" id="coingecko-id" placeholder="e.g., bitcoin, ethereum">
                    </div>
                    <div class="form-group">
                        <label for="usd-sold">Amount Sold (USD)</label>
                        <input type="number" id="usd-sold" step="any" placeholder="0.00" oninput="updateEurPreview()">
                        <div class="eur-preview" id="eur-preview"></div>
                    </div>
                    <div class="form-group">
                        <label for="chain">Chain (optional)</label>
                        <input type="text" id="chain" placeholder="e.g., Ethereum, Solana, BSC...">
                    </div>
                    <div class="form-group">
                        <label for="category">Category</label>
                        <select id="category">
                            <option value="">Select category...</option>
                            <option value="Airdrop">Airdrop</option>
                            <option value="Paid Deal">Paid Deal</option>
                            <option value="Staking">Staking</option>
                            <option value="Mining">Mining</option>
                            <option value="Trading">Trading</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="wallet">Wallet Address (optional)</label>
                        <input type="text" id="wallet" placeholder="0x... or wallet address">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="submit-btn">Add Payout</button>
                    <button type="button" class="btn" id="cancel-btn" style="display:none; background: #666;">Cancel</button>
                </div>
            </form>
        </div>

        </div>
        <!-- End Add Payout Tab -->

        <!-- Analytics Tab -->
        <div class="tab-content" id="tab-analytics">
            <!-- Month Tabs -->
            <div class="card">
                <h2>Filter by Month</h2>
                <div class="month-tabs" id="month-tabs">
                    <button class="month-tab active" data-month="all">All Time</button>
                </div>
            </div>

            <!-- Quick Filter Chips -->
            <div class="card">
                <h2>Quick Filters</h2>
                <div class="filter-chips" id="crypto-filter-chips">
                    <span class="filter-chip active" data-crypto="all">All Cryptos</span>
                    <!-- More chips populated dynamically -->
                </div>
            </div>

            <!-- Statistics -->
            <div class="card">
                <h2>Summary <span id="summary-period" style="font-weight: normal; color: var(--text-secondary);"></span></h2>
                <div class="stats">
                    <div class="stat-box">
                        <div class="value" id="total-payouts">0</div>
                        <div class="label">Total Payouts</div>
                        <div class="sparkline-container"><canvas id="sparkline-payouts"></canvas></div>
                    </div>
                    <div class="stat-box">
                        <div class="value usd" id="total-usd-sold">$0.00</div>
                        <div class="label">
                            Total <span id="currency-label">USD</span> Sold
                            <button id="currency-toggle" class="currency-toggle-btn" onclick="toggleCurrency()" title="Switch to EUR"></button>
                        </div>
                        <div class="sparkline-container"><canvas id="sparkline-revenue"></canvas></div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="unique-companies">0</div>
                        <div class="label">Projects</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="unique-cryptos">0</div>
                        <div class="label">Cryptocurrencies</div>
                    </div>
                </div>
            </div>

            <!-- Comparison Mode -->
            <div class="card">
                <h2>Compare Periods</h2>
                <div class="comparison-toggle">
                    <label style="color: var(--text-secondary);">Compare:</label>
                    <select class="comparison-select" id="compare-period-1">
                        <option value="">Select period...</option>
                    </select>
                    <span style="color: var(--text-secondary);">vs</span>
                    <select class="comparison-select" id="compare-period-2">
                        <option value="">Select period...</option>
                    </select>
                    <button class="btn btn-primary" onclick="compareData()" style="padding: 8px 16px; font-size: 0.9rem;">Compare</button>
                </div>
                <div id="comparison-result" style="display: none;">
                    <div class="stats" style="margin-top: 15px;">
                        <div class="stat-box">
                            <div class="value" id="compare-payouts-diff">-</div>
                            <div class="label">Payouts Difference</div>
                        </div>
                        <div class="stat-box">
                            <div class="value usd" id="compare-revenue-diff">-</div>
                            <div class="label">Revenue Difference</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="card">
                <h2>Analytics (<span id="analytics-currency">USD</span> Values)</h2>
                <div class="charts-grid">
                <div class="chart-container">
                    <h3>Payouts Over Time (USD)</h3>
                    <div class="chart-wrapper">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>Payouts by Project (USD)</h3>
                    <div class="chart-wrapper">
                        <canvas id="companyChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>Payouts by Cryptocurrency (USD)</h3>
                    <div class="chart-wrapper">
                        <canvas id="cryptoChart"></canvas>
                    </div>
                </div>
                <div class="chart-container monthly-total-display">
                    <h3>Monthly Totals (USD)</h3>
                    <div class="monthly-totals-list" id="monthly-totals-list">
                    </div>
                </div>
                <div class="chart-container" style="grid-column: 1 / -1;">
                    <h3>Cumulative Earnings (USD)</h3>
                    <div class="chart-wrapper" style="height: 300px;">
                        <canvas id="cumulativeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <!-- End Analytics Tab -->

        <!-- History Tab -->
        <div class="tab-content" id="tab-history">
        <!-- Payout List -->
        <div class="card">
            <div class="header-actions">
                <h2>Payout History</h2>
                <div>
                    <input type="text" class="search-box" id="search" placeholder="Search...">
                    <button class="btn btn-export" onclick="exportCSV()">Export CSV</button>
                </div>
            </div>
            <div class="table-container">
                <table id="payout-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable('date')">Date</th>
                            <th onclick="sortTable('company')">Project</th>
                            <th onclick="sortTable('amount')">Tokens</th>
                            <th onclick="sortTable('crypto')">Crypto</th>
                            <th onclick="sortTable('category')">Category</th>
                            <th onclick="sortTable('chain')">Chain</th>
                            <th onclick="sortTable('usd_sold')">USD Sold</th>
                            <th onclick="sortTable('eur_value')">EUR Value</th>
                            <th>Wallet</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="payout-body">
                    </tbody>
                </table>
                <div class="no-data" id="no-data">No payouts recorded yet. Add your first payout above!</div>
            </div>
        </div>
        </div>
        <!-- End History Tab -->

        <!-- Vesting Tab -->
        <div class="tab-content" id="tab-vesting">
            <!-- Upcoming Unlocks Banner -->
            <div class="upcoming-unlocks" id="upcoming-unlocks-banner" style="display: none;">
                <h3>&#128276; Upcoming Unlocks</h3>
                <div id="upcoming-unlocks-list"></div>
            </div>

            <!-- Vesting Calendar -->
            <div class="card">
                <div class="vesting-calendar">
                    <div class="calendar-header">
                        <h3>Events & Unlocks Calendar</h3>
                        <div class="calendar-nav">
                            <button class="calendar-nav-btn" onclick="changeCalendarMonth(-1)">&#10094; Prev</button>
                            <span class="calendar-month-year" id="calendar-month-year">January 2025</span>
                            <button class="calendar-nav-btn" onclick="changeCalendarMonth(1)">Next &#10095;</button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="vesting-calendar-grid">
                        <div class="calendar-day-header">Sun</div>
                        <div class="calendar-day-header">Mon</div>
                        <div class="calendar-day-header">Tue</div>
                        <div class="calendar-day-header">Wed</div>
                        <div class="calendar-day-header">Thu</div>
                        <div class="calendar-day-header">Fri</div>
                        <div class="calendar-day-header">Sat</div>
                        <!-- Calendar days will be populated dynamically -->
                    </div>
                    <div class="calendar-legend">
                        <div class="calendar-legend-item">
                            <div class="calendar-legend-dot today"></div>
                            <span>Today</span>
                        </div>
                        <div class="calendar-legend-item">
                            <div class="calendar-legend-dot upcoming"></div>
                            <span>Upcoming Unlock</span>
                        </div>
                        <div class="calendar-legend-item">
                            <div class="calendar-legend-dot past"></div>
                            <span>Past Unlock</span>
                        </div>
                        <div class="calendar-legend-item">
                            <div class="calendar-legend-dot event"></div>
                            <span>Event</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Tooltip -->
            <div class="calendar-tooltip" id="calendar-tooltip">
                <h4 id="tooltip-date">January 1, 2025</h4>
                <div id="tooltip-unlocks"></div>
            </div>

            <!-- Add Event Form -->
            <div class="card" style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleEventForm()">
                    <h2 id="event-form-title" style="margin: 0;">Add Event</h2>
                    <button type="button" id="event-form-toggle" style="background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 5px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                        <span id="event-form-toggle-icon">&#9660;</span> Show
                    </button>
                </div>
                <div id="event-form-container" style="margin-top: 20px; display: none;">
                    <form id="crypto-event-form">
                        <input type="hidden" id="event-edit-id">
                        <div class="vesting-form">
                            <div class="form-group">
                                <label for="event-name">Event Name</label>
                                <input type="text" id="event-name" required placeholder="e.g., LayerZero Airdrop">
                            </div>
                            <div class="form-group">
                                <label for="event-date">Date</label>
                                <input type="date" id="event-date" required>
                            </div>
                            <div class="form-group">
                                <label for="event-type">Event Type</label>
                                <select id="event-type" required>
                                    <option value="">Select type...</option>
                                    <option value="Airdrop">Airdrop</option>
                                    <option value="Mainnet">Mainnet Launch</option>
                                    <option value="NFT Launch">NFT Launch</option>
                                    <option value="Token Launch">Token Launch (TGE)</option>
                                    <option value="Testnet">Testnet</option>
                                    <option value="Snapshot">Snapshot</option>
                                    <option value="IDO/ICO">IDO / ICO</option>
                                    <option value="Conference">Conference / Event</option>
                                    <option value="AMA">AMA</option>
                                    <option value="Deadline">Deadline</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions" style="margin-top: 15px;">
                            <button type="submit" class="btn btn-primary">Save Event</button>
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('crypto-event-form').reset(); document.getElementById('event-edit-id').value=''; document.getElementById('event-form-title').textContent='Add Event';">Clear</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Upcoming Events List -->
            <div class="card" style="margin-top: 20px;" id="upcoming-events-card">
                <h3 style="margin-bottom: 15px;">Upcoming Events</h3>
                <div id="upcoming-events-list" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- Events will be populated dynamically -->
                </div>
            </div>

            <!-- Vesting Stats -->
            <div class="vesting-stats">
                <div class="vesting-stat">
                    <div class="stat-value" id="total-vesting-tokens">0</div>
                    <div class="stat-label">Total Vesting Tokens</div>
                </div>
                <div class="vesting-stat">
                    <div class="stat-value" id="unlocked-tokens">0</div>
                    <div class="stat-label">Unlocked</div>
                </div>
                <div class="vesting-stat">
                    <div class="stat-value" id="locked-tokens">0</div>
                    <div class="stat-label">Still Locked</div>
                </div>
                <div class="vesting-stat">
                    <div class="stat-value" id="active-vestings">0</div>
                    <div class="stat-label">Active Vestings</div>
                </div>
                <div class="vesting-stat" style="background: rgba(46, 213, 115, 0.1);">
                    <div class="stat-value" id="portfolio-value" style="color: var(--accent-green);">$0</div>
                    <div class="stat-label">Portfolio Value (USD)</div>
                </div>
                <div class="vesting-stat" style="background: rgba(46, 213, 115, 0.1);">
                    <div class="stat-value" id="unlocked-value" style="color: var(--accent-green);">$0</div>
                    <div class="stat-label">Unlocked Value</div>
                </div>
            </div>
            <div style="text-align: right; margin-bottom: 15px;">
                <button class="btn btn-secondary" onclick="fetchTokenPrices()" style="padding: 6px 12px; font-size: 0.8rem;">
                    &#x21bb; Refresh Prices
                </button>
                <span id="prices-updated" style="font-size: 0.75rem; color: var(--text-secondary); margin-left: 10px;"></span>
            </div>

            <!-- Add Vesting Form -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleVestingForm()">
                    <h2 id="vesting-form-title" style="margin: 0;">Add Vesting Schedule</h2>
                    <button type="button" id="vesting-form-toggle" style="background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 5px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                        <span id="vesting-form-toggle-icon">&#9650;</span> Hide
                    </button>
                </div>
                <div id="vesting-form-container" style="margin-top: 20px;">
                    <form id="vesting-form">
                        <input type="hidden" id="vesting-edit-id">

                    <!-- Section 1: Basic Info -->
                    <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);">
                        <h4 style="color: var(--accent); font-size: 0.95rem; margin-bottom: 15px;">Basic Information</h4>
                        <div class="vesting-form">
                            <div class="form-group">
                                <label for="vesting-project">Project Name</label>
                                <input type="text" id="vesting-project" required placeholder="e.g., LayerZero">
                            </div>
                            <div class="form-group">
                                <label for="vesting-token">Token Symbol</label>
                                <input type="text" id="vesting-token" required placeholder="e.g., ZRO">
                            </div>
                            <div class="form-group">
                                <label for="vesting-total">Total Tokens</label>
                                <input type="number" id="vesting-total" step="any" required placeholder="e.g., 10000">
                            </div>
                            <div class="form-group">
                                <label for="vesting-claimed">Tokens Already Claimed</label>
                                <input type="number" id="vesting-claimed" step="any" placeholder="0" min="0" value="0">
                                <small style="color: var(--text-secondary); font-size: 0.75rem;">For projects already in progress</small>
                            </div>
                        </div>
                    </div>


                    <!-- Section 4: Linear Vesting -->
                    <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);">
                        <h4 style="color: var(--accent); font-size: 0.95rem; margin-bottom: 15px;">Vesting Schedule</h4>
                        <div class="vesting-form">
                            <div class="form-group">
                                <label for="vesting-cliff-start">Cliff Start Date</label>
                                <input type="date" id="vesting-cliff-start">
                                <small style="color: var(--text-secondary); font-size: 0.75rem;">When the cliff period begins (leave empty if no cliff)</small>
                            </div>
                            <div class="form-group">
                                <label for="vesting-cliff">Cliff Duration (months)</label>
                                <input type="number" id="vesting-cliff" min="0" step="1" value="0" placeholder="0">
                                <small style="color: var(--text-secondary); font-size: 0.75rem;">How long until tokens start unlocking</small>
                            </div>
                            <div class="form-group">
                                <label for="vesting-cliff-amount">Cliff Unlock Amount</label>
                                <input type="number" id="vesting-cliff-amount" min="0" step="any" placeholder="0">
                                <small style="color: var(--text-secondary); font-size: 0.75rem;">Tokens released when cliff ends (leave empty to auto-calculate)</small>
                            </div>
                            <div class="form-group">
                                <label for="vesting-start-date">Vesting Start Date</label>
                                <input type="date" id="vesting-start-date" required>
                                <small style="color: var(--text-secondary); font-size: 0.75rem;">When tokens start unlocking (first unlock)</small>
                            </div>
                            <div class="form-group">
                                <label for="vesting-end-date">Vesting End Date</label>
                                <input type="date" id="vesting-end-date" required>
                                <small style="color: var(--text-secondary); font-size: 0.75rem;">When all tokens are fully vested</small>
                            </div>
                            <div class="form-group">
                                <label for="vesting-frequency">Unlock Frequency</label>
                                <select id="vesting-frequency">
                                    <option value="monthly">Monthly</option>
                                    <option value="quarterly">Quarterly (every 3 months)</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="daily">Daily</option>
                                    <option value="linear">Linear (Continuous - claim anytime)</option>
                                    <option value="custom">Custom Dates</option>
                                </select>
                                <small style="color: var(--text-secondary); font-size: 0.75rem;">How tokens unlock from start to end</small>
                            </div>
                        </div>
                        <div id="vesting-preview" style="background: rgba(0,217,255,0.1); border-radius: 8px; padding: 15px; margin-top: 15px;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                <strong style="color: var(--accent);">Preview:</strong>
                                <span id="vesting-preview-text">Fill in the form to see the unlock schedule preview</span>
                            </div>
                        </div>
                    </div>

                    <!-- Section 5: Custom Unlock Dates -->
                    <div id="custom-unlocks-section" style="display: none; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);">
                        <h4 style="color: var(--accent); font-size: 0.95rem; margin-bottom: 15px;">Custom Unlock Dates</h4>
                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 15px;">Add specific dates and amounts for each unlock:</p>
                        <div id="custom-unlocks-list"></div>
                        <button type="button" class="add-unlock-btn" onclick="addCustomUnlock()">+ Add Unlock Date</button>
                    </div>

                    <!-- Section 6: Website & Price Tracking -->
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: var(--accent); font-size: 0.95rem; margin-bottom: 15px;">Website & Price Tracking</h4>
                        <div class="vesting-form">
                            <div class="form-group">
                                <label for="vesting-website">Project Website / Claim Page</label>
                                <input type="url" id="vesting-website" placeholder="https://app.example.com/vesting">
                            </div>
                            <div class="form-group">
                                <label for="vesting-coingecko-id">CoinGecko ID (for live prices)</label>
                                <input type="text" id="vesting-coingecko-id" placeholder="e.g., ethereum, bitcoin">
                                <small style="color: var(--text-secondary); font-size: 0.75rem;">Find ID at <a href="https://www.coingecko.com" target="_blank" style="color: var(--accent);">coingecko.com</a> in the token URL</small>
                            </div>
                        </div>
                    </div>

                    <!-- Preview Section -->
                    <div id="vesting-preview-section" style="margin-bottom: 20px; display: none;">
                        <h4 style="color: var(--accent); font-size: 0.95rem; margin-bottom: 10px;">Unlock Schedule Preview</h4>
                        <div id="vesting-preview-content" style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto;">
                        </div>
                    </div>

                        <div class="form-actions" style="gap: 10px;">
                            <button type="button" class="btn" id="vesting-preview-btn" style="background: var(--secondary);" onclick="previewVestingSchedule()">Preview Schedule</button>
                            <button type="submit" class="btn btn-primary" id="vesting-submit-btn">Add Vesting</button>
                            <button type="button" class="btn" id="vesting-cancel-btn" style="display:none; background: #666;" onclick="cancelVestingEdit()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Vesting List -->
            <div class="card">
                <h2>Your Vesting Schedules</h2>
                <div class="vesting-list" id="vesting-list">
                    <div class="no-data" id="no-vesting">No vesting schedules yet. Add your first one above!</div>
                </div>
            </div>
        </div>
        <!-- End Vesting Tab -->

        <!-- Campaigns Tab -->
        <div class="tab-content" id="tab-campaigns">
            <!-- Campaign Stats -->
            <div class="campaign-stats">
                <div class="campaign-stat">
                    <div class="stat-value" id="total-campaigns">0</div>
                    <div class="stat-label">Active Campaigns</div>
                </div>
                <div class="campaign-stat">
                    <div class="stat-value" id="total-posts-needed">0</div>
                    <div class="stat-label">Total Posts Needed</div>
                </div>
                <div class="campaign-stat">
                    <div class="stat-value" id="total-posts-made">0</div>
                    <div class="stat-label">Posts Made</div>
                </div>
                <div class="campaign-stat">
                    <div class="stat-value" id="total-posts-left">0</div>
                    <div class="stat-label">Posts Left</div>
                </div>
                <div class="campaign-stat" style="background: rgba(46, 213, 115, 0.1);">
                    <div class="stat-value" id="total-campaign-rewards" style="color: var(--accent-green);">$0</div>
                    <div class="stat-label">Total Rewards (USD)</div>
                </div>
            </div>

            <!-- Add Campaign Form -->
            <div class="card" style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleCampaignForm()">
                    <h2 id="campaign-form-title" style="margin: 0;">Add Campaign</h2>
                    <button type="button" id="campaign-form-toggle" style="background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 5px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                        <span id="campaign-form-toggle-icon">&#9660;</span> Show
                    </button>
                </div>
                <div id="campaign-form-container" style="margin-top: 20px; display: none;">
                    <form id="campaign-form">
                        <input type="hidden" id="campaign-edit-id">
                        <div class="vesting-form">
                            <div class="form-group">
                                <label for="campaign-project">Project Name</label>
                                <input type="text" id="campaign-project" required placeholder="e.g., LayerZero">
                            </div>
                            <div class="form-group">
                                <label for="campaign-posts-needed">Posts Needed</label>
                                <input type="number" id="campaign-posts-needed" required min="1" placeholder="e.g., 10">
                            </div>
                            <div class="form-group">
                                <label for="campaign-reward-tokens">Reward (Tokens)</label>
                                <input type="text" id="campaign-reward-tokens" placeholder="e.g., 500 ZRO">
                            </div>
                            <div class="form-group">
                                <label for="campaign-reward-usd">Reward (USD)</label>
                                <input type="number" id="campaign-reward-usd" step="any" placeholder="e.g., 250">
                            </div>
                        </div>
                        <div class="form-actions" style="margin-top: 15px;">
                            <button type="submit" class="btn btn-primary">Save Campaign</button>
                            <button type="button" class="btn btn-secondary" onclick="resetCampaignForm()">Clear</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Campaigns List -->
            <div class="card" style="margin-top: 20px;">
                <h3 style="margin-bottom: 15px;">Your Campaigns</h3>
                <div id="campaigns-list" class="campaigns-list">
                    <div class="no-data" id="no-campaigns">No campaigns yet. Add your first one above!</div>
                </div>
            </div>
        </div>
        <!-- End Campaigns Tab -->

        <!-- Settings Tab -->
        <div class="tab-content" id="tab-settings">
            <div class="settings-grid">
                <!-- Display Settings -->
                <div class="settings-section">
                    <h3>&#9881; Display Settings</h3>
                    <div class="setting-item">
                        <div class="setting-label">
                            <span>Default Currency</span>
                            <small>Currency used for displaying values</small>
                        </div>
                        <div class="setting-control">
                            <select id="setting-currency" onchange="saveSetting('currency', this.value)">
                                <option value="USD">USD ($)</option>
                                <option value="EUR">EUR</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">
                            <span>Date Format</span>
                            <small>How dates are displayed throughout the app</small>
                        </div>
                        <div class="setting-control">
                            <select id="setting-dateformat" onchange="saveSetting('dateFormat', this.value)">
                                <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">
                            <span>Number Format</span>
                            <small>How numbers are formatted (thousands separator)</small>
                        </div>
                        <div class="setting-control">
                            <select id="setting-numberformat" onchange="saveSetting('numberFormat', this.value)">
                                <option value="1,234.56">1,234.56 (US)</option>
                                <option value="1.234,56">1.234,56 (EU)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Goals Settings -->
                <div class="settings-section">
                    <h3>&#127919; Goals Settings</h3>
                    <div class="setting-item">
                        <div class="setting-label">
                            <span>Monthly Revenue Goal</span>
                            <small>Target revenue for the month (USD)</small>
                        </div>
                        <div class="setting-control">
                            <input type="number" id="setting-revenue-goal" min="0" step="100" value="10000" onchange="saveSetting('revenueGoal', this.value)">
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">
                            <span>Monthly Payouts Goal</span>
                            <small>Target number of payouts for the month</small>
                        </div>
                        <div class="setting-control">
                            <input type="number" id="setting-payouts-goal" min="0" step="1" value="50" onchange="saveSetting('payoutsGoal', this.value)">
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">
                            <span>Yearly Earnings Goal</span>
                            <small>Target earnings for the year (USD)</small>
                        </div>
                        <div class="setting-control">
                            <input type="number" id="setting-yearly-goal" min="0" step="1000" value="100000" onchange="saveSetting('yearlyGoal', this.value)">
                        </div>
                    </div>
                </div>

                <!-- Notifications Settings -->
                <div class="settings-section">
                    <h3>&#128276; Notifications</h3>
                    <div class="setting-item">
                        <div class="setting-label">
                            <span>Vesting Unlock Alerts</span>
                            <small>Get notified before token unlocks</small>
                        </div>
                        <div class="setting-control">
                            <select id="setting-unlock-alerts" onchange="saveSetting('unlockAlerts', this.value)">
                                <option value="1">1 day before</option>
                                <option value="3">3 days before</option>
                                <option value="7">7 days before</option>
                                <option value="0">Disabled</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-actions">
                        <button class="btn btn-secondary" onclick="clearNotifications()">Clear All Notifications</button>
                    </div>
                </div>

                <!-- About -->
                <div class="settings-section">
                    <h3>&#9432; About</h3>
                    <div class="setting-item">
                        <div class="setting-label">
                            <span>Version</span>
                            <small>Current application version</small>
                        </div>
                        <div class="setting-control" style="text-align: right; color: var(--text-secondary);">
                            v1.0.0
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">
                            <span>Keyboard Shortcuts</span>
                            <small>Quick actions for power users</small>
                        </div>
                        <div class="setting-control" style="text-align: right; color: var(--text-secondary); font-size: 0.85rem;">
                            N: Quick Add | ESC: Close
                        </div>
                    </div>
                </div>

                <!-- Account -->
                <div class="settings-section">
                    <h3>&#128100; Account</h3>
                    <div class="setting-item">
                        <div class="setting-label">
                            <span>Sign Out</span>
                            <small>Log out of your account</small>
                        </div>
                        <div class="setting-control">
                            <button class="btn btn-danger" onclick="handleLogout()">Logout</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Settings Tab -->
    </div>

    <!-- Clear Data Confirmation Dialog -->
    <div class="confirm-dialog" id="clear-data-confirm">
        <div class="confirm-content">
            <h3>Clear All Data?</h3>
            <p>This will permanently delete all your payouts and vesting schedules. This action cannot be undone.</p>
            <div class="confirm-actions">
                <button class="btn btn-secondary" onclick="hideClearDataConfirm()">Cancel</button>
                <button class="btn btn-danger" onclick="clearAllData()">Delete Everything</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // ============================================
        // NEW UI FEATURES - SIDEBAR, THEME, NOTIFICATIONS, ETC.
        // ============================================

        // Sidebar Toggle
        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            document.body.classList.toggle('sidebar-collapsed', sidebar.classList.contains('collapsed'));
            localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        };

        window.toggleMobileSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('mobile-open');
        };

        // Theme Toggle
        window.toggleTheme = function() {
            const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
            document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
            document.querySelector('.theme-label').textContent = isDark ? 'Light Mode' : 'Dark Mode';
        };

        // Initialize theme
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const label = document.querySelector('.theme-label');
            if (label) label.textContent = savedTheme === 'light' ? 'Light Mode' : 'Dark Mode';
        }

        // ============================================
        // SETTINGS FUNCTIONALITY
        // ============================================

        // Default settings
        var appSettings = {
            currency: 'USD',
            dateFormat: 'YYYY-MM-DD',
            numberFormat: '1,234.56',
            revenueGoal: 10000,
            payoutsGoal: 50,
            yearlyGoal: 100000,
            unlockAlerts: 1
        };

        // Load settings from localStorage
        function loadSettings() {
            const saved = localStorage.getItem('appSettings');
            if (saved) {
                try {
                    appSettings = { ...appSettings, ...JSON.parse(saved) };
                } catch (e) {
                    console.error('Error loading settings:', e);
                }
            }
            applySettingsToUI();
        }

        // Apply settings to UI elements
        function applySettingsToUI() {
            const currencyEl = document.getElementById('setting-currency');
            const dateFormatEl = document.getElementById('setting-dateformat');
            const numberFormatEl = document.getElementById('setting-numberformat');
            const revenueGoalEl = document.getElementById('setting-revenue-goal');
            const payoutsGoalEl = document.getElementById('setting-payouts-goal');
            const yearlyGoalEl = document.getElementById('setting-yearly-goal');
            const unlockAlertsEl = document.getElementById('setting-unlock-alerts');

            if (currencyEl) currencyEl.value = appSettings.currency;
            if (dateFormatEl) dateFormatEl.value = appSettings.dateFormat;
            if (numberFormatEl) numberFormatEl.value = appSettings.numberFormat;
            if (revenueGoalEl) revenueGoalEl.value = appSettings.revenueGoal;
            if (payoutsGoalEl) payoutsGoalEl.value = appSettings.payoutsGoal;
            if (yearlyGoalEl) yearlyGoalEl.value = appSettings.yearlyGoal;
            if (unlockAlertsEl) unlockAlertsEl.value = appSettings.unlockAlerts;
        }

        // Save individual setting
        window.saveSetting = function(key, value) {
            if (key === 'revenueGoal' || key === 'payoutsGoal' || key === 'yearlyGoal' || key === 'unlockAlerts') {
                value = parseInt(value) || 0;
            }
            appSettings[key] = value;
            localStorage.setItem('appSettings', JSON.stringify(appSettings));
            showToast('Setting saved');

            // Re-render dashboard if goals changed
            if (key === 'revenueGoal' || key === 'payoutsGoal') {
                if (typeof updateDashboard === 'function') {
                    updateDashboard();
                }
            }
        };

        // Show toast notification
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            if (!toast) return;
            toast.textContent = message;
            toast.className = 'toast' + (isError ? ' error' : '');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Clear all notifications
        window.clearNotifications = function() {
            notifications = [];
            updateNotificationBadge();
            renderNotifications();
            localStorage.setItem('notifications', JSON.stringify(notifications));
            showToast('Notifications cleared');
        };

        // Reset onboarding tour
        window.resetTour = function() {
            localStorage.removeItem('tourCompleted');
            showToast('Tour reset. Refresh to see the tour again.');
        };

        // Export all data
        window.exportAllData = function() {
            const data = {
                payouts: payouts || [],
                vestings: vestings || [],
                settings: appSettings,
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'crypto-tracker-backup-' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Data exported successfully');
        };

        // Import data
        window.importData = function(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);

                    // Import vestings to localStorage
                    if (data.vestings && Array.isArray(data.vestings) && currentUser) {
                        vestings = data.vestings;
                        localStorage.setItem('vestings_' + currentUser.id, JSON.stringify(vestings));
                    }

                    // Import settings
                    if (data.settings) {
                        appSettings = { ...appSettings, ...data.settings };
                        localStorage.setItem('appSettings', JSON.stringify(appSettings));
                        applySettingsToUI();
                    }

                    // Refresh UI
                    if (typeof renderVestings === 'function') renderVestings();
                    if (typeof updateDashboard === 'function') updateDashboard();

                    showToast('Data imported successfully');
                } catch (err) {
                    showToast('Error importing data: Invalid file format', true);
                }
            };
            reader.readAsText(file);
            input.value = ''; // Reset file input
        };

        // Show clear data confirmation
        window.showClearDataConfirm = function() {
            document.getElementById('clear-data-confirm').classList.add('active');
        };

        // Hide clear data confirmation
        window.hideClearDataConfirm = function() {
            document.getElementById('clear-data-confirm').classList.remove('active');
        };

        // Clear all data
        window.clearAllData = async function() {
            try {
                // Clear vestings from Supabase and localStorage
                if (currentUser) {
                    await window.supabaseClient
                        .from('vestings')
                        .delete()
                        .eq('user_id', currentUser.id);
                    localStorage.removeItem('vestings_' + currentUser.id);
                    vestings = [];
                }

                // Clear payouts from database
                if (currentUser) {
                    const { error } = await window.supabaseClient
                        .from('payouts')
                        .delete()
                        .eq('user_id', currentUser.id);

                    if (error) throw error;
                    payouts = [];
                }

                // Clear notifications
                notifications = [];
                localStorage.setItem('notifications', JSON.stringify(notifications));

                // Clear milestones
                localStorage.removeItem('milestone_10_payouts');
                localStorage.removeItem('milestone_50_payouts');
                localStorage.removeItem('milestone_100_payouts');
                localStorage.removeItem('milestone_1k_revenue');
                localStorage.removeItem('milestone_10k_revenue');

                // Refresh UI
                if (typeof renderVestings === 'function') renderVestings();
                if (typeof updateDashboard === 'function') updateDashboard();
                if (typeof renderPayoutsTable === 'function') renderPayoutsTable();
                updateNotificationBadge();
                renderNotifications();

                hideClearDataConfirm();
                showToast('All data has been cleared');
            } catch (err) {
                showToast('Error clearing data: ' + err.message, true);
            }
        };

        // Main Tab Switching
        window.switchMainTab = function(tabName) {
            // Update tab buttons
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });
            // Update nav items
            document.querySelectorAll('.nav-item[data-tab]').forEach(item => {
                item.classList.toggle('active', item.dataset.tab === tabName);
            });
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === 'tab-' + tabName);
            });
        };

        // Notification System
        var notifications = [];

        window.toggleNotifications = function() {
            document.getElementById('notification-panel').classList.toggle('open');
        };

        function addNotification(title, text, type = 'info') {
            const notification = { id: Date.now(), title, text, type, time: new Date() };
            notifications.unshift(notification);
            updateNotificationBadge();
            renderNotifications();
            localStorage.setItem('notifications', JSON.stringify(notifications));
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notification-count');
            if (badge) badge.textContent = notifications.length;
        }

        function renderNotifications() {
            const list = document.getElementById('notification-list');
            if (!list) return;
            if (notifications.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">No notifications yet</div>';
                return;
            }
            list.innerHTML = notifications.map(n => `
                <div class="notification-item ${n.type}">
                    <div class="notification-title">${n.title}</div>
                    <div class="notification-text">${n.text}</div>
                    <div class="notification-time">${formatTimeAgo(n.time)}</div>
                </div>
            `).join('');
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diff = Math.floor((now - new Date(date)) / 1000);
            if (diff < 60) return 'Just now';
            if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
            return Math.floor(diff / 86400) + 'd ago';
        }

        function checkMilestones() {
            const totalPayouts = payouts.length;
            const totalRevenue = payouts.reduce((sum, p) => sum + (p.usd_sold || 0), 0);

            const milestones = [
                { check: totalPayouts >= 10, key: 'milestone_10_payouts', title: 'Milestone Reached!', text: 'You have tracked 10 payouts!' },
                { check: totalPayouts >= 50, key: 'milestone_50_payouts', title: 'Milestone Reached!', text: 'You have tracked 50 payouts!' },
                { check: totalPayouts >= 100, key: 'milestone_100_payouts', title: 'Milestone Reached!', text: 'You have tracked 100 payouts!' },
                { check: totalRevenue >= 1000, key: 'milestone_1k_revenue', title: 'Revenue Milestone!', text: 'You have tracked $1,000 in revenue!' },
                { check: totalRevenue >= 10000, key: 'milestone_10k_revenue', title: 'Revenue Milestone!', text: 'You have tracked $10,000 in revenue!' },
            ];

            milestones.forEach(m => {
                if (m.check && !localStorage.getItem(m.key)) {
                    addNotification(m.title, m.text, 'milestone');
                    localStorage.setItem(m.key, 'true');
                }
            });
        }

        // Quick Add Modal (FAB)
        window.openQuickAdd = function() {
            document.getElementById('quick-add-modal').classList.add('active');
            document.getElementById('fab').classList.add('active');
            document.getElementById('quick-date').valueAsDate = new Date();
        };

        window.closeQuickAdd = function() {
            document.getElementById('quick-add-modal').classList.remove('active');
            document.getElementById('fab').classList.remove('active');
        };

        // Onboarding Tour
        var tourSteps = [
            { element: '.main-tabs', title: 'Navigation Tabs', text: 'Use these tabs to switch between Dashboard, Add Payout, Analytics, and History views.' },
            { element: '#tab-dashboard .dashboard-grid', title: 'Dashboard Widgets', text: 'Your key metrics at a glance. Drag and drop to rearrange them!' },
            { element: '#heatmap', title: 'Activity Calendar', text: 'See your payout activity over time, just like GitHub contributions.' },
            { element: '.fab', title: 'Quick Add Button', text: 'Click the + button to quickly add a new payout from anywhere.' },
            { element: '.sidebar', title: 'Sidebar Navigation', text: 'Access all features from the sidebar. Click to collapse/expand.' },
        ];
        var currentTourStep = 0;

        function startTour() {
            if (localStorage.getItem('tourCompleted')) return;
            currentTourStep = 0;
            showTourStep();
        }

        function showTourStep() {
            const overlay = document.getElementById('tour-overlay');
            const tooltip = document.getElementById('tour-tooltip');
            const step = tourSteps[currentTourStep];

            if (!step) {
                endTour();
                return;
            }

            document.getElementById('tour-title').textContent = step.title;
            document.getElementById('tour-text').textContent = step.text;

            // Update dots
            const dots = document.getElementById('tour-dots');
            dots.innerHTML = tourSteps.map((_, i) =>
                `<div class="tour-dot ${i === currentTourStep ? 'active' : ''}"></div>`
            ).join('');

            overlay.classList.add('active');

            // Position tooltip near element
            const element = document.querySelector(step.element);
            if (element) {
                const rect = element.getBoundingClientRect();
                tooltip.style.top = Math.min(rect.bottom + 20, window.innerHeight - 200) + 'px';
                tooltip.style.left = Math.min(rect.left, window.innerWidth - 340) + 'px';
            }
        }

        window.nextTourStep = function() {
            currentTourStep++;
            if (currentTourStep >= tourSteps.length) {
                endTour();
            } else {
                showTourStep();
            }
        };

        window.endTour = function() {
            document.getElementById('tour-overlay').classList.remove('active');
            localStorage.setItem('tourCompleted', 'true');
        };

        // Heatmap Generation
        function generateHeatmap() {
            const heatmap = document.getElementById('heatmap');
            if (!heatmap) return;

            const today = new Date();
            const weeks = 52;
            let html = '';

            // Create date to payout count map
            const activityMap = {};
            payouts.forEach(p => {
                activityMap[p.date] = (activityMap[p.date] || 0) + 1;
            });

            // Find max for scaling
            const maxActivity = Math.max(...Object.values(activityMap), 1);

            for (let w = weeks - 1; w >= 0; w--) {
                html += '<div class="heatmap-week">';
                for (let d = 0; d < 7; d++) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - (w * 7 + (6 - d)));
                    const dateStr = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
                    const count = activityMap[dateStr] || 0;
                    const level = count === 0 ? 0 : Math.min(5, Math.ceil((count / maxActivity) * 5));
                    html += `<div class="heatmap-day level-${level}" title="${dateStr}: ${count} payouts"></div>`;
                }
                html += '</div>';
            }

            heatmap.innerHTML = html;
        }

        // Dashboard Mini Charts
        var miniPayoutsChart, miniRevenueChart;

        function initMiniCharts() {
            const payoutsCtx = document.getElementById('mini-payouts-chart');
            const revenueCtx = document.getElementById('mini-revenue-chart');

            if (!payoutsCtx || !revenueCtx) return;

            const miniChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, datalabels: { display: false } },
                scales: { x: { display: false }, y: { display: false } },
                elements: { point: { radius: 0 } }
            };

            miniPayoutsChart = new Chart(payoutsCtx, {
                type: 'line',
                data: { labels: [], datasets: [{ data: [], borderColor: '#00d9ff', borderWidth: 2, fill: true, backgroundColor: 'rgba(0,217,255,0.1)' }] },
                options: miniChartOptions
            });

            miniRevenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: { labels: [], datasets: [{ data: [], borderColor: '#2ed573', borderWidth: 2, fill: true, backgroundColor: 'rgba(46,213,115,0.1)' }] },
                options: miniChartOptions
            });
        }

        function updateMiniCharts() {
            if (!miniPayoutsChart || !miniRevenueChart) return;

            // Get last 30 days data
            const days = [];
            const payoutCounts = [];
            const revenueTotals = [];

            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
                days.push(dateStr);

                const dayPayouts = payouts.filter(p => p.date === dateStr);
                payoutCounts.push(dayPayouts.length);
                revenueTotals.push(dayPayouts.reduce((sum, p) => sum + (p.usd_sold || 0), 0));
            }

            miniPayoutsChart.data.labels = days;
            miniPayoutsChart.data.datasets[0].data = payoutCounts;
            miniPayoutsChart.update();

            miniRevenueChart.data.labels = days;
            miniRevenueChart.data.datasets[0].data = revenueTotals;
            miniRevenueChart.update();
        }

        // Dashboard Updates
        function updateDashboard() {
            // Update values
            const totalPayouts = payouts.length;
            const totalRevenue = payouts.reduce((sum, p) => sum + (p.usd_sold || 0), 0);
            const uniqueProjects = new Set(payouts.map(p => p.company.toLowerCase())).size;

            const elDashPayouts = getEl('dash-total-payouts');
            const elDashRevenue = getEl('dash-total-revenue');
            const elDashProjects = getEl('dash-projects');

            if (elDashPayouts) elDashPayouts.textContent = totalPayouts;
            if (elDashRevenue) elDashRevenue.textContent = getCurrencySymbol() + formatUSD(convertCurrency(totalRevenue));
            if (elDashProjects) elDashProjects.textContent = uniqueProjects;
            updateDashboardCurrencyButton();

            // Calculate trends (compare to previous month)
            const now = new Date();
            const thisMonth = now.toISOString().substring(0, 7);
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1).toISOString().substring(0, 7);

            const thisMonthPayouts = payouts.filter(p => p.date.startsWith(thisMonth));
            const lastMonthPayouts = payouts.filter(p => p.date.startsWith(lastMonth));

            const payoutsTrend = lastMonthPayouts.length > 0
                ? ((thisMonthPayouts.length - lastMonthPayouts.length) / lastMonthPayouts.length * 100).toFixed(0)
                : 0;
            const thisMonthRev = thisMonthPayouts.reduce((s, p) => s + (p.usd_sold || 0), 0);
            const lastMonthRev = lastMonthPayouts.reduce((s, p) => s + (p.usd_sold || 0), 0);
            const revenueTrend = lastMonthRev > 0
                ? ((thisMonthRev - lastMonthRev) / lastMonthRev * 100).toFixed(0)
                : 0;

            const payoutsTrendEl = getEl('payouts-trend');
            const revenueTrendEl = getEl('revenue-trend');

            if (payoutsTrendEl) {
                payoutsTrendEl.textContent = (payoutsTrend >= 0 ? '+' : '') + payoutsTrend + '%';
                payoutsTrendEl.className = 'trend ' + (payoutsTrend >= 0 ? 'up' : 'down');
            }
            if (revenueTrendEl) {
                revenueTrendEl.textContent = (revenueTrend >= 0 ? '+' : '') + revenueTrend + '%';
                revenueTrendEl.className = 'trend ' + (revenueTrend >= 0 ? 'up' : 'down');
            }

            // Update project chips
            const projectChips = getEl('project-chips');
            if (projectChips) {
                const projects = [...new Set(payouts.map(p => p.company))].slice(0, 5);
                projectChips.innerHTML = projects.map(p =>
                    `<span class="filter-chip" onclick="filterByProject('${p}')">${p}</span>`
                ).join('');
            }

            // Update recent activity
            const recentActivity = getEl('recent-activity');
            if (recentActivity) {
                const recent = payouts.slice(0, 5);
                recentActivity.innerHTML = recent.map(p => `
                    <div class="activity-item">
                        <div class="activity-icon">${p.crypto.charAt(0)}</div>
                        <div class="activity-details">
                            <div class="activity-title">${p.company} - ${p.crypto}</div>
                            <div class="activity-time">${formatDate(p.date)}</div>
                        </div>
                        <div class="activity-amount">${p.usd_sold ? getCurrencySymbol() + formatUSD(convertCurrency(p.usd_sold)) : '-'}</div>
                    </div>
                `).join('') || '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">No activity yet</div>';
            }

            // Update goals
            updateGoals();

            // Update mini charts
            updateMiniCharts();

            // Generate heatmap
            generateHeatmap();

            // Check milestones
            checkMilestones();
        }

        function updateGoals() {
            const now = new Date();
            const thisMonth = now.toISOString().substring(0, 7);
            const thisYear = now.getFullYear().toString();

            // Monthly goals
            const monthPayouts = payouts.filter(p => p.date.startsWith(thisMonth));
            const monthRevenue = monthPayouts.reduce((s, p) => s + (p.usd_sold || 0), 0);

            const revenueGoal = appSettings.revenueGoal || 10000;
            const payoutsGoal = appSettings.payoutsGoal || 50;

            const displayRevenue = convertCurrency(monthRevenue);
            const displayGoal = convertCurrency(revenueGoal);
            document.getElementById('goal-progress-text').textContent = getCurrencySymbol() + formatUSD(displayRevenue) + ' / ' + getCurrencySymbol() + formatUSD(displayGoal);
            document.getElementById('goal-bar').style.width = Math.min(100, (monthRevenue / revenueGoal) * 100) + '%';

            document.getElementById('payouts-goal-text').textContent = monthPayouts.length + ' / ' + payoutsGoal;
            document.getElementById('payouts-goal-bar').style.width = Math.min(100, (monthPayouts.length / payoutsGoal) * 100) + '%';

            // Yearly goal
            const yearlyGoal = appSettings.yearlyGoal || 100000;
            const yearPayouts = payouts.filter(p => p.date.startsWith(thisYear));
            const yearRevenue = yearPayouts.reduce((s, p) => s + (p.usd_sold || 0), 0);

            const displayYearRevenue = convertCurrency(yearRevenue);
            const displayYearlyGoal = convertCurrency(yearlyGoal);
            const yearlyPercent = Math.min(100, (yearRevenue / yearlyGoal) * 100);
            const yearlyRemaining = Math.max(0, yearlyGoal - yearRevenue);
            const displayYearlyRemaining = convertCurrency(yearlyRemaining);

            document.getElementById('yearly-goal-year').textContent = '(' + thisYear + ')';
            document.getElementById('yearly-goal-text').textContent = getCurrencySymbol() + formatUSD(displayYearRevenue) + ' / ' + getCurrencySymbol() + formatUSD(displayYearlyGoal);
            document.getElementById('yearly-goal-bar').style.width = yearlyPercent + '%';
            document.getElementById('yearly-goal-percent').textContent = yearlyPercent.toFixed(1) + '% complete';
            document.getElementById('yearly-goal-remaining').textContent = getCurrencySymbol() + formatUSD(displayYearlyRemaining) + ' remaining';
        }

        // Quick Filter Chips
        var selectedCryptoFilter = 'all';

        function updateCryptoFilterChips() {
            const chips = document.getElementById('crypto-filter-chips');
            if (!chips) return;

            const cryptos = [...new Set(payouts.map(p => p.crypto))];
            chips.innerHTML = `<span class="filter-chip ${selectedCryptoFilter === 'all' ? 'active' : ''}" data-crypto="all" onclick="filterByCrypto('all')">All Cryptos</span>` +
                cryptos.map(c => `<span class="filter-chip ${selectedCryptoFilter === c ? 'active' : ''}" data-crypto="${c}" onclick="filterByCrypto('${c}')">${c}</span>`).join('');
        }

        window.filterByCrypto = function(crypto) {
            selectedCryptoFilter = crypto;
            updateCryptoFilterChips();
            renderAll();
        };

        window.filterByProject = function(project) {
            document.getElementById('search').value = project;
            switchMainTab('history');
            renderTable();
        };

        // Comparison Mode
        window.compareData = function() {
            const period1 = document.getElementById('compare-period-1').value;
            const period2 = document.getElementById('compare-period-2').value;

            if (!period1 || !period2) {
                alert('Please select two periods to compare');
                return;
            }

            const p1Data = payouts.filter(p => p.date.startsWith(period1));
            const p2Data = payouts.filter(p => p.date.startsWith(period2));

            const p1Payouts = p1Data.length;
            const p2Payouts = p2Data.length;
            const p1Revenue = p1Data.reduce((s, p) => s + (p.usd_sold || 0), 0);
            const p2Revenue = p2Data.reduce((s, p) => s + (p.usd_sold || 0), 0);

            const payoutsDiff = p1Payouts - p2Payouts;
            const revenueDiff = p1Revenue - p2Revenue;

            document.getElementById('compare-payouts-diff').textContent = (payoutsDiff >= 0 ? '+' : '') + payoutsDiff;
            document.getElementById('compare-payouts-diff').className = 'value ' + (payoutsDiff >= 0 ? 'trend-up' : 'trend-down');

            document.getElementById('compare-revenue-diff').textContent = (revenueDiff >= 0 ? '+' : '') + '$' + formatUSD(Math.abs(revenueDiff));
            document.getElementById('compare-revenue-diff').className = 'value usd ' + (revenueDiff >= 0 ? 'trend-up' : 'trend-down');

            document.getElementById('comparison-result').style.display = 'block';
        };

        function updateComparisonSelects() {
            const months = [...new Set(payouts.map(p => p.date.substring(0, 7)))].sort().reverse();
            const options = '<option value="">Select period...</option>' +
                months.map(m => {
                    const [year, month] = m.split('-');
                    const name = new Date(year, month - 1).toLocaleString('en-US', { month: 'short', year: 'numeric' });
                    return `<option value="${m}">${name}</option>`;
                }).join('');

            document.getElementById('compare-period-1').innerHTML = options;
            document.getElementById('compare-period-2').innerHTML = options;
        }

        // Drag and Drop for Dashboard Widgets
        function initDragDrop() {
            const widgets = document.querySelectorAll('.draggable');
            widgets.forEach(widget => {
                widget.addEventListener('dragstart', handleDragStart);
                widget.addEventListener('dragend', handleDragEnd);
                widget.addEventListener('dragover', handleDragOver);
                widget.addEventListener('drop', handleDrop);
                widget.addEventListener('dragenter', handleDragEnter);
                widget.addEventListener('dragleave', handleDragLeave);
            });
        }

        var draggedWidget = null;

        function handleDragStart(e) {
            draggedWidget = this;
            this.classList.add('dragging');
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDragEnter(e) {
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            if (draggedWidget !== this) {
                const parent = this.parentNode;
                const allWidgets = [...parent.children];
                const draggedIndex = allWidgets.indexOf(draggedWidget);
                const targetIndex = allWidgets.indexOf(this);

                if (draggedIndex < targetIndex) {
                    parent.insertBefore(draggedWidget, this.nextSibling);
                } else {
                    parent.insertBefore(draggedWidget, this);
                }
            }
            this.classList.remove('drag-over');
        }

        // ============================================
        // ATTACH ALL FUNCTIONS TO WINDOW IMMEDIATELY
        // ============================================

        window.hideAuthMessages = function() {
            document.getElementById('auth-error').style.display = 'none';
            document.getElementById('auth-success').style.display = 'none';
        };

        window.showAuthError = function(message) {
            var el = document.getElementById('auth-error');
            el.textContent = message;
            el.style.display = 'block';
        };

        window.showAuthSuccess = function(message) {
            var el = document.getElementById('auth-success');
            el.textContent = message;
            el.style.display = 'block';
        };

        window.showAuthTab = function(tab) {
            document.querySelectorAll('.auth-tab').forEach(function(t) { t.classList.remove('active'); });
            if (tab === 'login') {
                document.querySelector('.auth-tab:first-child').classList.add('active');
            } else {
                document.querySelector('.auth-tab:last-child').classList.add('active');
            }
            document.getElementById('login-form').classList.toggle('hidden', tab !== 'login');
            document.getElementById('signup-form').classList.toggle('hidden', tab !== 'signup');
            window.hideAuthMessages();
        };

        window.handleLogin = function(e) {
            e.preventDefault();
            window.hideAuthMessages();
            var email = document.getElementById('login-email').value;
            var password = document.getElementById('login-password').value;
            window.supabaseClient.auth.signInWithPassword({ email: email, password: password })
                .then(function(result) {
                    if (result.error) window.showAuthError(result.error.message);
                });
        };

        window.handleSignup = function(e) {
            e.preventDefault();
            window.hideAuthMessages();
            var email = document.getElementById('signup-email').value;
            var password = document.getElementById('signup-password').value;
            var confirm = document.getElementById('signup-confirm').value;
            if (password !== confirm) {
                window.showAuthError('Passwords do not match');
                return;
            }
            window.supabaseClient.auth.signUp({ email: email, password: password })
                .then(function(result) {
                    if (result.error) {
                        window.showAuthError(result.error.message);
                    } else {
                        window.showAuthSuccess('Account created! Please check your email to verify your account.');
                        document.getElementById('signup-form').reset();
                    }
                });
        };

        window.handleGoogleLogin = function() {
            window.hideAuthMessages();
            window.supabaseClient.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: window.location.origin + window.location.pathname
                }
            }).then(function(result) {
                if (result.error) window.showAuthError(result.error.message);
            });
        };

        window.handleLogout = function() {
            // Hide sidebar and FAB
            document.getElementById('sidebar').classList.add('hidden');
            document.getElementById('fab').classList.add('hidden');
            document.body.classList.remove('has-sidebar', 'sidebar-collapsed');
            window.supabaseClient.auth.signOut();
        };

        // ============================================
        // SUPABASE INITIALIZATION
        // ============================================

        var SUPABASE_URL = 'https://ivjxsidujcnfeaxgrtch.supabase.co';
        var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2anhzaWR1amNuZmVheGdydGNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1MzExODAsImV4cCI6MjA4MzEwNzE4MH0.Hl85howprQbotsHTlTHW0g8tyXwhZAgxedGTZ8lT6Jw';

        window.supabaseClient = null;

        // Data storage
        var payouts = [];
        var currentUser = null;
        var sortField = 'date';
        var sortDirection = 'desc';
        var selectedMonth = 'all';

        // DOM element cache for frequently accessed elements
        var domCache = {};
        function getEl(id) {
            if (!domCache[id]) {
                domCache[id] = document.getElementById(id);
            }
            return domCache[id];
        }

        // Chart instances
        var timelineChart, companyChart, cryptoChart, cumulativeChart;

        // Currency settings
        var selectedCurrency = 'USD';
        var eurExchangeRate = null;

        // Cache settings (TTL in milliseconds)
        var CACHE_TTL = {
            exchangeRate: 60 * 60 * 1000, // 1 hour
            tokenPrices: 5 * 60 * 1000    // 5 minutes
        };

        // Chart colors
        var chartColors = [
            '#00d9ff', '#ff6b6b', '#4ecdc4', '#ffe66d', '#95e1d3',
            '#f38181', '#aa96da', '#fcbad3', '#a8d8ea', '#ffd93d'
        ];

        // Fetch EUR exchange rate with caching
        async function fetchExchangeRate() {
            try {
                // Check cache first
                const cached = localStorage.getItem('exchangeRateCache');
                if (cached) {
                    const { rate, timestamp } = JSON.parse(cached);
                    if (Date.now() - timestamp < CACHE_TTL.exchangeRate) {
                        eurExchangeRate = rate;
                        console.log('EUR exchange rate loaded from cache:', eurExchangeRate);
                        return;
                    }
                }

                const response = await fetch('https://api.frankfurter.app/latest?from=USD&to=EUR');
                const data = await response.json();
                eurExchangeRate = data.rates.EUR;

                // Cache the result
                localStorage.setItem('exchangeRateCache', JSON.stringify({
                    rate: eurExchangeRate,
                    timestamp: Date.now()
                }));

                console.log('EUR exchange rate loaded:', eurExchangeRate);
            } catch (error) {
                console.error('Failed to fetch exchange rate:', error);
                // Try cache as fallback even if expired
                const cached = localStorage.getItem('exchangeRateCache');
                if (cached) {
                    eurExchangeRate = JSON.parse(cached).rate;
                } else {
                    eurExchangeRate = 0.92; // Fallback rate
                }
            }
        }

        // Toggle currency display (for analytics)
        window.toggleCurrency = function() {
            selectedCurrency = selectedCurrency === 'USD' ? 'EUR' : 'USD';
            updateStats();
            updateCharts();
            updateCurrencyToggleButton();
            updateDashboard();
        };

        // Toggle currency display (for dashboard)
        window.toggleDashboardCurrency = function() {
            selectedCurrency = selectedCurrency === 'USD' ? 'EUR' : 'USD';
            updateDashboard();
            updateStats();
            updateCharts();
            updateCurrencyToggleButton();
        };

        function updateCurrencyToggleButton() {
            const btn = document.getElementById('currency-toggle');
            if (btn) {
                btn.textContent = selectedCurrency === 'USD' ? '' : '$';
                btn.title = selectedCurrency === 'USD' ? 'Switch to EUR' : 'Switch to USD';
            }
        }

        function updateDashboardCurrencyButton() {
            const btn = document.getElementById('dash-currency-toggle');
            if (btn) {
                btn.textContent = selectedCurrency === 'USD' ? '' : '$';
                btn.title = selectedCurrency === 'USD' ? 'Switch to EUR' : 'Switch to USD';
            }
        }

        // Convert USD to selected currency
        function convertCurrency(usdValue) {
            if (selectedCurrency === 'EUR' && eurExchangeRate) {
                return usdValue * eurExchangeRate;
            }
            return usdValue;
        }

        // Get currency symbol
        function getCurrencySymbol() {
            return selectedCurrency === 'EUR' ? '' : '$';
        }

        // Update EUR preview in form
        window.updateEurPreview = function() {
            const usdInput = document.getElementById('usd-sold');
            const eurPreview = document.getElementById('eur-preview');
            const usdValue = parseFloat(usdInput.value) || 0;

            if (usdValue > 0 && eurExchangeRate) {
                const eurValue = usdValue * eurExchangeRate;
                eurPreview.textContent = ' ' + formatUSD(eurValue) + ' EUR';
            } else {
                eurPreview.textContent = '';
            }
        };

        // Initialize app after Supabase is ready
        function initApp() {
            if (!window.supabaseClient) return;

            // Check for existing session
            window.supabaseClient.auth.getSession().then(function(result) {
                if (result.data && result.data.session) {
                    currentUser = result.data.session.user;
                    showApp();
                }
            });

            // Listen for auth changes
            window.supabaseClient.auth.onAuthStateChange(function(event, session) {
                if (event === 'SIGNED_IN' && session) {
                    currentUser = session.user;
                    showApp();
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    showAuth();
                }
            });
        }

        // Initialize Supabase when library loads
        document.addEventListener('DOMContentLoaded', function() {
            if (window.supabase) {
                window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                initApp();
            } else {
                // Wait for Supabase library
                var check = setInterval(function() {
                    if (window.supabase) {
                        clearInterval(check);
                        window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                        initApp();
                    }
                }, 100);
            }
        });

        function showAuth() {
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('app-section').classList.add('hidden');
        }

        async function showApp() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');

            // Show sidebar and FAB
            document.getElementById('sidebar').classList.remove('hidden');
            document.getElementById('fab').classList.remove('hidden');
            document.body.classList.add('has-sidebar');

            // Initialize theme and settings
            initTheme();
            loadSettings();

            // Check if sidebar should be collapsed
            if (localStorage.getItem('sidebarCollapsed') === 'true') {
                document.getElementById('sidebar').classList.add('collapsed');
                document.body.classList.add('sidebar-collapsed');
            }

            // Set user avatar and name
            const email = currentUser.email;
            const initials = email.substring(0, 2).toUpperCase();
            document.getElementById('user-avatar').textContent = initials;
            document.getElementById('user-name').textContent = email.split('@')[0];

            // Load saved notifications
            try {
                const savedNotifications = localStorage.getItem('notifications');
                if (savedNotifications) {
                    notifications = JSON.parse(savedNotifications);
                    updateNotificationBadge();
                    renderNotifications();
                }
            } catch (e) {}

            document.getElementById('date').valueAsDate = new Date();
            initCharts();
            initMiniCharts();
            initDragDrop();

            // Load all data in parallel for faster startup
            await Promise.all([
                fetchExchangeRate(),
                loadPayouts(),
                loadVestings(),
                loadCryptoEvents(),
                loadCampaigns()
            ]);

            // Start tour for first-time users
            setTimeout(() => startTour(), 1000);
        }

        // Database functions
        async function loadPayouts() {
            var result = await window.supabaseClient
                .from('payouts')
                .select('*')
                .order('date', { ascending: false });

            if (result.error) {
                console.error('Error loading payouts:', result.error);
                return;
            }

            payouts = (result.data || []).map(p => ({ ...p, amount: parseFloat(p.amount) || 0, usd_sold: parseFloat(p.usd_sold) || 0, eur_value: parseFloat(p.eur_value) || 0 }));
            updateMonthTabs();
            renderAll();
            fetchPayoutTokenImages(); // Fetch token images for payouts with CoinGecko IDs
        }

        async function savePayout(payout) {
            var result = await window.supabaseClient
                .from('payouts')
                .insert([{
                    user_id: currentUser.id,
                    company: payout.company,
                    date: payout.date,
                    amount: payout.amount,
                    crypto: payout.crypto,
                    coingecko_id: payout.coingecko_id || null,
                    usd_sold: payout.usd_sold,
                    eur_value: payout.eur_value,
                    chain: payout.chain,
                    wallet: payout.wallet,
                    category: payout.category || null
                }])
                .select();

            if (result.error) {
                console.error('Error saving payout:', result.error);
                alert('Error saving payout: ' + result.error.message);
                return null;
            }

            const saved = result.data[0]; return { ...saved, amount: parseFloat(saved.amount) || 0, usd_sold: parseFloat(saved.usd_sold) || 0, eur_value: parseFloat(saved.eur_value) || 0 };
        }

        async function updatePayout(id, payout) {
            var result = await window.supabaseClient
                .from('payouts')
                .update({
                    company: payout.company,
                    date: payout.date,
                    amount: payout.amount,
                    crypto: payout.crypto,
                    coingecko_id: payout.coingecko_id || null,
                    usd_sold: payout.usd_sold,
                    eur_value: payout.eur_value,
                    chain: payout.chain,
                    wallet: payout.wallet,
                    category: payout.category || null
                })
                .eq('id', id)
                .select();

            if (result.error) {
                console.error('Error updating payout:', result.error);
                alert('Error updating payout: ' + result.error.message);
                return null;
            }

            const updated = result.data[0]; return { ...updated, amount: parseFloat(updated.amount) || 0, usd_sold: parseFloat(updated.usd_sold) || 0, eur_value: parseFloat(updated.eur_value) || 0 };
        }

        async function deletePayoutFromDB(id) {
            var result = await window.supabaseClient
                .from('payouts')
                .delete()
                .eq('id', id);

            if (result.error) {
                console.error('Error deleting payout:', result.error);
                alert('Error deleting payout: ' + result.error.message);
                return false;
            }

            return true;
        }

        // Format USD
        function formatUSD(value) {
            if (value >= 1) {
                return value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } else {
                return value.toFixed(4);
            }
        }

        // Initialize charts
        function initCharts() {
            // Register the datalabels plugin
            Chart.register(ChartDataLabels);

            // Timeline chart
            timelineChart = new Chart(document.getElementById('timelineChart'), {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return getCurrencySymbol() + formatUSD(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#aaa' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            ticks: {
                                color: '#aaa',
                                callback: function(value) {
                                    return getCurrencySymbol() + formatUSD(value);
                                }
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });

            // Company chart (vertical bar)
            companyChart = new Chart(document.getElementById('companyChart'), {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#2ed573',
                            font: { weight: 'bold', size: 11 },
                            formatter: function(value) {
                                return getCurrencySymbol() + formatUSD(value);
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return getCurrencySymbol() + formatUSD(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#aaa' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            ticks: {
                                color: '#aaa',
                                callback: function(value) {
                                    return getCurrencySymbol() + formatUSD(value);
                                }
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });

            // Crypto chart (doughnut)
            cryptoChart = new Chart(document.getElementById('cryptoChart'), {
                type: 'doughnut',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#aaa' }
                        },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: 11 },
                            formatter: function(value, context) {
                                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                if (percentage < 5) return '';
                                return getCurrencySymbol() + formatUSD(value);
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.raw / total) * 100).toFixed(1);
                                    return context.label + ': ' + getCurrencySymbol() + formatUSD(context.raw) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });

            // Cumulative earnings chart
            cumulativeChart = new Chart(document.getElementById('cumulativeChart'), {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Total: ' + getCurrencySymbol() + formatUSD(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#aaa' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            ticks: {
                                color: '#aaa',
                                callback: function(value) {
                                    return getCurrencySymbol() + formatUSD(value);
                                }
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        // Get filtered payouts based on selected month and category
        function getFilteredPayouts() {
            return payouts.filter(p => {
                const matchesMonth = selectedMonth === 'all' || p.date.substring(0, 7) === selectedMonth;
                const matchesCategory = selectedCategoryFilter === 'all' || p.category === selectedCategoryFilter;
                return matchesMonth && matchesCategory;
            });
        }

        // Update month tabs
        function updateMonthTabs() {
            const months = new Set(payouts.map(p => p.date.substring(0, 7)));
            const sortedMonths = Array.from(months).sort().reverse();

            const tabsContainer = document.getElementById('month-tabs');
            tabsContainer.innerHTML = `<button class="month-tab ${selectedMonth === 'all' ? 'active' : ''}" data-month="all">All Time</button>`;

            sortedMonths.forEach(month => {
                const [year, monthNum] = month.split('-');
                const monthName = new Date(year, monthNum - 1).toLocaleString('en-US', { month: 'short', year: 'numeric' });
                tabsContainer.innerHTML += `<button class="month-tab ${selectedMonth === month ? 'active' : ''}" data-month="${month}">${monthName}</button>`;
            });

            // Add click handlers
            document.querySelectorAll('.month-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    selectedMonth = tab.dataset.month;
                    document.querySelectorAll('.month-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    renderAll();
                });
            });
        }

        // Debounce utility for performance optimization
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Render everything (core function)
        function renderAllCore() {
            renderTable();
            updateStats();
            updateCharts();
            updateDashboard();
            updateCategoryFilterChips();
            updateComparisonSelects();
        }

        // Debounced version for rapid updates (e.g., search typing)
        var renderAllDebounced = debounce(renderAllCore, 100);

        // Immediate render for user actions that need instant feedback
        function renderAll() {
            renderAllCore();
        }

        // Form submission
        document.getElementById('payout-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const editId = document.getElementById('edit-id').value;
            const usdValue = parseFloat(document.getElementById('usd-sold').value) || 0;
            const eurValue = usdValue && eurExchangeRate ? parseFloat((usdValue * eurExchangeRate).toFixed(2)) : 0;
            const payout = {
                company: document.getElementById('company').value.trim(),
                date: document.getElementById('date').value,
                amount: parseFloat(document.getElementById('amount').value),
                crypto: document.getElementById('crypto').value.toUpperCase(),
                coingecko_id: document.getElementById('coingecko-id').value.trim().toLowerCase(),
                usd_sold: usdValue,
                eur_value: eurValue,
                chain: document.getElementById('chain').value.trim(),
                wallet: document.getElementById('wallet').value.trim(),
                category: document.getElementById('category').value || ''
            };

            if (editId) {
                const updated = await updatePayout(editId, payout);
                if (updated) {
                    const index = payouts.findIndex(p => p.id === editId);
                    if (index !== -1) {
                        payouts[index] = updated;
                    }
                }
                cancelEdit();
            } else {
                const saved = await savePayout(payout);
                if (saved) {
                    payouts.unshift(saved);
                }
            }

            updateMonthTabs();
            renderAll();
            fetchPayoutTokenImages(); // Fetch new token image if added
            e.target.reset();
            document.getElementById('date').valueAsDate = new Date();
        });

        // Render table
        function renderTable() {
            const searchTerm = (getEl('search')?.value || '').toLowerCase();
            const tbody = getEl('payout-body');
            const noData = getEl('no-data');

            let filtered = getFilteredPayouts().filter(p => {
                const matchesSearch = p.company.toLowerCase().includes(searchTerm) ||
                    p.crypto.toLowerCase().includes(searchTerm) ||
                    (p.chain || '').toLowerCase().includes(searchTerm) ||
                    (p.category || '').toLowerCase().includes(searchTerm);
                const matchesCrypto = selectedCryptoFilter === 'all' || p.crypto === selectedCryptoFilter;
                const matchesCategory = selectedCategoryFilter === 'all' || p.category === selectedCategoryFilter;
                return matchesSearch && matchesCrypto && matchesCategory;
            });

            filtered.sort((a, b) => {
                let aVal = a[sortField];
                let bVal = b[sortField];

                if (sortField === 'amount' || sortField === 'usd_sold' || sortField === 'eur_value') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                }

                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '';
                noData.style.display = 'block';
                return;
            }

            noData.style.display = 'none';
            tbody.innerHTML = filtered.map(p => {
                const categoryClass = (p.category || '').toLowerCase().replace(' ', '-');
                const tokenImage = p.coingecko_id ? getTokenImage(p.coingecko_id) : null;
                return `
                <tr>
                    <td>${formatDate(p.date)}</td>
                    <td>${escapeHtml(p.company)}</td>
                    <td>${p.amount}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            ${tokenImage ? `<img src="${tokenImage}" alt="${p.crypto}" style="width: 20px; height: 20px; border-radius: 50%;">` : ''}
                            <span>${p.crypto}</span>
                        </div>
                    </td>
                    <td>${p.category ? `<span class="category-badge ${categoryClass}">${p.category}</span>` : '-'}</td>
                    <td>${escapeHtml(p.chain) || '-'}</td>
                    <td class="usd-value">${p.usd_sold ? '$' + formatUSD(p.usd_sold) : '-'}</td>
                    <td class="eur-value">${p.eur_value ? '' + formatUSD(p.eur_value) : '-'}</td>
                    <td style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(p.wallet) || ''}">${escapeHtml(p.wallet) || '-'}</td>
                    <td>
                        <button class="btn btn-edit" onclick="editPayout('${p.id}')">Edit</button>
                        <button class="btn btn-danger" onclick="deletePayout('${p.id}')">Delete</button>
                    </td>
                </tr>
            `}).join('');
        }

        // Update statistics
        function updateStats() {
            const filtered = getFilteredPayouts();

            const totalUSDSold = filtered.reduce((sum, p) => sum + (p.usd_sold || 0), 0);
            const displayValue = convertCurrency(totalUSDSold);

            const elTotalPayouts = getEl('total-payouts');
            const elTotalUsd = getEl('total-usd-sold');
            const elCurrencyLabel = getEl('currency-label');
            const elUniqueCompanies = getEl('unique-companies');
            const elUniqueCryptos = getEl('unique-cryptos');
            const elPeriod = getEl('summary-period');

            if (elTotalPayouts) elTotalPayouts.textContent = filtered.length;
            if (elTotalUsd) elTotalUsd.textContent = getCurrencySymbol() + formatUSD(displayValue);
            if (elCurrencyLabel) elCurrencyLabel.textContent = selectedCurrency;
            if (elUniqueCompanies) elUniqueCompanies.textContent = new Set(filtered.map(p => p.company.toLowerCase())).size;
            if (elUniqueCryptos) elUniqueCryptos.textContent = new Set(filtered.map(p => p.crypto)).size;

            // Update period label
            if (elPeriod) {
                if (selectedMonth === 'all') {
                    elPeriod.textContent = '';
                } else {
                    const [year, month] = selectedMonth.split('-');
                    elPeriod.textContent = `- ${new Date(year, month - 1).toLocaleString('en-US', { month: 'long', year: 'numeric' })}`;
                }
            }
        }

        // Update charts
        function updateCharts() {
            const filtered = getFilteredPayouts();

            const currencySymbol = getCurrencySymbol();

            // Timeline chart - values over time
            const timelineData = {};
            filtered.forEach(p => {
                timelineData[p.date] = (timelineData[p.date] || 0) + (p.usd_sold || 0);
            });
            const sortedDates = Object.keys(timelineData).sort();

            timelineChart.data.labels = sortedDates.map(d => formatDate(d));
            timelineChart.data.datasets = [{
                data: sortedDates.map(d => convertCurrency(timelineData[d])),
                borderColor: '#2ed573',
                backgroundColor: 'rgba(46, 213, 115, 0.1)',
                fill: true,
                tension: 0.3
            }];
            timelineChart.update();

            // Company chart - values by project
            const companyData = {};
            filtered.forEach(p => {
                companyData[p.company] = (companyData[p.company] || 0) + (p.usd_sold || 0);
            });
            const sortedCompanies = Object.entries(companyData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);

            companyChart.data.labels = sortedCompanies.map(c => c[0]);
            companyChart.data.datasets = [{
                data: sortedCompanies.map(c => convertCurrency(c[1])),
                backgroundColor: chartColors
            }];
            companyChart.update();

            // Crypto chart - values by crypto
            const cryptoData = {};
            filtered.forEach(p => {
                cryptoData[p.crypto] = (cryptoData[p.crypto] || 0) + (p.usd_sold || 0);
            });

            cryptoChart.data.labels = Object.keys(cryptoData);
            cryptoChart.data.datasets = [{
                data: Object.values(cryptoData).map(v => convertCurrency(v)),
                backgroundColor: chartColors
            }];
            cryptoChart.update();

            // Cumulative earnings chart - running total over time
            const allPayoutsSorted = [...filtered].sort((a, b) => a.date.localeCompare(b.date));
            const cumulativeData = [];
            let runningTotal = 0;
            const dateLabels = [];

            allPayoutsSorted.forEach(p => {
                runningTotal += (p.usd_sold || 0);
                // Group by date to avoid duplicate points
                const existingIndex = dateLabels.indexOf(p.date);
                if (existingIndex >= 0) {
                    cumulativeData[existingIndex] = runningTotal;
                } else {
                    dateLabels.push(p.date);
                    cumulativeData.push(runningTotal);
                }
            });

            cumulativeChart.data.labels = dateLabels.map(d => formatDate(d));
            cumulativeChart.data.datasets = [{
                data: cumulativeData.map(v => convertCurrency(v)),
                borderColor: '#00d9ff',
                backgroundColor: 'rgba(0, 217, 255, 0.1)',
                fill: true,
                tension: 0.3,
                pointBackgroundColor: '#00d9ff',
                pointBorderColor: '#00d9ff',
                pointRadius: 3
            }];
            cumulativeChart.update();

            // Monthly totals list - values by month (shows all months)
            const monthlyData = {};
            payouts.forEach(p => {
                const month = p.date.substring(0, 7);
                monthlyData[month] = (monthlyData[month] || 0) + (p.usd_sold || 0);
            });
            const sortedMonths = Object.keys(monthlyData).sort().reverse();

            const monthlyList = document.getElementById('monthly-totals-list');
            if (sortedMonths.length === 0) {
                monthlyList.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No data yet</div>';
            } else {
                monthlyList.innerHTML = sortedMonths.map(m => {
                    const [year, monthNum] = m.split('-');
                    const monthName = new Date(year, monthNum - 1).toLocaleString('en-US', { month: 'long', year: 'numeric' });
                    const isActive = m === selectedMonth;
                    return `
                        <div class="monthly-total-item ${isActive ? 'active' : ''}">
                            <span class="month-name">${monthName}</span>
                            <span class="month-amount">${currencySymbol}${formatUSD(convertCurrency(monthlyData[m]))}</span>
                        </div>
                    `;
                }).join('');
            }

            // Update chart titles and analytics header
            document.getElementById('analytics-currency').textContent = selectedCurrency;
            document.querySelector('#timelineChart').closest('.chart-container').querySelector('h3').textContent = 'Payouts Over Time (' + selectedCurrency + ')';
            document.querySelector('#companyChart').closest('.chart-container').querySelector('h3').textContent = 'Payouts by Project (' + selectedCurrency + ')';
            document.querySelector('#cryptoChart').closest('.chart-container').querySelector('h3').textContent = 'Payouts by Cryptocurrency (' + selectedCurrency + ')';
            document.querySelector('#monthly-totals-list').closest('.chart-container').querySelector('h3').textContent = 'Monthly Totals (' + selectedCurrency + ')';
            document.querySelector('#cumulativeChart').closest('.chart-container').querySelector('h3').textContent = 'Cumulative Earnings (' + selectedCurrency + ')';
        }

        // Sort table
        function sortTable(field) {
            if (sortField === field) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDirection = 'asc';
            }
            renderTable();
        }

        // Edit payout
        function editPayout(id) {
            const payout = payouts.find(p => p.id === id);
            if (!payout) return;

            document.getElementById('edit-id').value = payout.id;
            document.getElementById('company').value = payout.company;
            document.getElementById('date').value = payout.date;
            document.getElementById('amount').value = payout.amount;
            document.getElementById('crypto').value = payout.crypto;
            document.getElementById('coingecko-id').value = payout.coingecko_id || '';
            document.getElementById('usd-sold').value = payout.usd_sold || '';
            document.getElementById('chain').value = payout.chain || '';
            document.getElementById('wallet').value = payout.wallet || '';
            document.getElementById('category').value = payout.category || '';

            document.getElementById('form-title').textContent = 'Edit Payout';
            document.getElementById('submit-btn').textContent = 'Update Payout';
            document.getElementById('cancel-btn').style.display = 'inline-block';

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Cancel edit
        function cancelEdit() {
            document.getElementById('edit-id').value = '';
            document.getElementById('payout-form').reset();
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('form-title').textContent = 'Add New Payout';
            document.getElementById('submit-btn').textContent = 'Add Payout';
            document.getElementById('cancel-btn').style.display = 'none';
        }

        document.getElementById('cancel-btn').addEventListener('click', cancelEdit);

        // Delete payout
        async function deletePayout(id) {
            if (confirm('Are you sure you want to delete this payout?')) {
                const success = await deletePayoutFromDB(id);
                if (success) {
                    payouts = payouts.filter(p => p.id !== id);
                    updateMonthTabs();
                    renderAll();
                }
            }
        }

        // Search - use debounced render for better performance while typing
        var debouncedSearch = debounce(renderTable, 150);
        document.getElementById('search').addEventListener('input', debouncedSearch);

        // Export to CSV
        function exportCSV() {
            const filtered = getFilteredPayouts();
            if (filtered.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = ['Date', 'Project', 'Tokens', 'Cryptocurrency', 'Chain', 'USD Sold', 'EUR Value', 'Wallet'];
            const rows = filtered.map(p => [
                p.date,
                `"${p.company.replace(/"/g, '""')}"`,
                p.amount,
                p.crypto,
                `"${(p.chain || '').replace(/"/g, '""')}"`,
                (p.usd_sold || 0).toFixed(2),
                (p.eur_value || 0).toFixed(2),
                `"${(p.wallet || '').replace(/"/g, '""')}"`
            ]);

            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `crypto-payouts-${selectedMonth === 'all' ? 'all' : selectedMonth}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Helper functions
        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Quick Add Form Handler
        document.getElementById('quick-payout-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const usdValue = parseFloat(document.getElementById('quick-usd').value) || 0;
            const eurValue = usdValue && eurExchangeRate ? parseFloat((usdValue * eurExchangeRate).toFixed(2)) : 0;
            const payout = {
                company: document.getElementById('quick-company').value.trim(),
                date: document.getElementById('quick-date').value,
                amount: parseFloat(document.getElementById('quick-amount').value),
                crypto: document.getElementById('quick-crypto').value.toUpperCase(),
                usd_sold: usdValue,
                eur_value: eurValue,
                chain: '',
                wallet: '',
                category: document.getElementById('quick-category').value || ''
            };

            const saved = await savePayout(payout);
            if (saved) {
                payouts.unshift(saved);
                updateMonthTabs();
                renderAll();
                closeQuickAdd();
                e.target.reset();
                addNotification('Payout Added', `Added ${payout.amount} ${payout.crypto} from ${payout.company}`, 'info');
            }
        });

        // Close modal on backdrop click
        document.getElementById('quick-add-modal').addEventListener('click', (e) => {
            if (e.target.id === 'quick-add-modal') {
                closeQuickAdd();
            }
        });

        // Close notification panel on outside click
        document.addEventListener('click', (e) => {
            const panel = document.getElementById('notification-panel');
            const bell = document.querySelector('.notification-bell');
            if (panel.classList.contains('open') && !panel.contains(e.target) && !bell.contains(e.target)) {
                panel.classList.remove('open');
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Escape to close modals
            if (e.key === 'Escape') {
                closeQuickAdd();
                document.getElementById('notification-panel').classList.remove('open');
                endTour();
            }
            // N for new payout (when not in input)
            if (e.key === 'n' && !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
                e.preventDefault();
                openQuickAdd();
            }
        });

        // ============================================
        // VESTING TRACKER FUNCTIONALITY
        // ============================================

        var vestings = [];
        var customUnlocks = [];
        var cryptoEvents = [];

        // Load vestings from Supabase
        async function loadVestings() {
            try {
                const result = await window.supabaseClient
                    .from('vestings')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (result.error) {
                    console.error('Error loading vestings:', result.error);
                    // Fallback to localStorage
                    const saved = localStorage.getItem('vestings_' + currentUser.id);
                    if (saved) {
                        vestings = JSON.parse(saved);
                        // Migrate localStorage data to Supabase
                        migrateVestingsToSupabase();
                    }
                } else {
                    vestings = (result.data || []).map(v => {
                        // Helper to ensure date is in YYYY-MM-DD format
                        function formatDateField(dateVal) {
                            if (!dateVal) return '';
                            if (/^\d{4}-\d{2}-\d{2}$/.test(dateVal)) return dateVal;
                            const d = new Date(dateVal + 'T12:00:00');
                            return d.getFullYear() + '-' +
                                String(d.getMonth() + 1).padStart(2, '0') + '-' +
                                String(d.getDate()).padStart(2, '0');
                        }

                        // Process custom unlocks dates and extract metadata
                        let customUnlocks = v.custom_unlocks || [];
                        let cliffMonths = 0;
                        let cliffStartDate = '';
                        let cliffAmount = 0;
                        if (customUnlocks && Array.isArray(customUnlocks)) {
                            // Extract cliff metadata if present
                            const metadataEntry = customUnlocks.find(u => u._isMetadata);
                            if (metadataEntry) {
                                cliffMonths = parseInt(metadataEntry.cliffMonths) || 0;
                                cliffStartDate = metadataEntry.cliffStartDate || '';
                                cliffAmount = parseFloat(metadataEntry.cliffAmount) || 0;
                            }
                            // Filter out metadata and format dates
                            customUnlocks = customUnlocks
                                .filter(u => !u._isMetadata)
                                .map(u => ({
                                    ...u,
                                    date: formatDateField(u.date)
                                }));
                        }

                        return {
                            id: v.id,
                            project: v.project,
                            token: v.token,
                            totalTokens: String(v.total_tokens),
                            tokensClaimed: String(v.tokens_claimed || 0),
                            cliffStartDate: cliffStartDate,
                            cliffMonths: cliffMonths,
                            cliffAmount: cliffAmount,
                            startDate: formatDateField(v.start_date),
                            endDate: formatDateField(v.end_date),
                            frequency: v.frequency,
                            customUnlocks: customUnlocks,
                            website: v.website || '',
                            coingeckoId: v.coingecko_id || '',
                            claimedUnlocks: v.claimed_unlocks || [],
                            createdAt: v.created_at
                        };
                    });

                    // Check for localStorage data to migrate
                    const saved = localStorage.getItem('vestings_' + currentUser.id);
                    if (saved && vestings.length === 0) {
                        const localVestings = JSON.parse(saved);
                        if (localVestings.length > 0) {
                            vestings = localVestings;
                            await migrateVestingsToSupabase();
                        }
                    }
                }
            } catch (e) {
                console.error('Error in loadVestings:', e);
                vestings = [];
            }
            renderVestings();
            updateVestingStats();
            checkUpcomingUnlocks();
            renderVestingCalendar();
            fetchTokenPrices(); // Fetch prices for tokens with CoinGecko IDs
        }

        // Token prices and images cache
        var tokenPrices = {};
        var tokenImages = {};
        var pricesLastUpdated = null;
        var pendingTokenFetch = null; // Prevent duplicate concurrent fetches

        // Unified function to fetch all token data from CoinGecko
        async function fetchAllTokenData() {
            // Collect all CoinGecko IDs from vestings and payouts
            const vestingIds = vestings.map(v => v.coingeckoId).filter(id => id && id.trim() !== '');
            const payoutIds = payouts.map(p => p.coingecko_id).filter(id => id && id.trim() !== '');
            const allIds = [...new Set([...vestingIds, ...payoutIds])];

            if (allIds.length === 0) {
                return;
            }

            // Check cache validity
            if (pricesLastUpdated && (Date.now() - pricesLastUpdated.getTime() < CACHE_TTL.tokenPrices)) {
                // Cache still valid, check if we have all IDs
                const missingIds = allIds.filter(id => !tokenPrices[id] && !tokenImages[id]);
                if (missingIds.length === 0) {
                    console.log('Token data loaded from cache');
                    return;
                }
            }

            // Prevent duplicate concurrent fetches
            if (pendingTokenFetch) {
                return pendingTokenFetch;
            }

            // Filter out IDs we already have cached (and cache is still valid)
            const idsToFetch = pricesLastUpdated && (Date.now() - pricesLastUpdated.getTime() < CACHE_TTL.tokenPrices)
                ? allIds.filter(id => !tokenPrices[id])
                : allIds;

            if (idsToFetch.length === 0) {
                return;
            }

            pendingTokenFetch = (async () => {
                try {
                    const response = await fetch(
                        `https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${idsToFetch.join(',')}&sparkline=false`
                    );

                    if (!response.ok) {
                        console.error('CoinGecko API error:', response.status);
                        return;
                    }

                    const data = await response.json();

                    // Process the response
                    data.forEach(coin => {
                        tokenPrices[coin.id] = {
                            usd: coin.current_price,
                            eur: coin.current_price * (eurExchangeRate || 0.92)
                        };
                        tokenImages[coin.id] = coin.image;
                    });

                    pricesLastUpdated = new Date();
                    console.log('Token data updated:', Object.keys(tokenPrices).length, 'tokens');

                    // Re-render affected components
                    if (vestingIds.length > 0) {
                        renderVestings();
                        updateVestingStats();
                    }
                    if (payoutIds.length > 0) {
                        renderTable();
                    }
                } catch (e) {
                    console.error('Error fetching token data:', e);
                } finally {
                    pendingTokenFetch = null;
                }
            })();

            return pendingTokenFetch;
        }

        // Legacy function names for backwards compatibility
        async function fetchTokenPrices() {
            return fetchAllTokenData();
        }

        async function fetchPayoutTokenImages() {
            return fetchAllTokenData();
        }

        // Get price for a token
        function getTokenPrice(coingeckoId, currency = 'usd') {
            if (!coingeckoId || !tokenPrices[coingeckoId]) return null;
            return tokenPrices[coingeckoId][currency.toLowerCase()] || null;
        }

        // Get image for a token
        function getTokenImage(coingeckoId) {
            if (!coingeckoId || !tokenImages[coingeckoId]) return null;
            return tokenImages[coingeckoId];
        }

        // Format currency value (abbreviated by default, set abbreviate=false for full numbers)
        function formatCurrencyValue(value, currency = 'USD', abbreviate = true) {
            if (value === null || value === undefined) return 'N/A';
            const symbol = currency === 'EUR' ? '' : '$';
            if (abbreviate) {
                if (value >= 1000000) {
                    return symbol + (value / 1000000).toFixed(2) + 'M';
                } else if (value >= 1000) {
                    return symbol + (value / 1000).toFixed(2) + 'K';
                }
            }
            return symbol + value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Migrate vestings from localStorage to Supabase
        async function migrateVestingsToSupabase() {
            if (vestings.length === 0) return;

            console.log('Migrating vestings to Supabase...');
            for (const v of vestings) {
                try {
                    await window.supabaseClient
                        .from('vestings')
                        .upsert({
                            id: v.id,
                            user_id: currentUser.id,
                            project: v.project,
                            token: v.token,
                            total_tokens: v.totalTokens,
                            tokens_claimed: v.tokensClaimed || 0,
                            start_date: v.startDate,
                            end_date: v.endDate,
                            frequency: v.frequency,
                            custom_unlocks: v.customUnlocks || [],
                            website: v.website || '',
                            coingecko_id: v.coingeckoId || '',
                            claimed_unlocks: v.claimedUnlocks || [],
                            created_at: v.createdAt || new Date().toISOString()
                        });
                } catch (e) {
                    console.error('Error migrating vesting:', e);
                }
            }
            // Clear localStorage after successful migration
            localStorage.removeItem('vestings_' + currentUser.id);
            console.log('Vestings migration complete');
        }

        // Save vesting to Supabase
        async function saveVestingToSupabase(vesting) {
            // Store cliff data in custom_unlocks as metadata (avoids DB schema change)
            let customUnlocksWithMeta = vesting.customUnlocks || [];
            // Remove any existing metadata entry
            customUnlocksWithMeta = customUnlocksWithMeta.filter(u => !u._isMetadata);
            // Add cliff metadata if cliff is set
            if (vesting.cliffMonths > 0 || vesting.cliffStartDate || vesting.cliffAmount > 0) {
                customUnlocksWithMeta = [...customUnlocksWithMeta, {
                    _isMetadata: true,
                    cliffMonths: vesting.cliffMonths || 0,
                    cliffStartDate: vesting.cliffStartDate || '',
                    cliffAmount: vesting.cliffAmount || 0
                }];
            }

            const result = await window.supabaseClient
                .from('vestings')
                .upsert({
                    id: vesting.id,
                    user_id: currentUser.id,
                    project: vesting.project,
                    token: vesting.token,
                    total_tokens: vesting.totalTokens,
                    tokens_claimed: vesting.tokensClaimed || 0,
                    start_date: vesting.startDate,
                    end_date: vesting.endDate,
                    frequency: vesting.frequency,
                    custom_unlocks: customUnlocksWithMeta,
                    website: vesting.website || '',
                    coingecko_id: vesting.coingeckoId || '',
                    claimed_unlocks: vesting.claimedUnlocks || [],
                    created_at: vesting.createdAt || new Date().toISOString()
                });

            if (result.error) {
                console.error('Error saving vesting:', result.error);
                showToast('Error saving vesting: ' + result.error.message, true);
                return false;
            }
            return true;
        }

        // Claim an unlock for a vesting
        window.claimUnlock = async function(vestingId, unlockDate) {
            const vesting = vestings.find(v => v.id === vestingId);
            if (!vesting) return;

            // Initialize claimedUnlocks if not exists
            if (!vesting.claimedUnlocks) {
                vesting.claimedUnlocks = [];
            }

            // Add the date if not already claimed
            if (!vesting.claimedUnlocks.includes(unlockDate)) {
                vesting.claimedUnlocks.push(unlockDate);

                // Save to database
                const saved = await saveVestingToSupabase(vesting);
                if (saved) {
                    showToast('Unlock marked as claimed!');
                    renderVestings();
                    updateVestingStats();
                }
            }
        };

        // Unclaim an unlock (in case of mistake)
        window.unclaimUnlock = async function(vestingId, unlockDate) {
            const vesting = vestings.find(v => v.id === vestingId);
            if (!vesting || !vesting.claimedUnlocks) return;

            const index = vesting.claimedUnlocks.indexOf(unlockDate);
            if (index > -1) {
                vesting.claimedUnlocks.splice(index, 1);

                // Save to database
                const saved = await saveVestingToSupabase(vesting);
                if (saved) {
                    showToast('Unlock unmarked');
                    renderVestings();
                    updateVestingStats();
                }
            }
        };

        // Claim all unlocked tokens for a vesting
        window.claimAllUnlocks = async function(vestingId) {
            const vesting = vestings.find(v => v.id === vestingId);
            if (!vesting) return;

            const today = new Date();
            const unlocks = calculateUnlockSchedule(vesting);
            const unlockedDates = unlocks
                .filter(u => new Date(u.date) <= today)
                .map(u => u.date);

            if (!vesting.claimedUnlocks) {
                vesting.claimedUnlocks = [];
            }

            // Add all unlocked dates that aren't already claimed
            let newClaims = 0;
            unlockedDates.forEach(date => {
                if (!vesting.claimedUnlocks.includes(date)) {
                    vesting.claimedUnlocks.push(date);
                    newClaims++;
                }
            });

            if (newClaims > 0) {
                const saved = await saveVestingToSupabase(vesting);
                if (saved) {
                    showToast(`${newClaims} unlock(s) marked as claimed!`);
                    renderVestings();
                    updateVestingStats();
                }
            } else {
                showToast('All unlocks already claimed');
            }
        };

        // Claim tokens for linear vesting (prompts for amount)
        window.claimLinearTokens = async function(vestingId) {
            const vesting = vestings.find(v => v.id === vestingId);
            if (!vesting) return;

            const linearInfo = calculateLinearVesting(vesting);
            if (!linearInfo) return;

            const currentClaimed = parseFloat(vesting.tokensClaimed) || 0;
            const claimableNow = linearInfo.claimableNow;
            const unclaimed = Math.max(0, claimableNow - currentClaimed);

            const amount = prompt(`How many tokens did you claim?\n\nCurrently claimable: ${formatNumber(claimableNow)} ${vesting.token}\nAlready claimed: ${formatNumber(currentClaimed)} ${vesting.token}\nUnclaimed: ${formatNumber(unclaimed)} ${vesting.token}`, unclaimed.toFixed(2));

            if (amount === null) return; // User cancelled

            const claimedAmount = parseFloat(amount);
            if (isNaN(claimedAmount) || claimedAmount < 0) {
                showToast('Invalid amount', true);
                return;
            }

            vesting.tokensClaimed = String(currentClaimed + claimedAmount);
            const saved = await saveVestingToSupabase(vesting);
            if (saved) {
                showToast(`Marked ${formatNumber(claimedAmount)} ${vesting.token} as claimed!`);
                renderVestings();
                updateVestingStats();
            }
        };

        // Delete vesting from Supabase
        async function deleteVestingFromSupabase(id) {
            const result = await window.supabaseClient
                .from('vestings')
                .delete()
                .eq('id', id)
                .eq('user_id', currentUser.id);

            if (result.error) {
                console.error('Error deleting vesting:', result.error);
                showToast('Error deleting vesting: ' + result.error.message, true);
                return false;
            }
            return true;
        }

        // Legacy function for compatibility
        function saveVestingsToStorage() {
            // No longer used - vestings are saved to Supabase
        }

        // ============================================
        // CRYPTO EVENTS FUNCTIONALITY
        // ============================================

        // Load crypto events from Supabase
        async function loadCryptoEvents() {
            try {
                const result = await window.supabaseClient
                    .from('crypto_events')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('event_date', { ascending: true });

                if (result.error) {
                    console.error('Error loading crypto events:', result.error);
                    cryptoEvents = [];
                } else {
                    cryptoEvents = (result.data || []).map(e => ({
                        id: e.id,
                        name: e.name,
                        date: e.event_date,
                        type: e.event_type,
                        createdAt: e.created_at
                    }));
                }
            } catch (e) {
                console.error('Error in loadCryptoEvents:', e);
                cryptoEvents = [];
            }
            renderVestingCalendar();
        }

        // Save crypto event to Supabase
        async function saveCryptoEventToSupabase(event) {
            try {
                const eventData = {
                    user_id: currentUser.id,
                    name: event.name,
                    event_date: event.date,
                    event_type: event.type
                };

                if (event.id) {
                    // Update existing event
                    const result = await window.supabaseClient
                        .from('crypto_events')
                        .update(eventData)
                        .eq('id', event.id);
                    if (result.error) throw result.error;
                } else {
                    // Insert new event
                    const result = await window.supabaseClient
                        .from('crypto_events')
                        .insert([eventData])
                        .select();
                    if (result.error) throw result.error;
                    if (result.data && result.data[0]) {
                        event.id = result.data[0].id;
                    }
                }
                return true;
            } catch (e) {
                console.error('Error saving crypto event:', e);
                return false;
            }
        }

        // Delete crypto event from Supabase
        async function deleteCryptoEventFromSupabase(id) {
            try {
                const result = await window.supabaseClient
                    .from('crypto_events')
                    .delete()
                    .eq('id', id);
                if (result.error) throw result.error;
                return true;
            } catch (e) {
                console.error('Error deleting crypto event:', e);
                return false;
            }
        }

        // Handle crypto event form submission
        document.getElementById('crypto-event-form')?.addEventListener('submit', async function(e) {
            e.preventDefault();

            const eventId = document.getElementById('event-edit-id').value;
            const event = {
                id: eventId || null,
                name: document.getElementById('event-name').value,
                date: document.getElementById('event-date').value,
                type: document.getElementById('event-type').value
            };

            const success = await saveCryptoEventToSupabase(event);
            if (success) {
                if (eventId) {
                    // Update existing event in array
                    const index = cryptoEvents.findIndex(e => e.id === eventId);
                    if (index !== -1) {
                        cryptoEvents[index] = event;
                    }
                } else {
                    // Add new event to array
                    cryptoEvents.push(event);
                }

                // Reset form
                this.reset();
                document.getElementById('event-edit-id').value = '';
                document.getElementById('event-form-title').textContent = 'Add Event';

                // Re-render calendar
                renderVestingCalendar();

                addNotification('Event ' + (eventId ? 'updated' : 'added') + ': ' + event.name);
            }
        });

        // Edit crypto event
        window.editCryptoEvent = function(id) {
            const event = cryptoEvents.find(e => e.id === id);
            if (!event) return;

            document.getElementById('event-edit-id').value = event.id;
            document.getElementById('event-name').value = event.name;
            document.getElementById('event-date').value = event.date;
            document.getElementById('event-type').value = event.type;
            document.getElementById('event-form-title').textContent = 'Edit Event';

            // Expand form if collapsed
            const container = document.getElementById('event-form-container');
            if (container) container.style.display = 'block';

            // Scroll to form
            document.getElementById('crypto-event-form')?.scrollIntoView({ behavior: 'smooth' });
        };

        // Delete crypto event
        window.deleteCryptoEvent = async function(id) {
            if (!confirm('Are you sure you want to delete this event?')) return;

            const success = await deleteCryptoEventFromSupabase(id);
            if (success) {
                cryptoEvents = cryptoEvents.filter(e => e.id !== id);
                renderVestingCalendar();
                addNotification('Event deleted');
            }
        };

        // Toggle event form visibility
        window.toggleEventForm = function() {
            const container = document.getElementById('event-form-container');
            const toggleBtn = document.getElementById('event-form-toggle');
            const toggleIcon = document.getElementById('event-form-toggle-icon');

            if (container.style.display === 'none') {
                container.style.display = 'block';
                toggleBtn.innerHTML = '<span id="event-form-toggle-icon">&#9650;</span> Hide';
            } else {
                container.style.display = 'none';
                toggleBtn.innerHTML = '<span id="event-form-toggle-icon">&#9660;</span> Show';
            }
        };

        // ============================================
        // CAMPAIGNS FUNCTIONALITY
        // ============================================

        var campaigns = [];

        // Load campaigns from Supabase
        async function loadCampaigns() {
            try {
                const result = await window.supabaseClient
                    .from('campaigns')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (result.error) {
                    console.error('Error loading campaigns:', result.error);
                    campaigns = [];
                } else {
                    campaigns = (result.data || []).map(c => ({
                        id: c.id,
                        project: c.project,
                        postsNeeded: c.posts_needed,
                        rewardTokens: c.reward_tokens || '',
                        rewardUsd: c.reward_usd || 0,
                        posts: c.posts || [],
                        createdAt: c.created_at
                    }));
                }
            } catch (e) {
                console.error('Error in loadCampaigns:', e);
                campaigns = [];
            }
            renderCampaigns();
            updateCampaignStats();
        }

        // Save campaign to Supabase
        async function saveCampaignToSupabase(campaign) {
            try {
                const campaignData = {
                    user_id: currentUser.id,
                    project: campaign.project,
                    posts_needed: campaign.postsNeeded,
                    reward_tokens: campaign.rewardTokens,
                    reward_usd: campaign.rewardUsd,
                    posts: campaign.posts || []
                };

                if (campaign.id) {
                    const result = await window.supabaseClient
                        .from('campaigns')
                        .update(campaignData)
                        .eq('id', campaign.id);
                    if (result.error) throw result.error;
                } else {
                    const result = await window.supabaseClient
                        .from('campaigns')
                        .insert([campaignData])
                        .select();
                    if (result.error) throw result.error;
                    if (result.data && result.data[0]) {
                        campaign.id = result.data[0].id;
                    }
                }
                return true;
            } catch (e) {
                console.error('Error saving campaign:', e);
                return false;
            }
        }

        // Delete campaign from Supabase
        async function deleteCampaignFromSupabase(id) {
            try {
                const result = await window.supabaseClient
                    .from('campaigns')
                    .delete()
                    .eq('id', id);
                if (result.error) throw result.error;
                return true;
            } catch (e) {
                console.error('Error deleting campaign:', e);
                return false;
            }
        }

        // Handle campaign form submission
        document.getElementById('campaign-form')?.addEventListener('submit', async function(e) {
            e.preventDefault();

            const campaignId = document.getElementById('campaign-edit-id').value;
            const existingCampaign = campaignId ? campaigns.find(c => c.id === campaignId) : null;

            const campaign = {
                id: campaignId || null,
                project: document.getElementById('campaign-project').value,
                postsNeeded: parseInt(document.getElementById('campaign-posts-needed').value),
                rewardTokens: document.getElementById('campaign-reward-tokens').value,
                rewardUsd: parseFloat(document.getElementById('campaign-reward-usd').value) || 0,
                posts: existingCampaign ? existingCampaign.posts : []
            };

            const success = await saveCampaignToSupabase(campaign);
            if (success) {
                if (campaignId) {
                    const index = campaigns.findIndex(c => c.id === campaignId);
                    if (index !== -1) {
                        campaigns[index] = campaign;
                    }
                } else {
                    campaigns.unshift(campaign);
                }

                resetCampaignForm();
                renderCampaigns();
                updateCampaignStats();
                addNotification('Campaign ' + (campaignId ? 'updated' : 'added') + ': ' + campaign.project);
            }
        });

        // Reset campaign form
        window.resetCampaignForm = function() {
            document.getElementById('campaign-form').reset();
            document.getElementById('campaign-edit-id').value = '';
            document.getElementById('campaign-form-title').textContent = 'Add Campaign';
        };

        // Edit campaign
        window.editCampaign = function(id) {
            const campaign = campaigns.find(c => c.id === id);
            if (!campaign) return;

            document.getElementById('campaign-edit-id').value = campaign.id;
            document.getElementById('campaign-project').value = campaign.project;
            document.getElementById('campaign-posts-needed').value = campaign.postsNeeded;
            document.getElementById('campaign-reward-tokens').value = campaign.rewardTokens;
            document.getElementById('campaign-reward-usd').value = campaign.rewardUsd || '';
            document.getElementById('campaign-form-title').textContent = 'Edit Campaign';

            const container = document.getElementById('campaign-form-container');
            if (container) container.style.display = 'block';
            document.getElementById('campaign-form-toggle').innerHTML = '<span>&#9650;</span> Hide';

            document.getElementById('campaign-form')?.scrollIntoView({ behavior: 'smooth' });
        };

        // Delete campaign
        window.deleteCampaign = async function(id) {
            if (!confirm('Are you sure you want to delete this campaign?')) return;

            const success = await deleteCampaignFromSupabase(id);
            if (success) {
                campaigns = campaigns.filter(c => c.id !== id);
                renderCampaigns();
                updateCampaignStats();
                addNotification('Campaign deleted');
            }
        };

        // Add post to campaign
        window.addPostToCampaign = async function(campaignId) {
            const input = document.getElementById(`post-url-${campaignId}`);
            const url = input.value.trim();

            if (!url) return;

            const campaign = campaigns.find(c => c.id === campaignId);
            if (!campaign) return;

            const newPost = {
                url: url,
                date: new Date().toISOString().split('T')[0]
            };

            campaign.posts = campaign.posts || [];
            campaign.posts.push(newPost);

            const success = await saveCampaignToSupabase(campaign);
            if (success) {
                input.value = '';
                renderCampaigns();
                updateCampaignStats();
            }
        };

        // Delete post from campaign
        window.deletePostFromCampaign = async function(campaignId, postIndex) {
            const campaign = campaigns.find(c => c.id === campaignId);
            if (!campaign || !campaign.posts) return;

            campaign.posts.splice(postIndex, 1);

            const success = await saveCampaignToSupabase(campaign);
            if (success) {
                renderCampaigns();
                updateCampaignStats();
            }
        };

        // Toggle campaign form visibility
        window.toggleCampaignForm = function() {
            const container = document.getElementById('campaign-form-container');
            const toggleBtn = document.getElementById('campaign-form-toggle');

            if (container.style.display === 'none') {
                container.style.display = 'block';
                toggleBtn.innerHTML = '<span id="campaign-form-toggle-icon">&#9650;</span> Hide';
            } else {
                container.style.display = 'none';
                toggleBtn.innerHTML = '<span id="campaign-form-toggle-icon">&#9660;</span> Show';
            }
        };

        // Render campaigns list
        function renderCampaigns() {
            const container = document.getElementById('campaigns-list');
            const noData = document.getElementById('no-campaigns');
            if (!container) return;

            if (campaigns.length === 0) {
                container.innerHTML = '';
                if (noData) noData.style.display = 'block';
                return;
            }

            if (noData) noData.style.display = 'none';

            container.innerHTML = campaigns.map(campaign => {
                const postsMade = campaign.posts ? campaign.posts.length : 0;
                const postsLeft = Math.max(0, campaign.postsNeeded - postsMade);
                const progress = Math.min(100, (postsMade / campaign.postsNeeded) * 100);
                const isComplete = postsMade >= campaign.postsNeeded;

                const postsHtml = (campaign.posts || []).map((post, index) => `
                    <div class="campaign-post-item">
                        <a href="${escapeHtml(post.url)}" target="_blank" rel="noopener">${escapeHtml(post.url)}</a>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="post-date">${post.date}</span>
                            <button class="delete-post" onclick="deletePostFromCampaign('${campaign.id}', ${index})" title="Delete post">&times;</button>
                        </div>
                    </div>
                `).join('');

                return `
                    <div class="campaign-card" style="${isComplete ? 'border-left-color: var(--accent-green);' : ''}">
                        <div class="campaign-header">
                            <div class="campaign-info">
                                <h3>${escapeHtml(campaign.project)} ${isComplete ? '<span style="color: var(--accent-green);"> Complete</span>' : ''}</h3>
                                <div class="campaign-rewards">
                                    ${campaign.rewardTokens ? `<span class="campaign-reward-badge tokens">${escapeHtml(campaign.rewardTokens)}</span>` : ''}
                                    ${campaign.rewardUsd ? `<span class="campaign-reward-badge usd">$${formatNumber(campaign.rewardUsd)}</span>` : ''}
                                </div>
                            </div>
                            <div class="campaign-actions">
                                <button onclick="editCampaign('${campaign.id}')">Edit</button>
                                <button class="delete" onclick="deleteCampaign('${campaign.id}')">Delete</button>
                            </div>
                        </div>

                        <div class="campaign-progress">
                            <div class="campaign-progress-header">
                                <span>${postsMade} of ${campaign.postsNeeded} posts</span>
                                <span>${postsLeft} left</span>
                            </div>
                            <div class="campaign-progress-bar">
                                <div class="campaign-progress-fill" style="width: ${progress}%;"></div>
                            </div>
                        </div>

                        <div class="campaign-posts-section">
                            <div class="campaign-posts-header">
                                <h4>Posts Made</h4>
                            </div>
                            ${postsMade > 0 ? `<div class="campaign-posts-list">${postsHtml}</div>` : '<p style="color: var(--text-secondary); font-size: 0.85rem;">No posts yet</p>'}

                            <div class="add-post-form">
                                <input type="url" id="post-url-${campaign.id}" placeholder="Paste post URL (e.g., https://twitter.com/...)" onkeypress="if(event.key === 'Enter') { event.preventDefault(); addPostToCampaign('${campaign.id}'); }">
                                <button type="button" onclick="addPostToCampaign('${campaign.id}')">Add Post</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update campaign stats
        function updateCampaignStats() {
            let totalCampaigns = campaigns.length;
            let totalPostsNeeded = 0;
            let totalPostsMade = 0;
            let totalRewardsUsd = 0;

            campaigns.forEach(c => {
                totalPostsNeeded += c.postsNeeded || 0;
                totalPostsMade += (c.posts ? c.posts.length : 0);
                totalRewardsUsd += c.rewardUsd || 0;
            });

            const totalPostsLeft = Math.max(0, totalPostsNeeded - totalPostsMade);

            document.getElementById('total-campaigns').textContent = totalCampaigns;
            document.getElementById('total-posts-needed').textContent = totalPostsNeeded;
            document.getElementById('total-posts-made').textContent = totalPostsMade;
            document.getElementById('total-posts-left').textContent = totalPostsLeft;
            document.getElementById('total-campaign-rewards').textContent = '$' + formatNumber(totalRewardsUsd);
        }

        // Toggle custom unlocks section based on frequency selection
        document.getElementById('vesting-frequency').addEventListener('change', function() {
            const customSection = document.getElementById('custom-unlocks-section');
            customSection.style.display = this.value === 'custom' ? 'block' : 'none';
        });

        // Add custom unlock row
        window.addCustomUnlock = function() {
            const list = document.getElementById('custom-unlocks-list');
            const index = list.children.length;
            const row = document.createElement('div');
            row.className = 'unlock-input-row';
            row.innerHTML = `
                <input type="date" name="custom-date-${index}" required>
                <input type="number" name="custom-amount-${index}" step="any" placeholder="Token Amount" required>
                <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()" style="padding: 8px 12px;"></button>
            `;
            list.appendChild(row);
        };

        // Calculate unlock schedule
        function calculateUnlockSchedule(vesting) {
            const unlocks = [];
            const totalTokens = parseFloat(vesting.totalTokens);
            const frequency = vesting.frequency;
            const cliffMonths = parseInt(vesting.cliffMonths) || 0;
            const cliffAmount = parseFloat(vesting.cliffAmount) || 0;
            const hasCliffStartDate = vesting.cliffStartDate && vesting.cliffStartDate.length > 0;

            // Parse start and end dates
            if (!vesting.startDate || !vesting.endDate) return unlocks;

            const startParts = vesting.startDate.split('-');
            const startDate = new Date(parseInt(startParts[0]), parseInt(startParts[1]) - 1, parseInt(startParts[2]));

            const endParts = vesting.endDate.split('-');
            const endDate = new Date(parseInt(endParts[0]), parseInt(endParts[1]) - 1, parseInt(endParts[2]));

            // Format date as YYYY-MM-DD
            function formatDateISO(date) {
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            }

            // Helper to add months properly (preserves day of month)
            function addMonthsToDate(date, months) {
                const result = new Date(date);
                const targetMonth = result.getMonth() + months;
                result.setMonth(targetMonth);
                // Handle month overflow (e.g., Jan 31 + 1 month = Feb 28/29)
                if (result.getMonth() !== ((targetMonth % 12) + 12) % 12) {
                    result.setDate(0); // Go to last day of previous month
                }
                return result;
            }

            // If cliffStartDate is set, vesting start date is already after cliff - don't add cliff months
            // If only cliffMonths is set (no cliffStartDate), add cliff to startDate for backward compatibility
            const shouldApplyCliffOffset = cliffMonths > 0 && !hasCliffStartDate;

            // Custom unlocks - user controls dates manually
            if (frequency === 'custom' && vesting.customUnlocks && vesting.customUnlocks.length > 0) {
                vesting.customUnlocks.forEach(u => {
                    unlocks.push({
                        date: u.date,
                        amount: parseFloat(u.amount),
                        type: 'Custom'
                    });
                });
            } else if (frequency === 'linear') {
                // Linear (continuous) vesting - use startDate directly (it's already after cliff if cliffStartDate was set)
                unlocks.push({
                    date: formatDateISO(startDate),
                    amount: 0,
                    type: hasCliffStartDate ? 'Cliff End / Linear Start' : 'Linear Start',
                    isLinear: true,
                    linearTotal: totalTokens,
                    linearEndDate: vesting.endDate,
                    cliffMonths: cliffMonths
                });
                unlocks.push({
                    date: vesting.endDate,
                    amount: totalTokens,
                    type: 'Linear End',
                    isLinear: true
                });
            } else {
                // For monthly/quarterly, use month-based calculation
                if (frequency === 'monthly' || frequency === 'quarterly') {
                    const monthIncrement = frequency === 'quarterly' ? 3 : 1;

                    // Use startDate directly - it's already the vesting start (after cliff if cliffStartDate was set)
                    const effectiveStartDate = startDate;

                    // Calculate total periods from effective start to end (unlocks after cliff)
                    let tempDate = new Date(effectiveStartDate);
                    let periodsAfterCliff = 0;
                    while (tempDate <= endDate) {
                        periodsAfterCliff++;
                        tempDate = addMonthsToDate(effectiveStartDate, periodsAfterCliff * monthIncrement);
                    }

                    // If cliff is set, calculate cliff unlock + regular unlocks
                    if (hasCliffStartDate && (cliffMonths > 0 || cliffAmount > 0)) {
                        // Use user-provided cliff amount, or calculate based on cliff months
                        let cliffUnlockAmount;
                        let tokensPerPeriod;

                        if (cliffAmount > 0) {
                            // User specified cliff amount - remaining tokens divided by periods after cliff
                            cliffUnlockAmount = cliffAmount;
                            const remainingTokens = totalTokens - cliffAmount;
                            tokensPerPeriod = remainingTokens / Math.max(1, periodsAfterCliff - 1); // -1 because first unlock is cliff
                        } else {
                            // Auto-calculate based on cliff months
                            const cliffPeriods = Math.floor(cliffMonths / monthIncrement);
                            const totalPeriods = cliffPeriods + periodsAfterCliff;
                            tokensPerPeriod = totalTokens / Math.max(1, totalPeriods);
                            cliffUnlockAmount = tokensPerPeriod * cliffPeriods;
                        }

                        // Add cliff end unlock
                        unlocks.push({
                            date: formatDateISO(effectiveStartDate),
                            amount: cliffUnlockAmount,
                            type: 'Cliff End'
                        });

                        // Add remaining periodic unlocks
                        let currentDate = addMonthsToDate(effectiveStartDate, monthIncrement);
                        while (currentDate <= endDate) {
                            unlocks.push({
                                date: formatDateISO(currentDate),
                                amount: tokensPerPeriod,
                                type: frequency.charAt(0).toUpperCase() + frequency.slice(1)
                            });
                            currentDate = addMonthsToDate(currentDate, monthIncrement);
                        }
                    } else {
                        // No cliff - equal distribution
                        const tokensPerPeriod = totalTokens / Math.max(1, periodsAfterCliff);

                        let currentDate = new Date(effectiveStartDate);
                        let periodIndex = 0;

                        while (currentDate <= endDate) {
                            unlocks.push({
                                date: formatDateISO(currentDate),
                                amount: tokensPerPeriod,
                                type: frequency.charAt(0).toUpperCase() + frequency.slice(1)
                            });
                            periodIndex++;
                            currentDate = addMonthsToDate(effectiveStartDate, periodIndex * monthIncrement);
                        }
                    }

                    return unlocks.sort((a, b) => new Date(a.date) - new Date(b.date));
                }

                // For weekly/daily, use day-based calculation - startDate is already the vesting start
                const effectiveStartDate = startDate;
                const totalDays = Math.ceil((endDate - effectiveStartDate) / (1000 * 60 * 60 * 24));
                let numPeriods;
                let periodDays;

                switch (frequency) {
                    case 'weekly':
                        periodDays = 7;
                        numPeriods = Math.max(1, Math.ceil(totalDays / periodDays));
                        break;
                    case 'daily':
                        periodDays = 1;
                        numPeriods = Math.max(1, totalDays);
                        break;
                    default:
                        periodDays = 30;
                        numPeriods = Math.max(1, Math.ceil(totalDays / periodDays));
                        break;
                }

                const tokensPerPeriod = totalTokens / numPeriods;

                for (let i = 0; i < numPeriods; i++) {
                    const unlockDate = new Date(effectiveStartDate);
                    unlockDate.setDate(unlockDate.getDate() + (i * periodDays));

                    // Don't exceed end date
                    if (unlockDate > endDate) break;

                    const isFirstUnlock = i === 0;
                    unlocks.push({
                        date: formatDateISO(unlockDate),
                        amount: tokensPerPeriod,
                        type: isFirstUnlock && hasCliffStartDate ? 'Cliff End' : frequency.charAt(0).toUpperCase() + frequency.slice(1)
                    });
                }
            }

            return unlocks.sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        // Calculate linear vesting details for a vesting schedule
        function calculateLinearVesting(vesting) {
            if (vesting.frequency !== 'linear') return null;

            const totalTokens = parseFloat(vesting.totalTokens);
            const cliffMonths = parseInt(vesting.cliffMonths) || 0;
            const hasCliffStartDate = vesting.cliffStartDate && vesting.cliffStartDate.length > 0;

            // Parse start and end dates
            if (!vesting.startDate || !vesting.endDate) return null;

            const startParts = vesting.startDate.split('-');
            const startDate = new Date(parseInt(startParts[0]), parseInt(startParts[1]) - 1, parseInt(startParts[2]));

            const endParts = vesting.endDate.split('-');
            const endDate = new Date(parseInt(endParts[0]), parseInt(endParts[1]) - 1, parseInt(endParts[2]));

            // Parse cliff start date if provided
            let cliffStartDate = null;
            if (hasCliffStartDate) {
                const cliffParts = vesting.cliffStartDate.split('-');
                cliffStartDate = new Date(parseInt(cliffParts[0]), parseInt(cliffParts[1]) - 1, parseInt(cliffParts[2]));
            }

            // vestingStartDate is simply the startDate (user sets this as when vesting begins)
            const vestingStartDate = new Date(startDate);

            // cliffEndDate is for display only - calculated from cliffStartDate if provided
            let cliffEndDate = cliffStartDate ? new Date(cliffStartDate) : new Date(startDate);
            if (cliffMonths > 0 && cliffStartDate) {
                // Add cliff months to cliff start date
                const targetMonth = cliffEndDate.getMonth() + cliffMonths;
                cliffEndDate.setMonth(targetMonth);
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // All tokens vest linearly
            const linearTokens = totalTokens;

            // Calculate vested amount
            let vestedFromLinear = 0;
            let vestingStatus = 'not_started';
            let percentComplete = 0;
            let tokensPerDay = 0;

            // Check if we're in cliff period (only if cliffStartDate is set and we're before vesting start)
            const inCliffPeriod = hasCliffStartDate && cliffStartDate && today >= cliffStartDate && today < vestingStartDate;

            if (today < vestingStartDate) {
                // Before vesting starts
                vestingStatus = inCliffPeriod ? 'cliff' : 'not_started';
                vestedFromLinear = 0;
                percentComplete = 0;
            } else if (today >= endDate) {
                vestingStatus = 'completed';
                vestedFromLinear = linearTokens;
                percentComplete = 100;
            } else {
                vestingStatus = 'in_progress';
                const totalDays = Math.max(1, (endDate - vestingStartDate) / (1000 * 60 * 60 * 24));
                const elapsedDays = Math.max(0, (today - vestingStartDate) / (1000 * 60 * 60 * 24));
                percentComplete = Math.min(100, (elapsedDays / totalDays) * 100);
                vestedFromLinear = linearTokens * Math.min(1, elapsedDays / totalDays);
                tokensPerDay = linearTokens / totalDays;
            }

            const totalVested = vestedFromLinear;

            return {
                startDate,
                endDate,
                cliffEndDate,
                vestingStartDate,
                cliffMonths,
                linearTokens,
                vestedFromLinear,
                totalVested,
                vestingStatus,
                percentComplete,
                tokensPerDay,
                tokensPerHour: tokensPerDay / 24,
                claimableNow: totalVested
            };
        }

        // Vesting form submission
        document.getElementById('vesting-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const editId = document.getElementById('vesting-edit-id').value;

            // Collect custom unlocks if custom frequency
            let customUnlocksData = [];
            if (document.getElementById('vesting-frequency').value === 'custom') {
                const rows = document.querySelectorAll('#custom-unlocks-list .unlock-input-row');
                rows.forEach((row, i) => {
                    const dateInput = row.querySelector('input[type="date"]');
                    const amountInput = row.querySelector('input[type="number"]');
                    if (dateInput.value && amountInput.value) {
                        customUnlocksData.push({
                            date: dateInput.value,
                            amount: amountInput.value
                        });
                    }
                });
            }

            const vesting = {
                id: editId || Date.now().toString(),
                project: document.getElementById('vesting-project').value.trim(),
                token: document.getElementById('vesting-token').value.toUpperCase(),
                totalTokens: document.getElementById('vesting-total').value,
                tokensClaimed: document.getElementById('vesting-claimed').value || 0,
                cliffStartDate: document.getElementById('vesting-cliff-start').value || '',
                cliffMonths: parseInt(document.getElementById('vesting-cliff').value) || 0,
                cliffAmount: parseFloat(document.getElementById('vesting-cliff-amount').value) || 0,
                startDate: document.getElementById('vesting-start-date').value,
                endDate: document.getElementById('vesting-end-date').value,
                frequency: document.getElementById('vesting-frequency').value,
                customUnlocks: customUnlocksData,
                website: document.getElementById('vesting-website').value.trim() || '',
                coingeckoId: document.getElementById('vesting-coingecko-id').value.trim().toLowerCase() || '',
                createdAt: editId ? vestings.find(v => v.id === editId)?.createdAt : new Date().toISOString()
            };

            // Save to Supabase
            const saved = await saveVestingToSupabase(vesting);
            if (saved) {
                if (editId) {
                    const index = vestings.findIndex(v => v.id === editId);
                    if (index !== -1) vestings[index] = vesting;
                } else {
                    vestings.unshift(vesting);
                }
                showToast('Vesting saved successfully');
            }

            renderVestings();
            updateVestingStats();
            checkUpcomingUnlocks();
            renderVestingCalendar();
            cancelVestingEdit();
            this.reset();
            document.getElementById('custom-unlocks-list').innerHTML = '';
        });

        // Preview vesting schedule
        window.previewVestingSchedule = function() {
            const startDate = document.getElementById('vesting-start-date').value;
            const endDate = document.getElementById('vesting-end-date').value;
            const totalTokens = document.getElementById('vesting-total').value;

            if (!startDate || !endDate || !totalTokens) {
                alert('Please enter Start Date, End Date and Total Tokens to preview the schedule.');
                return;
            }

            // Collect custom unlocks if custom frequency
            let customUnlocksData = [];
            if (document.getElementById('vesting-frequency').value === 'custom') {
                const rows = document.querySelectorAll('#custom-unlocks-list .unlock-input-row');
                rows.forEach((row, i) => {
                    const dateInput = row.querySelector('input[type="date"]');
                    const amountInput = row.querySelector('input[type="number"]');
                    if (dateInput.value && amountInput.value) {
                        customUnlocksData.push({
                            date: dateInput.value,
                            amount: amountInput.value
                        });
                    }
                });
            }

            const previewVesting = {
                totalTokens: totalTokens,
                tokensClaimed: document.getElementById('vesting-claimed').value || 0,
                cliffStartDate: document.getElementById('vesting-cliff-start').value || '',
                cliffMonths: parseInt(document.getElementById('vesting-cliff').value) || 0,
                cliffAmount: parseFloat(document.getElementById('vesting-cliff-amount').value) || 0,
                startDate: startDate,
                endDate: endDate,
                frequency: document.getElementById('vesting-frequency').value,
                customUnlocks: customUnlocksData
            };

            const unlocks = calculateUnlockSchedule(previewVesting);
            const previewSection = document.getElementById('vesting-preview-section');
            const previewContent = document.getElementById('vesting-preview-content');

            if (unlocks.length === 0) {
                previewContent.innerHTML = '<p style="color: var(--text-secondary);">No unlocks to show. Please fill in the vesting details.</p>';
            } else {
                let totalAmount = 0;
                let html = '<table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">';
                html += '<thead><tr style="border-bottom: 2px solid var(--border-color);">';
                html += '<th style="text-align: left; padding: 8px;">Date</th>';
                html += '<th style="text-align: left; padding: 8px;">Type</th>';
                html += '<th style="text-align: right; padding: 8px;">Tokens</th>';
                html += '<th style="text-align: right; padding: 8px;">% of Total</th>';
                html += '</tr></thead><tbody>';

                unlocks.forEach(u => {
                    totalAmount += u.amount;
                    const percent = (u.amount / parseFloat(totalTokens) * 100).toFixed(2);
                    html += `<tr style="border-bottom: 1px solid var(--border-color);">`;
                    html += `<td style="padding: 8px;">${formatDateDisplay(u.date)}</td>`;
                    html += `<td style="padding: 8px;"><span style="background: ${u.type === 'TGE' ? 'var(--accent)' : u.type === 'Cliff End' || u.type.includes('Cliff') ? '#9b59b6' : '#3498db'}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">${u.type}</span></td>`;
                    html += `<td style="padding: 8px; text-align: right;">${u.amount.toLocaleString(undefined, {maximumFractionDigits: 2})}</td>`;
                    html += `<td style="padding: 8px; text-align: right;">${percent}%</td>`;
                    html += `</tr>`;
                });

                html += '</tbody></table>';

                const totalPercent = (totalAmount / parseFloat(totalTokens) * 100).toFixed(2);
                html += `<div style="margin-top: 15px; padding-top: 10px; border-top: 2px solid var(--border-color); display: flex; justify-content: space-between;">`;
                html += `<span><strong>Total Unlocks:</strong> ${unlocks.length}</span>`;
                html += `<span><strong>Total Tokens:</strong> ${totalAmount.toLocaleString(undefined, {maximumFractionDigits: 2})} (${totalPercent}%)</span>`;
                html += `</div>`;

                if (Math.abs(parseFloat(totalPercent) - 100) > 0.1) {
                    html += `<div style="margin-top: 10px; padding: 10px; background: rgba(231, 76, 60, 0.2); border-radius: 4px; color: #e74c3c;">`;
                    html += `Warning: Total unlocks add up to ${totalPercent}%, not 100%. Please check your percentages.`;
                    html += `</div>`;
                }

                previewContent.innerHTML = html;
            }

            previewSection.style.display = 'block';
        };

        // Toggle vesting card details
        window.toggleVestingDetails = function(id) {
            const details = document.getElementById('vesting-details-' + id);
            if (details) {
                details.classList.toggle('expanded');
            }
        };

        // Toggle vesting form visibility
        var vestingFormVisible = true;
        window.toggleVestingForm = function() {
            const container = document.getElementById('vesting-form-container');
            const toggleBtn = document.getElementById('vesting-form-toggle');
            const toggleIcon = document.getElementById('vesting-form-toggle-icon');

            vestingFormVisible = !vestingFormVisible;

            if (vestingFormVisible) {
                container.style.display = 'block';
                toggleBtn.innerHTML = '<span id="vesting-form-toggle-icon">&#9650;</span> Hide';
            } else {
                container.style.display = 'none';
                toggleBtn.innerHTML = '<span id="vesting-form-toggle-icon">&#9660;</span> Show';
            }
        };

        // Cancel vesting edit
        window.cancelVestingEdit = function() {
            document.getElementById('vesting-edit-id').value = '';
            document.getElementById('vesting-form').reset();
            document.getElementById('vesting-cliff-start').value = '';
            document.getElementById('vesting-cliff').value = 0;
            document.getElementById('vesting-cliff-amount').value = '';
            document.getElementById('vesting-form-title').textContent = 'Add Vesting Schedule';
            document.getElementById('vesting-submit-btn').textContent = 'Add Vesting';
            document.getElementById('vesting-cancel-btn').style.display = 'none';
            document.getElementById('custom-unlocks-section').style.display = 'none';
            document.getElementById('custom-unlocks-list').innerHTML = '';
            document.getElementById('vesting-preview-section').style.display = 'none';
        };

        // Edit vesting
        window.editVesting = function(id) {
            const vesting = vestings.find(v => v.id === id);
            if (!vesting) return;

            document.getElementById('vesting-edit-id').value = vesting.id;
            document.getElementById('vesting-project').value = vesting.project;
            document.getElementById('vesting-token').value = vesting.token;
            document.getElementById('vesting-total').value = vesting.totalTokens;
            document.getElementById('vesting-claimed').value = vesting.tokensClaimed || 0;
            document.getElementById('vesting-cliff-start').value = vesting.cliffStartDate || '';
            document.getElementById('vesting-cliff').value = vesting.cliffMonths || 0;
            document.getElementById('vesting-cliff-amount').value = vesting.cliffAmount || '';
            document.getElementById('vesting-start-date').value = vesting.startDate;
            document.getElementById('vesting-end-date').value = vesting.endDate;
            document.getElementById('vesting-frequency').value = vesting.frequency;
            document.getElementById('vesting-website').value = vesting.website || '';
            document.getElementById('vesting-coingecko-id').value = vesting.coingeckoId || '';

            if (vesting.frequency === 'custom') {
                document.getElementById('custom-unlocks-section').style.display = 'block';
                const list = document.getElementById('custom-unlocks-list');
                list.innerHTML = '';
                vesting.customUnlocks.forEach((u, i) => {
                    const row = document.createElement('div');
                    row.className = 'unlock-input-row';
                    row.innerHTML = `
                        <input type="date" name="custom-date-${i}" value="${u.date}" required>
                        <input type="number" name="custom-amount-${i}" step="any" value="${u.amount}" required>
                        <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()" style="padding: 8px 12px;"></button>
                    `;
                    list.appendChild(row);
                });
            }

            document.getElementById('vesting-form-title').textContent = 'Edit Vesting Schedule';
            document.getElementById('vesting-submit-btn').textContent = 'Update Vesting';
            document.getElementById('vesting-cancel-btn').style.display = 'inline-block';

            // Expand the form if collapsed
            if (!vestingFormVisible) {
                toggleVestingForm();
            }
            switchMainTab('vesting');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // Delete vesting
        window.deleteVesting = async function(id) {
            if (confirm('Are you sure you want to delete this vesting schedule?')) {
                const deleted = await deleteVestingFromSupabase(id);
                if (deleted) {
                    vestings = vestings.filter(v => v.id !== id);
                    showToast('Vesting deleted');
                }
                renderVestings();
                updateVestingStats();
                renderVestingCalendar();
            }
        };

        // Render vestings
        function renderVestings() {
            const list = document.getElementById('vesting-list');

            if (vestings.length === 0) {
                list.innerHTML = '<div class="no-data">No vesting schedules yet. Add your first one above!</div>';
                return;
            }

            const today = new Date();

            list.innerHTML = vestings.map(v => {
                const unlocks = calculateUnlockSchedule(v);
                const totalTokens = parseFloat(v.totalTokens);
                const isLinear = v.frequency === 'linear';
                const linearInfo = isLinear ? calculateLinearVesting(v) : null;

                // Calculate unlocked tokens (use linear calculation if linear vesting)
                let unlockedTokens;
                if (isLinear && linearInfo) {
                    unlockedTokens = linearInfo.totalVested;
                } else {
                    unlockedTokens = unlocks
                        .filter(u => new Date(u.date) <= today)
                        .reduce((sum, u) => sum + u.amount, 0);
                }

                // Calculate claimed tokens (includes both tracked unlocks and initial tokensClaimed)
                const claimedUnlocks = v.claimedUnlocks || [];
                const tokensClaimedInitial = parseFloat(v.tokensClaimed) || 0;
                const claimedFromUnlocks = isLinear ? 0 : unlocks
                    .filter(u => claimedUnlocks.includes(u.date))
                    .reduce((sum, u) => sum + u.amount, 0);
                const claimedTokens = isLinear ? tokensClaimedInitial : (tokensClaimedInitial + claimedFromUnlocks);
                const unclaimedTokens = Math.max(0, unlockedTokens - claimedTokens);
                const hasUnclaimedUnlocks = !isLinear && unclaimedTokens > 0;

                const progressPercent = (unlockedTokens / totalTokens * 100).toFixed(1);
                const nextUnlock = unlocks.find(u => new Date(u.date) > today && !u.isLinear);

                // Get token price and image
                const price = getTokenPrice(v.coingeckoId, 'usd');
                const tokenImage = getTokenImage(v.coingeckoId);
                const totalValue = price ? totalTokens * price : null;
                const unlockedValue = price ? unlockedTokens * price : null;
                const lockedValue = price ? (totalTokens - unlockedTokens) * price : null;
                const claimedValue = price ? claimedTokens * price : null;
                const unclaimedValue = price ? unclaimedTokens * price : null;

                // Linear vesting specific display
                let linearDisplay = '';
                if (isLinear && linearInfo) {
                    const statusColors = {
                        'not_started': 'var(--text-secondary)',
                        'cliff': '#9b59b6',
                        'in_progress': 'var(--accent)',
                        'completed': 'var(--accent-green)'
                    };
                    const statusText = {
                        'not_started': 'Not Started',
                        'cliff': 'In Cliff Period',
                        'in_progress': 'Vesting Active',
                        'completed': 'Fully Vested'
                    };
                    const cliffEndDateStr = linearInfo.cliffEndDate ? formatDate(linearInfo.cliffEndDate.toISOString().split('T')[0]) : '';
                    const cliffInfo = linearInfo.cliffMonths > 0 && cliffEndDateStr ? `
                        <div style="font-size: 0.75rem; color: #9b59b6; margin-top: 5px;">
                            Cliff: ${linearInfo.cliffMonths} month${linearInfo.cliffMonths > 1 ? 's' : ''}
                            (ends ${cliffEndDateStr})
                        </div>
                    ` : '';
                    linearDisplay = `
                        <div style="background: rgba(0, 217, 255, 0.1); border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span style="font-weight: 600; color: ${statusColors[linearInfo.vestingStatus]};">
                                    &#9201; ${statusText[linearInfo.vestingStatus]}
                                </span>
                                <span style="font-size: 0.8rem; color: var(--text-secondary);">
                                    ${formatDate(linearInfo.startDate.toISOString().split('T')[0])}  ${formatDate(linearInfo.endDate.toISOString().split('T')[0])}
                                </span>
                            </div>
                            ${cliffInfo}
                            ${linearInfo.vestingStatus === 'in_progress' ? `
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.85rem; margin-top: 10px;">
                                    <div style="background: rgba(46, 213, 115, 0.15); padding: 8px; border-radius: 6px; text-align: center;">
                                        <div style="color: var(--accent-green); font-weight: 600;">${formatNumber(linearInfo.claimableNow)} ${v.token}</div>
                                        <div style="color: var(--text-secondary); font-size: 0.75rem;">Claimable Now</div>
                                        ${price ? `<div style="color: var(--accent-green); font-size: 0.75rem;">${formatCurrencyValue(linearInfo.claimableNow * price, 'USD', false)}</div>` : ''}
                                    </div>
                                    <div style="background: rgba(255, 255, 255, 0.05); padding: 8px; border-radius: 6px; text-align: center;">
                                        <div style="color: var(--accent); font-weight: 600;">${formatNumber(linearInfo.tokensPerDay)} ${v.token}</div>
                                        <div style="color: var(--text-secondary); font-size: 0.75rem;">Vesting per Day</div>
                                        ${price ? `<div style="color: var(--accent); font-size: 0.75rem;">${formatCurrencyValue(linearInfo.tokensPerDay * price, 'USD', false)}/day</div>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            ${linearInfo.vestingStatus === 'cliff' ? `
                                <div style="display: grid; grid-template-columns: 1fr; gap: 10px; font-size: 0.85rem; margin-top: 10px;">
                                    <div style="background: rgba(155, 89, 182, 0.15); padding: 8px; border-radius: 6px; text-align: center;">
                                        <div style="color: #9b59b6; font-weight: 600;">0 ${v.token}</div>
                                        <div style="color: var(--text-secondary); font-size: 0.75rem;">Tokens during cliff</div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }

                return `
                    <div class="vesting-card" id="vesting-card-${v.id}">
                        <!-- Compact Header -->
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            ${tokenImage ? `<img src="${tokenImage}" alt="${v.token}" style="width: 36px; height: 36px; border-radius: 50%;">` : `<div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent-green)); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem;">${v.token.substring(0, 2)}</div>`}
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                                    <h3 style="margin: 0; font-size: 0.95rem; white-space: nowrap;">${escapeHtml(v.project)}</h3>
                                    <span style="color: var(--text-secondary); font-size: 0.8rem;">${v.token}</span>
                                    ${isLinear ? '<span style="background: var(--accent); color: #000; padding: 1px 5px; border-radius: 3px; font-size: 0.65rem;">LINEAR</span>' : ''}
                                    ${v.cliffMonths > 0 || v.cliffStartDate ? `<span style="background: #9b59b6; color: #fff; padding: 1px 5px; border-radius: 3px; font-size: 0.65rem;">CLIFF${v.cliffMonths > 0 ? ` ${v.cliffMonths}M` : ''}${v.cliffStartDate ? ` (${formatDate(v.cliffStartDate)})` : ''}</span>` : ''}
                                </div>
                                ${price ? `<div style="color: var(--accent-green); font-size: 0.8rem; font-weight: 600;">${formatCurrencyValue(totalValue, 'USD', false)}</div>` : ''}
                            </div>
                        </div>

                        <!-- Progress Bar -->
                        <div style="margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 4px;">
                                <span style="color: var(--accent);">${progressPercent}%</span>
                                <span style="color: var(--text-secondary);">${formatNumber(unlockedTokens)} / ${formatNumber(totalTokens)}</span>
                            </div>
                            <div class="vesting-progress-bar">
                                <div class="vesting-progress-fill" style="width: ${progressPercent}%"></div>
                            </div>
                        </div>

                        <!-- Key Stats -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; font-size: 0.75rem;">
                            <div style="background: rgba(46, 213, 115, 0.1); padding: 8px; border-radius: 6px; text-align: center;">
                                <div style="color: var(--accent-green); font-weight: 600;">${price ? formatCurrencyValue(claimedValue, 'USD', false) : formatNumber(claimedTokens)}</div>
                                <div style="color: var(--text-secondary);">Claimed</div>
                            </div>
                            <div style="background: rgba(0, 217, 255, 0.1); padding: 8px; border-radius: 6px; text-align: center;">
                                <div style="color: var(--accent); font-weight: 600;">${price ? formatCurrencyValue(unclaimedValue, 'USD', false) : formatNumber(unclaimedTokens)}</div>
                                <div style="color: var(--text-secondary);">Unclaimed</div>
                            </div>
                            <div style="background: rgba(255, 159, 67, 0.1); padding: 8px; border-radius: 6px; text-align: center;">
                                <div style="color: var(--accent-orange); font-weight: 600;">${price ? formatCurrencyValue(lockedValue, 'USD', false) : formatNumber(totalTokens - unlockedTokens)}</div>
                                <div style="color: var(--text-secondary);">Locked</div>
                            </div>
                        </div>

                        ${isLinear && linearInfo && linearInfo.vestingStatus === 'in_progress' ? `
                            <div style="background: rgba(0, 217, 255, 0.1); padding: 8px; border-radius: 6px; margin-bottom: 10px; text-align: center; font-size: 0.75rem;">
                                <span style="color: var(--accent);">&#9201; ${formatNumber(linearInfo.tokensPerDay)} ${v.token}/day</span>
                                ${price ? `<span style="color: var(--text-secondary);"> (${formatCurrencyValue(linearInfo.tokensPerDay * price, 'USD', false)}/day)</span>` : ''}
                            </div>
                        ` : ''}

                        ${!isLinear && nextUnlock ? `
                            <div style="background: rgba(0, 217, 255, 0.05); padding: 8px; border-radius: 6px; margin-bottom: 10px; font-size: 0.75rem; text-align: center;">
                                <span style="color: var(--text-secondary);">Next:</span>
                                <span style="color: var(--accent);">${formatDate(nextUnlock.date)}</span>
                                <span style="color: var(--accent-green);">(${formatNumber(nextUnlock.amount)} ${v.token})</span>
                            </div>
                        ` : (!isLinear ? '<div style="background: rgba(46, 213, 115, 0.1); padding: 8px; border-radius: 6px; margin-bottom: 10px; text-align: center; font-size: 0.75rem; color: var(--accent-green);">Fully vested!</div>' : '')}

                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                            ${v.website ? `<a href="${escapeHtml(v.website)}" target="_blank" rel="noopener" class="btn btn-primary" style="flex: 1; text-align: center; padding: 6px 8px; font-size: 0.75rem; text-decoration: none;">Go to Claim Page</a>` : ''}
                            ${isLinear && unclaimedTokens > 0 ? `<button class="btn" style="background: var(--accent-green); color: #000; padding: 6px 8px; font-size: 0.75rem;" onclick="claimLinearTokens('${v.id}')">Claimed</button>` : ''}
                            ${!isLinear && hasUnclaimedUnlocks ? `<button class="btn" style="background: var(--accent-green); color: #000; padding: 6px 8px; font-size: 0.75rem;" onclick="claimAllUnlocks('${v.id}')">Claimed</button>` : ''}
                            <button class="btn" style="background: var(--secondary); color: var(--text-primary); padding: 6px 8px; font-size: 0.75rem;" onclick="toggleVestingDetails('${v.id}')">Details</button>
                            <button class="btn btn-edit" style="padding: 6px 8px; font-size: 0.75rem;" onclick="editVesting('${v.id}')">Edit</button>
                            <button class="btn btn-danger" style="padding: 6px 8px; font-size: 0.75rem;" onclick="deleteVesting('${v.id}')">&#128465;</button>
                        </div>

                        <!-- Expandable Details -->
                        <div class="vesting-card-details" id="vesting-details-${v.id}">
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 8px;">
                                ${v.startDate ? `${formatDate(v.startDate)}  ${formatDate(v.endDate)}` : ''} ${price ? `| Price: $${price.toFixed(price < 1 ? 4 : 2)}` : ''}
                            </div>
                            <div style="font-size: 0.8rem; font-weight: 600; margin-bottom: 6px;">${isLinear ? 'Vesting Period' : 'Unlock Schedule'}</div>
                            <div class="unlock-list" style="max-height: 150px; overflow-y: auto;">
                                ${isLinear ? `
                                    <div class="unlock-item" style="font-size: 0.75rem;">
                                        <span class="unlock-date">Start: ${formatDate(linearInfo.startDate.toISOString().split('T')[0])}</span>
                                        <span class="unlock-status ${linearInfo.vestingStatus !== 'not_started' ? 'claimed' : 'pending'}">${linearInfo.vestingStatus !== 'not_started' ? 'Started' : 'Pending'}</span>
                                    </div>
                                    <div class="unlock-item" style="font-size: 0.75rem;">
                                        <span class="unlock-date">End: ${formatDate(linearInfo.endDate.toISOString().split('T')[0])}</span>
                                        <span class="unlock-status ${linearInfo.vestingStatus === 'completed' ? 'claimed' : 'pending'}">${linearInfo.vestingStatus === 'completed' ? 'Complete' : 'Pending'}</span>
                                    </div>
                                ` : unlocks.slice(0, 10).map(u => {
                                    const isUnlocked = new Date(u.date) <= today;
                                    const isClaimed = v.claimedUnlocks && v.claimedUnlocks.includes(u.date);
                                    const isNext = nextUnlock && u.date === nextUnlock.date;
                                    return `
                                        <div class="unlock-item ${isUnlocked ? 'unlocked' : ''} ${isNext ? 'next' : ''} ${isClaimed ? 'is-claimed' : ''}" style="font-size: 0.75rem; display: flex; align-items: center; gap: 6px;">
                                            <span class="unlock-date" style="flex: 1;">${formatDate(u.date)}</span>
                                            <span class="unlock-amount">${formatNumber(u.amount)}</span>
                                            ${isUnlocked ? (isClaimed
                                                ? `<span class="unlock-status claimed" style="cursor: pointer;" onclick="unclaimUnlock('${v.id}', '${u.date}')" title="Click to unclaim">&#10003; Claimed</span>`
                                                : `<button class="btn" style="padding: 2px 6px; font-size: 0.65rem; background: var(--accent-green); color: #000;" onclick="claimUnlock('${v.id}', '${u.date}')">Claim</button>`
                                            ) : `<span class="unlock-status pending">&#9679;</span>`}
                                        </div>
                                    `;
                                }).join('') + (unlocks.length > 10 ? `<div style="text-align: center; font-size: 0.7rem; color: var(--text-secondary); padding: 5px;">+${unlocks.length - 10} more unlocks</div>` : '')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update vesting stats
        function updateVestingStats() {
            const today = new Date();
            let totalTokens = 0;
            let unlockedTokens = 0;
            let totalPortfolioValue = 0;
            let unlockedPortfolioValue = 0;

            vestings.forEach(v => {
                const vTotalTokens = parseFloat(v.totalTokens);
                let vUnlockedTokens;

                // Use linear calculation for linear vesting
                if (v.frequency === 'linear') {
                    const linearInfo = calculateLinearVesting(v);
                    vUnlockedTokens = linearInfo ? linearInfo.totalVested : 0;
                } else {
                    const unlocks = calculateUnlockSchedule(v);
                    vUnlockedTokens = unlocks
                        .filter(u => new Date(u.date) <= today)
                        .reduce((sum, u) => sum + u.amount, 0);
                }

                totalTokens += vTotalTokens;
                unlockedTokens += vUnlockedTokens;

                // Calculate value if price is available
                const price = getTokenPrice(v.coingeckoId, 'usd');
                if (price) {
                    totalPortfolioValue += vTotalTokens * price;
                    unlockedPortfolioValue += vUnlockedTokens * price;
                }
            });

            document.getElementById('total-vesting-tokens').textContent = formatNumber(totalTokens);
            document.getElementById('unlocked-tokens').textContent = formatNumber(unlockedTokens);
            document.getElementById('locked-tokens').textContent = formatNumber(totalTokens - unlockedTokens);
            document.getElementById('active-vestings').textContent = vestings.length;
            document.getElementById('portfolio-value').textContent = formatCurrencyValue(totalPortfolioValue, 'USD', false);
            document.getElementById('unlocked-value').textContent = formatCurrencyValue(unlockedPortfolioValue, 'USD', false);

            // Update last updated time
            if (pricesLastUpdated) {
                document.getElementById('prices-updated').textContent = 'Updated: ' + pricesLastUpdated.toLocaleTimeString();
            }
        }

        // Check upcoming unlocks and show banner
        function checkUpcomingUnlocks() {
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(nextWeek.getDate() + 7);

            const upcoming = [];
            vestings.forEach(v => {
                const unlocks = calculateUnlockSchedule(v);
                unlocks.forEach(u => {
                    const unlockDate = new Date(u.date);
                    if (unlockDate > today && unlockDate <= nextWeek) {
                        upcoming.push({
                            project: v.project,
                            token: v.token,
                            date: u.date,
                            amount: u.amount
                        });
                    }
                });
            });

            const banner = document.getElementById('upcoming-unlocks-banner');
            const list = document.getElementById('upcoming-unlocks-list');

            if (upcoming.length > 0) {
                banner.style.display = 'block';
                list.innerHTML = upcoming.map(u => `
                    <div class="unlock-item upcoming">
                        <span><strong>${u.project}</strong> - ${formatDate(u.date)}</span>
                        <span class="unlock-amount">${formatNumber(u.amount)} ${u.token}</span>
                    </div>
                `).join('');

                // Add notification based on settings
                const alertDays = appSettings.unlockAlerts || 1;
                if (alertDays > 0) {
                    upcoming.forEach(u => {
                        const daysUntil = Math.ceil((new Date(u.date) - today) / (1000 * 60 * 60 * 24));
                        if (daysUntil <= alertDays && !localStorage.getItem('notified_' + u.project + '_' + u.date)) {
                            const timeText = daysUntil <= 1 ? 'tomorrow' : `in ${daysUntil} days`;
                            addNotification('Upcoming Unlock!', `${formatNumber(u.amount)} ${u.token} from ${u.project} unlocks ${timeText}!`, 'warning');
                            localStorage.setItem('notified_' + u.project + '_' + u.date, 'true');
                        }
                    });
                }
            } else {
                banner.style.display = 'none';
            }
        }

        // Format number helper
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
            return parseFloat(num).toFixed(2);
        }

        // Category filter for analytics
        var selectedCategoryFilter = 'all';

        function updateCategoryFilterChips() {
            const chipsContainer = document.getElementById('crypto-filter-chips');
            if (!chipsContainer) return;

            const categories = [...new Set(payouts.map(p => p.category).filter(c => c))];
            const cryptos = [...new Set(payouts.map(p => p.crypto))];

            let html = `<span class="filter-chip ${selectedCryptoFilter === 'all' ? 'active' : ''}" onclick="filterByCrypto('all')">All Cryptos</span>`;
            cryptos.forEach(c => {
                html += `<span class="filter-chip ${selectedCryptoFilter === c ? 'active' : ''}" onclick="filterByCrypto('${c}')">${c}</span>`;
            });

            if (categories.length > 0) {
                html += `<span style="color: var(--text-secondary); margin: 0 10px;">|</span>`;
                html += `<span class="filter-chip ${selectedCategoryFilter === 'all' ? 'active' : ''}" onclick="filterByCategory('all')">All Categories</span>`;
                categories.forEach(cat => {
                    html += `<span class="filter-chip ${selectedCategoryFilter === cat ? 'active' : ''}" onclick="filterByCategory('${cat}')">${cat}</span>`;
                });
            }

            chipsContainer.innerHTML = html;
        }

        window.filterByCategory = function(category) {
            selectedCategoryFilter = category;
            updateCategoryFilterChips();
            renderTable();
            updateCharts();
        };

        // ============================================
        // VESTING CALENDAR FUNCTIONALITY
        // ============================================

        var calendarDate = new Date();
        var allUnlocks = [];

        // Initialize calendar
        function initVestingCalendar() {
            renderVestingCalendar();
        }

        // Change calendar month
        window.changeCalendarMonth = function(delta) {
            calendarDate.setMonth(calendarDate.getMonth() + delta);
            renderVestingCalendar();
        };

        // Get all unlocks from all vestings
        function getAllUnlocks() {
            allUnlocks = [];
            vestings.forEach(v => {
                const unlocks = calculateUnlockSchedule(v);
                unlocks.forEach(u => {
                    allUnlocks.push({
                        date: u.date,
                        amount: u.amount,
                        token: v.token,
                        project: v.project,
                        type: u.type,
                        website: v.website || ''
                    });
                });
            });
            return allUnlocks;
        }

        // Render the calendar
        function renderVestingCalendar() {
            const grid = document.getElementById('vesting-calendar-grid');
            if (!grid) return;

            // Get all unlocks
            getAllUnlocks();

            // Create unlock map by date
            const unlockMap = {};
            allUnlocks.forEach(u => {
                if (!unlockMap[u.date]) {
                    unlockMap[u.date] = [];
                }
                unlockMap[u.date].push(u);
            });

            // Create event map by date
            const eventMap = {};
            cryptoEvents.forEach(e => {
                if (!eventMap[e.date]) {
                    eventMap[e.date] = [];
                }
                eventMap[e.date].push(e);
            });

            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();

            // Update header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendar-month-year').textContent = `${monthNames[month]} ${year}`;

            // Clear existing days (keep headers)
            const headers = grid.querySelectorAll('.calendar-day-header');
            grid.innerHTML = '';
            headers.forEach(h => grid.appendChild(h.cloneNode(true)));

            // Get first day of month and total days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            const today = new Date();
            const todayStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');

            // Add previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const dateStr = formatDateStr(year, month - 1, day);
                const dayEl = createCalendarDay(day, dateStr, unlockMap[dateStr], eventMap[dateStr], true, todayStr);
                grid.appendChild(dayEl);
            }

            // Add current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = formatDateStr(year, month, day);
                const dayEl = createCalendarDay(day, dateStr, unlockMap[dateStr], eventMap[dateStr], false, todayStr);
                grid.appendChild(dayEl);
            }

            // Add next month days to complete the grid
            const totalCells = grid.children.length - 7; // Subtract headers
            const remainingCells = 42 - totalCells; // 6 rows x 7 days
            for (let day = 1; day <= remainingCells; day++) {
                const dateStr = formatDateStr(year, month + 1, day);
                const dayEl = createCalendarDay(day, dateStr, unlockMap[dateStr], eventMap[dateStr], true, todayStr);
                grid.appendChild(dayEl);
            }

            // Render upcoming events list
            renderUpcomingEvents();
        }

        // Format date string (local timezone, not UTC)
        function formatDateStr(year, month, day) {
            const d = new Date(year, month, day);
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${dd}`;
        }

        // Create calendar day element
        function createCalendarDay(day, dateStr, unlocks, events, isOtherMonth, todayStr) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';

            // Add day number in a span
            const dayNumber = document.createElement('span');
            dayNumber.className = 'day-number';
            dayNumber.textContent = day;
            dayEl.appendChild(dayNumber);

            if (isOtherMonth) {
                dayEl.classList.add('other-month');
            }

            if (dateStr === todayStr) {
                dayEl.classList.add('today');
            }

            const hasUnlocks = unlocks && unlocks.length > 0;
            const hasEvents = events && events.length > 0;

            if (hasUnlocks) {
                dayEl.classList.add('has-unlock');

                const unlockDate = new Date(dateStr);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                if (unlockDate < today) {
                    dayEl.classList.add('past');
                } else if (unlockDate.getTime() === today.getTime()) {
                    dayEl.classList.add('upcoming');
                } else {
                    dayEl.classList.add('upcoming');
                }

                // Add unlock badge with project name or count
                const unlockBadge = document.createElement('span');
                unlockBadge.className = 'unlock-badge';
                if (unlocks.length === 1) {
                    unlockBadge.textContent = unlocks[0].project;
                    unlockBadge.title = `${unlocks[0].project}: ${formatNumber(unlocks[0].amount)} ${unlocks[0].token}`;
                } else {
                    unlockBadge.textContent = `${unlocks.length} unlocks`;
                    unlockBadge.title = unlocks.map(u => `${u.project}: ${formatNumber(u.amount)} ${u.token}`).join('\n');
                }
                dayEl.appendChild(unlockBadge);
            }

            if (hasEvents) {
                dayEl.classList.add('has-event');
                // Add event badge with event name or count
                const eventBadge = document.createElement('span');
                eventBadge.className = 'event-badge';
                if (events.length === 1) {
                    eventBadge.textContent = events[0].name;
                    eventBadge.title = `${events[0].type}: ${events[0].name}`;
                } else {
                    eventBadge.textContent = `${events.length} events`;
                    eventBadge.title = events.map(e => `${e.type}: ${e.name}`).join('\n');
                }
                dayEl.appendChild(eventBadge);
            }

            // Add click event to show tooltip if there are unlocks or events
            if (hasUnlocks || hasEvents) {
                dayEl.addEventListener('click', (e) => showCalendarTooltip(e, dateStr, unlocks || [], events || []));
                dayEl.addEventListener('mouseleave', hideCalendarTooltip);
            }

            return dayEl;
        }

        // Show calendar tooltip
        function showCalendarTooltip(e, dateStr, unlocks, events) {
            const tooltip = document.getElementById('calendar-tooltip');
            const date = new Date(dateStr + 'T00:00:00');
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };

            document.getElementById('tooltip-date').textContent = date.toLocaleDateString('en-US', options);

            let tooltipHtml = '';

            // Add unlocks
            if (unlocks && unlocks.length > 0) {
                tooltipHtml += '<div style="margin-bottom: 10px;"><strong style="color: var(--accent); font-size: 0.8rem;">UNLOCKS</strong></div>';
                tooltipHtml += unlocks.map(u => `
                    <div class="calendar-tooltip-item" style="flex-wrap: wrap;">
                        <div style="display: flex; justify-content: space-between; width: 100%;">
                            <span class="calendar-tooltip-project">${escapeHtml(u.project)}</span>
                            <span class="calendar-tooltip-amount">${formatNumber(u.amount)} ${u.token}</span>
                        </div>
                        ${u.website ? `<a href="${escapeHtml(u.website)}" target="_blank" rel="noopener" style="color: var(--accent); font-size: 0.8rem; margin-top: 5px;">&#128279; Claim Page</a>` : ''}
                    </div>
                `).join('');
            }

            // Add events
            if (events && events.length > 0) {
                if (unlocks && unlocks.length > 0) {
                    tooltipHtml += '<div style="border-top: 1px solid var(--border-color); margin: 10px 0;"></div>';
                }
                tooltipHtml += '<div style="margin-bottom: 10px;"><strong style="color: #ff9f43; font-size: 0.8rem;">EVENTS</strong></div>';
                tooltipHtml += events.map(ev => `
                    <div class="calendar-tooltip-item" style="flex-wrap: wrap; border-left: 3px solid #ff9f43; padding-left: 8px;">
                        <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                            <span class="calendar-tooltip-project">${escapeHtml(ev.name)}</span>
                            <span class="event-type-badge">${escapeHtml(ev.type)}</span>
                        </div>
                        <div style="margin-top: 5px; display: flex; gap: 8px;">
                            <button onclick="editCryptoEvent('${ev.id}')" style="font-size: 0.75rem; padding: 2px 8px; cursor: pointer; border: 1px solid var(--border-color); background: transparent; color: var(--text-secondary); border-radius: 4px;">Edit</button>
                            <button onclick="deleteCryptoEvent('${ev.id}')" style="font-size: 0.75rem; padding: 2px 8px; cursor: pointer; border: 1px solid var(--border-color); background: transparent; color: #ff4757; border-radius: 4px;">Delete</button>
                        </div>
                    </div>
                `).join('');
            }

            document.getElementById('tooltip-unlocks').innerHTML = tooltipHtml;

            // Position tooltip
            const rect = e.target.getBoundingClientRect();
            tooltip.style.left = Math.min(rect.right + 10, window.innerWidth - 280) + 'px';
            tooltip.style.top = Math.max(rect.top - 20, 10) + 'px';
            tooltip.classList.add('visible');
        }

        // Hide calendar tooltip
        function hideCalendarTooltip() {
            document.getElementById('calendar-tooltip').classList.remove('visible');
        }

        // Close tooltip when clicking outside
        document.addEventListener('click', (e) => {
            const tooltip = document.getElementById('calendar-tooltip');
            if (tooltip && !e.target.closest('.calendar-day') && !e.target.closest('.calendar-tooltip')) {
                tooltip.classList.remove('visible');
            }
        });

        // Render upcoming events list
        function renderUpcomingEvents() {
            const container = document.getElementById('upcoming-events-list');
            const card = document.getElementById('upcoming-events-card');
            if (!container) return;

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Filter and sort upcoming events
            const upcomingEvents = cryptoEvents
                .filter(e => new Date(e.date + 'T00:00:00') >= today)
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            if (upcomingEvents.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No upcoming events. Add one above!</p>';
                return;
            }

            container.innerHTML = upcomingEvents.map(ev => {
                const eventDate = new Date(ev.date + 'T00:00:00');
                const diffTime = eventDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const daysText = diffDays === 0 ? 'Today' : diffDays === 1 ? 'Tomorrow' : `In ${diffDays} days`;

                return `
                    <div class="event-item">
                        <div class="event-item-info">
                            <span class="event-item-name">${escapeHtml(ev.name)}</span>
                            <div class="event-item-meta">
                                <span>${formatDisplayDate(ev.date)}</span>
                                <span style="color: var(--accent);">${daysText}</span>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span class="event-type-badge">${escapeHtml(ev.type)}</span>
                            <div class="event-item-actions">
                                <button onclick="editCryptoEvent('${ev.id}')">Edit</button>
                                <button class="delete" onclick="deleteCryptoEvent('${ev.id}')">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Format date for display
        function formatDisplayDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Update calendar when vestings change
        function updateVestingCalendar() {
            renderVestingCalendar();
        }
    </script>
</body>
</html>
